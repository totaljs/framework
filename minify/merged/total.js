// Copyright 2012-2014 (c) Peter Širka <petersirka@gmail.com>
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function Framework(){this.id=null,this.version=1700,this.version_header="1.7.0",this.versionNode=parseInt(process.version.replace("v","").replace(/\./g,""),10),this.config={debug:!1,name:"total.js",version:"1.01",author:"",secret:os.hostname()+"-"+os.platform()+"-"+os.arch(),"etag-version":"","directory-controllers":"/controllers/","directory-views":"/views/","directory-definitions":"/definitions/","directory-temp":"/tmp/","directory-models":"/models/","directory-resources":"/resources/","directory-public":"/public/","directory-public-virtual":"/app/","directory-modules":"/modules/","directory-source":"/source/","directory-logs":"/logs/","directory-tests":"/tests/","directory-databases":"/databases/","directory-workers":"/workers/","directory-packages":"/packages/","static-url":"","static-url-js":"/js/","static-url-css":"/css/","static-url-image":"/img/","static-url-video":"/video/","static-url-font":"/fonts/","static-url-download":"/download/","static-accepts":[".jpg",".png",".gif",".ico",EXTENSION_JS,EXTENSION_COFFEE,".css",".txt",".xml",".woff",".otf",".ttf",".eot",".svg",".zip",".rar",".pdf",".docx",".xlsx",".doc",".xls",".html",".htm",".appcache",".map",".ogg",".mp4",".mp3",".webp",".webm",".swf",".package",".json",".md"],"default-layout":"_layout","default-request-length":5,"default-websocket-request-length":2,"default-websocket-encodedecode":!0,"default-request-timeout":3e3,"default-image-converter":"gm","default-image-quality":93,"allow-handle-static-files":!0,"allow-gzip":!0,"allow-websocket":!0,"allow-compile-js":!0,"allow-compile-css":!0,"allow-compile-html":!0,"allow-performance":!1,"allow-custom-titles":!1,"disable-strict-server-certificate-validation":!0,"default-interval-clear-resources":20,"default-interval-clear-cache":3,"default-interval-precompile-views":61,"default-interval-websocket-ping":1},this.global={},this.resources={},this.connections={},this.functions={},this.versions=null,this.isDebug=!0,this.isTest=!1,this.isLoaded=!1,this.routes={web:[],files:[],websockets:[],middleware:{},redirects:{},resize:{},request:[],views:{},merge:{},mapping:{},packages:{}},this.helpers={},this.modules={},this.models={},this.sources={},this.controllers={},this.tests=[],this.errors=[],this.problems=[],this.changes=[],this.server=null,this.port=0,this.ip="",this.workers={},this.databases={},this.directory=directory,this.isLE=os.endianness?"LE"===os.endianness():!0,this.isHTTPS=!1,this.temporary={path:{},processing:{},range:{},views:{},dependencies:{},other:{}},this.stats={request:{request:0,pending:0,web:0,xhr:0,file:0,websocket:0,get:0,post:0,put:0,upload:0,xss:0,blocked:0,"delete":0},response:{view:0,json:0,websocket:0,timeout:0,custom:0,binary:0,pipe:0,file:0,destroy:0,stream:0,streaming:0,plain:0,empty:0,redirect:0,forward:0,restriction:0,notModified:0,mmr:0,sse:0,error400:0,error401:0,error403:0,error404:0,error408:0,error431:0,error500:0,error501:0}},this.cache=new FrameworkCache(this),this.fs=new FrameworkFileSystem(this),this.path=new FrameworkPath(this),this.restrictions=new FrameworkRestrictions(this),this._request_check_redirect=!1,this._request_check_referer=!1,this._request_check_POST=!1,this._length_middleware=0,this._length_request_middleware=0,this._length_files=0,this.isVirtualDirectory=!1,this.isCoffee=!1,this.isWindows="win"===os.platform().substring(0,3).toLowerCase()}function FrameworkRestrictions(){this.isRestrictions=!1,this.isAllowedIP=!1,this.isBlockedIP=!1,this.isAllowedCustom=!1,this.isBlockedCustom=!1,this.allowedIP=[],this.blockedIP=[],this.allowedCustom={},this.blockedCustom={},this.allowedCustomKeys=[],this.blockedCustomKeys=[]}function FrameworkFileSystem(){this.create={css:this.createCSS.bind(this),database:this.createDatabase.bind(this),file:this.createFile.bind(this),js:this.createJS.bind(this),resource:this.createResource.bind(this),temporary:this.createTemporary.bind(this),view:this.createView.bind(this),worker:this.createWorker.bind(this)},this.rm={css:this.deleteCSS.bind(this),database:this.deleteDatabase.bind(this),file:this.deleteFile.bind(this),js:this.deleteJS.bind(this),resource:this.deleteResource.bind(this),temporary:this.deleteTemporary.bind(this),view:this.deleteView.bind(this),worker:this.deleteWorker.bind(this)}}function FrameworkPath(){}function FrameworkCache(){this.items={},this.count=1,this.interval=null}function Subscribe(e,t,r){this.controller=null,this.req=t,this.res=r,this.route=null,this.timeout=null,this.isCanceled=!1,this.isMixed=!1,this.isTransfer=!1,this.header="",this.error=null}function Controller(e,t,r,n){if(this.subscribe=n,this.name=e,this.req=t,this.res=r,this.exception=null,this.boundary=null,this.type=0,this.layoutName=framework.config["default-layout"],this.status=200,this.isLayout=!1,this.isCanceled=!1,this.isConnected=!0,this.isTimeout=!1,this.isController=!0,this.isTransfer=!1,this.repository={},this.output=null,this.outputPartial=null,this.$model=null,this._currentImage="",this._currentDownload="",this._currentVideo="",this._currentJS="",this._currentCSS="",this._currentView="#"!==e[0]&&"default"!==e&&""!==e?"/"+e+"/":"",!this.req){var o={};this.req={uri:o}}this.res||(this.res={}),this.res&&(this.res.controller=this)}function WebSocket(e,t,r,n){this._keys=[],this.id=n,this.online=0,this.connections={},this.repository={},this.name=r,this.isController=!0,this.url=utils.path(t),events.EventEmitter.call(this)}function WebSocketClient(e,t){this.handlers={ondata:this._ondata.bind(this),onerror:this._onerror.bind(this),onclose:this._onclose.bind(this)},this.container=null,this._id=null,this.id="",this.socket=t,this.req=e,this.isClosed=!1,this.isWebSocket=!0,this.errors=0,this.buffer=new Buffer(0),this.length=0,this.cookie=e.cookie.bind(e),this.type=2,this._isClosed=!1}function Backup(){this.file=[],this.directory=[],this.path="",this.fileName="",this.read={key:"",value:"",status:0},this.pending=0,this.complete=function(){},this.filter=function(){return!0}}!function(e){function t(e){this.name=e,this.collection={}}function r(e,t,r,n,o){this.parent=e,this.name=t,this.schema=r,this.properties=void 0===o?Object.keys(r):o,this.transforms,this.composes,this.rules,this.onDefault,this.onValidation=n,this.onSave,this.onGet,this.onRemove,this.onQuery}function n(e){this.items=[],this.transformName=y.error_default,this.onResource=e,this.resourceName=framework.config["default-errorbuilder-resource-name"]||"default",this.resourcePrefix=framework.config["default-errorbuilder-resource-prefix"]||"",this.count=0,this.replacer=[],this.isPrepared=!1,void 0===e&&this._resource()}function o(){this.builder={}}function i(e,t,r,n){this.isNext=!1,this.isPrev=!1,this.isFirst=!1,this.isLast=!1,this.items=e,this.count=0,this.skip=0,this.take=0,this.page=0,this.max=0,this.visible=!1,this.format=n||"?page={0}",this.refresh(e,t,r),this.transformName=y.pagination_default}function s(e,t){return void 0===e?t:e}var a=e.exports;global.framework_builders=e.exports;var u="undefined",l="function",c="object",p="string",f="number",d="boolean",m='The field "@" is required.',h="default",g="$state",v={},y={pagination:{},error:{}};return t.prototype.get=function(e){return this.collection[e]},t.prototype.add=function(e,t,n,o){var i=this;return typeof t===u&&(t={}),i.collection[e]=new r(i,e,t,o,n),i.collection[e]},t.prototype.create=function(){var e=this;return e.add.apply(e,arguments)},t.prototype.remove=function(e){var t=this;if(void 0===e)return delete v[e],void(t.collection=null);var r=t.collection[e];return r&&r.remove(),r=null,t},t.prototype.destroy=function(e){return this.remove(e)},r.prototype.define=function(e,t,r){var n=this;if(e instanceof Array){for(var o=0,i=e.length;i>o;o++)n.define(e[o],t,r);return n}return n.schema[e]=t,r?((void 0===n.properties||null===n.properties)&&(n.properties=[]),-1!==n.properties.indexOf(e)?n:(n.properties.push(e),n)):n},r.prototype.getDependencies=function(){for(var e=this,t=Object.keys(e.schema),r=[],n=0,o=t.length;o>n;n++){var i=t[n],s=e.schema[i];if(typeof s===p){var a="]"===s[0];a&&(s=s.substring(1,s.length-1));var u=e.parent.get(s);void 0!==typeof u&&r.push({name:i,isArray:a,schema:u})}}return r},r.prototype.setValidation=function(e,t){var r=this;return void 0===t&&e instanceof Array?(r.properties=e,r):(typeof e!==l?(r.properties=e,r.onValidation=t):r.onValidation=e,r)},r.prototype.setDefault=function(e){var t=this;return t.onDefault=e,t},r.prototype.setSave=function(e){var t=this;return t.onSave=e,t},r.prototype.setGet=function(e){var t=this;return t.onGet=e,t},r.prototype.setQuery=function(e){var t=this;return t.onQuery=e,t},r.prototype.setRemove=function(e){var t=this;return t.onRemove=e,t},r.prototype.setProperties=function(e){var t=this;return t.properties=e,t},r.prototype.addRule=function(e,t){var r=this;return void 0===t&&(fn=e,e="default"),r.rules||(r.rules={}),r.rules[e]=t,r},r.prototype.addTransform=function(e,t){var r=this;return typeof e===l&&(t=e,e="default"),r.transforms||(r.transforms={}),r.transforms[e]=t,r},r.prototype.addWorkflow=function(e,t){var r=this;return typeof e===l&&(t=e,e="default"),r.workflows||(r.workflows={}),r.workflows[e]=t,r},r.prototype.addCompose=function(e,t){var r=this;return typeof e===l&&(t=e,e="default"),r.composes||(r.composes={}),r.composes[e]=t,r},r.prototype.addComposer=function(e,t){return this.addCompose(e,t)},r.prototype.find=function(e){return this.parent.get(e)},r.prototype.rule=function(e){var t=this;return void 0===t.rules?void 0:(void 0===e&&(e="default"),t.rules[e])},r.prototype.destroy=function(){var e=this;delete e.parent.collection[e.name],e.properties=null,e.schema=null,e.onDefault=null,e.onValidation=null,e.onSave=null,e.onRead=null,e.onRemove=null,e.onQuery=null,e.workflows=null,e.transforms=null},r.prototype.saveMultiple=function(e,t,r){void 0===r&&(r=t,t=void 0);var o,i=[];o=e instanceof Array?e:[e];for(var s=this,a=new n,u=0,l=o.length;l>u;u++){var c=o[u],p="1"===s._getStateOfModel(c,0),f="1"===s._getStateOfModel(c,1),d=p===!0?framework_utils.copy(c):s.prepare(c);f!==!0&&void 0!==s.onValidation?(a.add(s.validate(d)),a.hasError()||i.push(d)):a.hasError()||i.push(d)}return a.hasError()?(r(a),s):(o=[],i.wait(function(e,r){s.onSave(a,i,t,function(e){o.push(e),r()})},function(){r(a.hasError()?a:null,o)}),s)},r.prototype.save=function(e,t,r){void 0===r&&(r=t,t=void 0);var o=this,i="1"===o._getStateOfModel(e,0),s="1"===o._getStateOfModel(e,1),a=i===!0?framework_utils.copy(e):o.prepare(e),u=s===!0||void 0===o.onValidation?new n:o.validate(a);return u.hasError()?(r(u),o):(o.onSave(u,a,t,function(e){r(u.hasError()?u:null,void 0===e?a:e)}),o)},r.prototype.get=function(e,t){void 0===t&&(t=e,e=void 0);var r=this,o=new n,i=r.default();return r.onGet(o,i,e,function(e){t(o.hasError()?o:null,void 0===e?i:e)}),r},r.prototype.remove=function(e,t){void 0===t&&(t=e,e=void 0);var r=this,o=new n;return r.onRemove(o,e,function(r){t(o.hasError()?o:null,void 0===r?e:r)}),r},r.prototype.query=function(e,t){void 0===t&&(t=e,e=void 0);var r=this,o=new n;return r.onQuery(o,e,function(e){t(o.hasError()?o:null,e)}),r},r.prototype.validate=function(e,t,r,o){var i=this,s=i.onValidation;if(void 0===o&&(o=new n),void 0===s||null===s){if(typeof framework.onValidation!==l)return framework&&framework.error&&framework.error(new Error('Schema "'+name+"\" doesn't defined a validation delegate."),i.parent.name+"."+i.name+".validate()",null),o;s=framework.onValidation}return r&&(o.resourceName=r),t&&(o.resourcePrefix=t),i._setStateToModel(e,1,1),framework_utils.validate.call(i,e,i.name,s,o,void 0,i.name,i.parent.collection)},r.prototype._getStateOfModel=function(e,t){return(e[g]||"")[t]||"0"},r.prototype._setStateToModel=function(e,t,r){var n=e[g];return typeof r!==c&&(r=r.toString()),n?n[1]!==r&&(e[g]=n.replaceAt(1,r)):e[g]="01",this},r.prototype.create=function(){return this.default()},r.prototype.default=function(){var e=this,t=e.schema;if(null===t)return null;for(var r=e.onDefault,n=framework_utils.extend({},t,!0),o=Object.keys(n),i=0,s=o.length;s>i;i++){var a=o[i],u=n[a],m=typeof u;if(r){var h=r(a,!0,e.name);if(void 0!==h){n[a]=h;continue}}if(m!==l)if(m!==f)if(m!==d)if(m!==c)if(m===p){var g="["===u[0];if(g&&(u=u.substring(1,u.length-1)),g)n[a]=[];else{var v=u.toLowerCase();if(v.contains([p,"text","varchar","nvarchar","binary","data","base64"]))n[a]="";else if(v.contains(["int",f,"decimal","byte","float","double"]))n[a]=0;else if(v.contains("bool"))n[a]=!1;else if(v.contains(["date","time"]))n[a]=new Date;else if(v.contains(["object"]))n[a]={};else if(v.contains(["array"]))n[a]=[];else if(v.contains(["binary","data","base64"]))n[a]=null;else{var y=e.parent.get(u);n[a]=y?y.default():null}}}else n[a]=null;else n[a]=u instanceof Array?[]:{};else n[a]=!1;else n[a]=0;else{if(u===Number){n[a]=0;continue}if(u===Boolean){n[a]=!1;continue}if(u===String){n[a]="";continue}if(u===Date){n[a]=new Date;continue}if(u===Object){n[a]={};continue}if(u===Array){n[a]=[];continue}n[a]=u()}}return n},r.prototype.prepare=function(e,t){var r=this,n=r.schema;if(null===n)return null;if(null===e||void 0===e)return r.default();for(var o,i=framework_utils.extend({},n,!0),a=Object.keys(i),m=r.onDefault,h=0,g=a.length;g>h;h++){var v=a[h],y=e[v];void 0===y&&m&&(y=m(v,!1,r.name)),void 0===y&&(y="");var b=i[v],w=typeof b,k=typeof y;if(k===l&&(y=y()),w!==l)if(w!==c)if(w!==f)if(o=null===y||k===u?"":y.toString(),w!==d)if(w===p){var E="["===b[0]||"array"===b;if(E){if(b="["===b[0]?b.substring(1,b.length-1):null,!(y instanceof Array)){i[v]=m?s(m(v,!1,r.name),[]):[];continue}i[v]=[];for(var S=0,T=y.length;T>S;S++)if(null!==b){var o=e[v][S];switch(b.toLowerCase()){case"string":case"varchar":case"text":i[v].push((o||"").toString());break;case"bool":case"boolean":o=(o||"").toString().toLowerCase(),i[v].push("true"===o||"1"===o);break;case"int":case"integer":i[v].push(framework_utils.parseInt(o));break;case"number":i[v].push(framework_utils.parseFloat(o));break;default:var _=r.parent.get(b);_?(i[v][S]=_.prepare(o,t),t&&t.push({name:b,value:i[v][S]})):i[v][S]=null}}else i[v].push(e[v][S])}else{var N=b.toLowerCase();if(N.contains([p,"text","varchar","nvarchar"])){var O=N.indexOf("(");if(-1===O){i[v]=o;continue}var C=N.substring(O+1,N.length-1).parseInt();i[v]=o.max(C,"...")}else if(N.contains(["int","byte"]))i[v]=framework_utils.parseInt(y);else if(N.contains(["decimal",f,"float","double"]))i[v]=framework_utils.parseFloat(y);else if(N.contains("bool",d))i[v]="true"===o||"1"===o;else if(N.contains(["date","time"])){if("date"===k){i[v]=y;continue}if(k===p){i[v]=y.parseDate();continue}if(k===f){i[v]=new Date(y);continue}i[v]=s(m(v,!1,r.name))}else{var _=r.parent.get(b);_?(i[v]=_.prepare(y),t&&t.push({name:b,value:i[v]})):i[v]=null}}}else i[v]=o;else i[v]="true"===o||"1"===o;else i[v]=framework_utils.parseFloat(y);else i[v]=k===c?y:null;else{if(b===Number){i[v]=framework_utils.parseFloat(y);continue}if(b===Boolean){o=y.toString(),i[v]="true"===o||"1"===o;continue}if(b===String){i[v]=void 0===y||null===y?"":y.toString();continue}if(b===Date){switch(o=null,k){case c:o=framework_utils.isDate(y)?y:null;break;case f:o=new Date(y);break;case p:o=""===y?null:y.parseDate()}null!==o&&typeof o===c&&"Invalid Date"===o.toString()&&(o=null),i[v]=o||(m?s(m(v,!1,r.name),null):null);continue}if(b===Object){i[v]=e[v];continue}i[v]=m?s(m(b,!1,r.name),null):null}}return r._setStateToModel(e,0,1),i},r.prototype.transform=function(e,t,r,o){var i=this;typeof e!==p&&(o=r,r=t,t=e,e="default"),void 0===o&&(o=r,r=void 0);var s=i.transforms?i.transforms[e]:void 0;if(!s)return void o((new n).add("","Transform not found."));var a="1"===i._getStateOfModel(t,0),u="1"===i._getStateOfModel(t,1),l=a===!0?framework_utils.copy(t):i.prepare(t),c=void 0===i.onValidation||u===!0?new n:i.validate(l);return c.hasError()?void o(c):(s.call(i,l,function(e){o(c.hasError()?c:null,void 0===e?l:e,t)},c,r,i.name),i)},r.prototype.compose=function(e,t,r,o){var i=this;typeof e!==p&&(o=r,r=t,t=e,e="default"),void 0===o&&(o=r,r=void 0);var s=new n,a=i.composes?i.composes[e]:void 0;if(!a)return void o(s.add("","Composer not found."));var u=i.default();return a.call(i,u,t,function(e){o(s.hasError()?s:null,void 0===e?u:e,t)},s,r,i.name),i},r.prototype.workflow=function(e,t,r,o){var i=this;typeof e!==p&&(o=r,r=t,t=e,e="default"),void 0===o&&(o=r,r=void 0);var s=i.workflows?i.workflows[e]:void 0;if(!s)return void o((new n).add("","Workflow not found."));var a="1"===i._getStateOfModel(t,0),u="1"===i._getStateOfModel(t,1),l=a===!0?framework_utils.copy(t):i.prepare(t),c=u===!0||void 0===i.onValidation?new n:i.validate(l);return c.hasError()?void o(c):(s.call(i,l,function(e){o(c.hasError()?c:null,void 0===e?l:e,t)},c,r,i.name),i)},r.prototype.clean=function(e,t){if(null===e||void 0===e)return e;t&&(e=framework_utils.copy(e)),delete e[g];for(var r=Object.keys(e),n=0,o=r.length;o>n;n++){var i=r[n],s=e[i];if(null!==s&&typeof s===c)if(s instanceof Array)for(var a=0,u=s.length;u>a;a++){var l=s[a];null!==l&&typeof l===c&&self.clean(l,!0)}else self.clean(s,!0)}return e},a.schema=function(e,r,n,o,i){if(void 0===r)return void 0===v[e]&&(v[e]=new t(e)),v[e];void 0===v[h]&&(v[h]=new t(h)),typeof n!==l&&(n=void 0),typeof o!==l&&(o=void 0),i instanceof Array||(i=void 0);var s=v[h].add(e,r,i,o);return n&&s.setDefault(n),r},a.remove=function(e){delete v[e]},a.isJoin=function(e,t){return t?"["===t[0]?!0:void 0===e?!1:void 0!==e[t]:!1},a.validation=function(e,t,r){if(void 0===v[h])return[];var n=v[h].get(e);if(void 0===n)return[];if(r instanceof Array&&typeof t===l){r=t,t=r}if(typeof r===l)return n.onValidation=r,n.properties=void 0===t?Object.keys(n.schema):t,!0;if(void 0===r){var o=n.properties;return void 0===o?Object.keys(n.schema):o||[]}return n.onValidation=r,r},a.validate=function(e,t,r,n){var o=v[h];if(void 0===o)return null;if(o=o.get(e),void 0===o)return null;o.onValidation;return o.validate(t,r,n)},a.create=function(e){return a.defaults(e)},a.defaults=function(e){if(void 0===v[h])return null;var t=v[h].get(e);return void 0===t?null:t.default()},a.prepare=function(e,t){if(void 0===v[h])return null;var r=v[h].get(e);return void 0===r?null:r.prepare(t)},n.prototype={get errors(){var e=this;return e.isPrepared||e.prepare(),e._transform()},get error(){var e=this;return e.isPrepared||e.prepare(),e._transform()}},n.prototype.resource=function(e,t){var r=this;return r.resourceName=e||"default",r.resourcePrefix=t||"",r._resource()},n.prototype._resource=function(){var e=this;return e.onResource=function(e){var t=this;return typeof framework!==u?framework.resource(t.resourceName,t.resourcePrefix+e):e},e},n.prototype.add=function(e,t,r){var o=this;return o.isPrepared=!1,e instanceof n?(e.hasError()&&(e.errors.forEach(function(e){o.errors.push(e)}),o.count=o.items.length),o):void 0!==e&&null!==e||void 0!==t&&null!==t?(void 0===t&&(t="@"),void 0===t||null===t?o:(t instanceof Error&&(t=t.toString()),o.items.push({name:e,error:typeof t===p?t:(t||"").toString()||"@",path:r}),o.count=o.items.length,o)):o},n.prototype.remove=function(e){var t=this;return t.items=t.items.remove(function(t){return t.name===e}),t.count=t.items.length,t},n.prototype.hasError=function(e){var t=this;return e?null!==t.items.find(function(t){return t.name===e}):t.items.length>0},n.prototype.read=function(e){var t=this;t.isPrepared||t.prepare();var r=t.items.find(function(t){return t.name===e});return null!==r?r.error:null},n.prototype.clear=function(){var e=this;return e.items=[],e.count=0,e},n.prototype.replace=function(e,t){var r=this;return r.isPrepared=!1,r.replacer[e]=t,r},n.prototype.json=function(e,t){var r=this.prepare()._transform();return e?JSON.stringify(r,t,"	"):JSON.stringify(r,t)},n.prototype.JSON=function(e,t){return this.json(e,t)},n.prototype.output=function(){return this.prepare()._transform()},n.prototype._prepare=function(){var e=this;if(null===e.onResource)return e;for(var t=e.items,r=t.length,n=0;r>n;n++){var o=t[n];"@"===o.error[0]&&(o.error=e.onResource(1===o.error.length?o.name:o.error.substring(1)),void 0===o.error&&(o.error=m.replace("@",o.name)))}return e},n.prototype._transform=function(e){var t=this,r=e||t.transformName;if(!r)return t.items;var n=y.error[r];return void 0===n?t.items:n.call(t)},n.prototype.toString=function(){var e=this;e.isPrepared||e.prepare();for(var t=e.items,r=t.length,n=[],o=0;r>o;o++)n.push(t[o].error||t[o].name);return n.join("\n")},n.prototype.setTransform=function(e){var t=this;return t.transformName=e,t},n.prototype.transform=function(e){var t=this;return t.prepare()._transform(e)},n.prototype._prepareReplace=function(){var e=this,t=e.items,r=t.length,n=Object.keys(e.replacer),o=n.length;if(0===r||0===o)return e;for(var i=0;r>i;i++)for(var s=t[i],a=0;o>a;a++){var u=n[a];s.error=s.error.replace(u,e.replacer[u])}return e},n.prototype.prepare=function(){var e=this;return e.isPrepared?e:(e._prepare()._prepareReplace(),e.isPrepared=!0,e)},n.addTransform=function(e,t,r){y.error[e]=t,r&&n.setDefaultTransform(e)},n.removeTransform=function(e){delete y.error[e]},n.setDefaultTransform=function(e){void 0===e?delete y.error_default:y.error_default=e},i.addTransform=function(e,t,r){y.pagination[e]=t,r&&i.setDefaultTransform(e)},i.setDefaultTransform=function(e){void 0===e?delete y.pagination_default:y.pagination_default=e},i.removeTransform=function(e){delete y.pagination[e]},i.prototype.refresh=function(e,t,r){var n=this;return n.count=Math.floor(e/r)+(e%r>0?1:0),n.page=t-1,n.page<0&&(n.page=0),n.items=e,n.skip=n.page*r,n.take=r,n.max=r,n.isPrev=n.page>0,n.isNext=n.page<n.count-1,n.isFirst=n.count>1,n.isLast=n.count>1,n.visible=n.count>1,n.page++,n},i.prototype.setTransform=function(e){var t=this;return t._transform=e,t},i.prototype.transform=function(e){var t=this,r=e||t.transformName;if(!r)throw new Error("A transformation of Pagination not found.");var n=y.pagination[r];if(void 0===n)return t.render();for(var o=[],i=1;i<arguments.length;i++)o.push(arguments[i]);return n.apply(t,o)},i.prototype.prev=function(e){var t=this,r=0;return e=e||t.format,r=t.isPrev?t.page-1:t.count,{url:e.format(r,t.items,t.count),page:r,selected:!1,enabled:t.isPrev}},i.prototype.next=function(e){var t=this,r=0;return e=e||t.format,r=t.isNext?t.page+1:1,{url:e.format(r,t.items,t.count),page:r,selected:!1,enabled:t.isNext}},i.prototype.last=function(e){var t=this,r=t.count;return e=e||t.format,{url:e.format(r,t.items,t.count),page:r,selected:!1,enabled:t.count>0}},i.prototype.first=function(e){var t=this,r=1;return e=e||t.format,{url:e.format(r,t.items,t.count),page:r,selected:!1,enabled:t.count>0}},i.prototype.prepare=function(e,t){var r=this;if(r.transformName)return y.pagination[r.transformName].apply(r,arguments);var n=[];if(t=t||r.format,typeof e===p){t=e,e=t}if(void 0===e||null===e){for(var o=1;o<r.count+1;o++)n.push({url:t.format(o,r.items,r.count),page:o,selected:o===r.page,enabled:!0});return n}var i=Math.floor(e/2),s=r.count,a=r.page-i,u=r.page+i,l=0;0>=a&&(l=Math.abs(a),a=1,u+=l),u>=s&&(u=s,a=s-e),0>a&&(a=1);for(var o=a;u+1>o;o++)n.push({url:t.format(o,r.items,r.count),page:o,selected:o===r.page,enabled:!0});return n},i.prototype.render=function(e,t){return this.prepare(e,t)},o.prototype.add=function(e,t){var r=this;if(typeof e!==c)return r.builder[e]=t,r;for(var n=Object.keys(e),o=0,i=n.length;i>o;o++)r.builder[n[o]]=e[n[o]];return r},o.prototype.remove=function(e){var t=this;return delete t.builder[e],t},o.prototype.read=function(e){return this.builder[e]||null},o.prototype.clear=function(){var e=this;return e.builder={},e},o.prototype.toString=function(e,t){if(typeof e===d){var r=t;t=e,e=r}var n=this,o=[];return Object.keys(n.builder).forEach(function(e){var r=n.builder[e];r=void 0===r||null===r?"":r.toString(),t&&""===r||o.push(e+"="+encodeURIComponent(r))}),typeof e===p?"?"!==e[e.length-1]&&(e+="?"):e="",e+o.join("&")},o.prototype.hasValue=function(e){if(void 0===e)return!1;var t=this;"string"==typeof e&&(e=[e]);for(var r=0;r<e.length;r++){var n=t.builder[e[r]];if(void 0===n||null===n)return!1}return!0},o.prototype.toOne=function(e,t){var r=this,n=[];return e.forEach(function(e){n.push(r.builder[e]||"")}),n.join(t||"&")},a.SchemaBuilder=t,a.ErrorBuilder=n,a.Pagination=i,a.UrlBuilder=o,e}({exports:{}}),function(module){function expression(query,params){var name=params.join(","),fn=expressionCache[query+"-"+name];fn||(fn=eval("(function("+name+"){"+(-1===query.indexOf("return")?"return ":"")+query+"})"),expressionCache[query+name]=fn);for(var values=[],i=2;i<arguments.length;i++)values.push(arguments[i]);return function(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);for(var t=0;t<values.length;t++)e.push(values[t]);return fn.apply(this,e)}}function getWebSocketFrameMessageBytes(e,t){for(var r=0===e?0:2,n=void 0!==t.readUInt8,o=t.length,i=new Buffer(o+r),s=0;o>s;s++)i[s+r]=n?t[s]:t.charCodeAt(s);return 0===e?i:(i[0]=e>>8,i[1]=e,i)}function getWebSocketFrameLengthBytes(e){var t=null;return 125>=e?(t=new Buffer(1),t[0]=e,t):65535>=e?(t=new Buffer(3),t[0]=126,t[1]=e>>8&255,t[2]=255&e,t):(t=new Buffer(9),t[0]=127,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e>>24&255,t[6]=e>>16&255,t[7]=e>>8&255,t[8]=255&e,t)}function AsyncTask(e,t,r,n,o){this.handlers={oncomplete:this.complete.bind(this)},this.isRunning=0,this.owner=e,this.name=t,this.fn=r,this.cb=n,this.waiting=o,this.interval=null,this.isCanceled=!1}function Async(e){this._max=0,this._count=0,this._isRunning=!1,this.owner=e,this.onComplete=[],this.tasksPending={},this.tasksWaiting={},this.tasksAll=[],this.tasksTimeout={},events.EventEmitter.call(this)}function FileList(){this.pending=[],this.pendingDirectory=[],this.directory=[],this.file=[],this.onComplete=null,this.onFilter=null}function converBytesToInt64(e,t,r){return r?e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24|e[t+4]<<32|e[t+5]<<40|e[t+6]<<48|e[t+7]<<56:e[t+7]<<32|e[t+6]<<40|e[t+5]<<48|e[t+4]<<56|e[t+3]|e[t+2]<<8|e[t+1]<<16|e[t]<<24}function queue_next(e){var t=queue[e];if(t.running--,t.running<0&&(t.running=0),0!==t.pending.length){var r=t.pending.shift();void 0!==r&&!function(e){setImmediate(function(){r(function(){queue_next(e)})})}(e)}}var exports=module.exports;global.framework_utils=module.exports;var parser=require("url"),qs=require("querystring"),http=require("http"),https=require("https"),util=require("util"),path=require("path"),fs=require("fs"),events=require("events"),crypto=require("crypto"),expressionCache={},sys=require("sys"),regexpMail=new RegExp("^[a-zA-Z0-9-_.+]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,4}$"),regexpUrl=new RegExp("^(http[s]?:\\/\\/(www\\.)?|ftp:\\/\\/(www\\.)?|www\\.){1}([0-9A-Za-z-\\.@:%_+~#=]+)+((\\.[a-zA-Z]{2,3})+)(/(.)*)?(\\?(.)*)?"),regexpTRIM=/^[\s]+|[\s]+$/g,ENCODING="utf8",UNDEFINED="undefined",STRING="string",FUNCTION="function",NUMBER="number",OBJECT="object",BOOLEAN="boolean",NEWLINE="\r\n",VERSION=typeof framework!==UNDEFINED?" v"+framework.version_header:"",contentTypes={aac:"audio/aac",ai:"application/postscript",appcache:"text/cache-manifest",avi:"video/avi",bin:"application/octet-stream",bmp:"image/bmp",coffee:"text/coffeescript",css:"text/css",csv:"text/csv",doc:"application/msword",docx:"application/msword",dtd:"application/xml-dtd",eps:"application/postscript",exe:"application/octet-stream",geojson:"application/json",gif:"image/gif",gzip:"application/x-gzip",htm:"text/html",html:"text/html",ico:"image/x-icon",ics:"text/calendar",ifb:"text/calendar",jpe:"image/jpeg",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",less:"text/css",m4a:"audio/mp4a-latm",m4v:"video/x-m4v",md:"text/markdown",mid:"audio/midi",midi:"audio/midi",mov:"video/quicktime",mp3:"audio/mpeg",mp4:"video/mp4",mpe:"video/mpeg",mpeg:"video/mpeg",mpg:"video/mpeg",mpga:"audio/mpeg",mtl:"text/plain",mv4:"video/mv4",obj:"text/plain",ogg:"application/ogg","package":"text/plain",pdf:"application/pdf",png:"image/png",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.ms-powerpoint",ps:"application/postscript",rar:"application/x-rar-compressed",rtf:"text/rtf",sass:"text/css",scss:"text/css",sh:"application/x-sh",stl:"application/sla",svg:"image/svg+xml",swf:"application/x-shockwave-flash",tar:"application/x-tar",tif:"image/tiff",tiff:"image/tiff",txt:"text/plain",wav:"audio/x-wav",webp:"image/webp",woff:"font/woff",xht:"application/xhtml+xml",xhtml:"application/xhtml+xml",xls:"application/vnd.ms-excel",xlsx:"application/vnd.ms-excel",xml:"application/xml",xpm:"image/x-xpixmap",xsl:"application/xml",xslt:"application/xslt+xml",zip:"application/zip"};typeof setImmediate===UNDEFINED&&(global.setImmediate=function(e){process.nextTick(e)});var hasOwnProperty=Object.prototype.hasOwnProperty;global.expression=expression,exports.isEmpty=function(e){if(null===e)return!0;if(e.length&&e.length>0)return!1;if(0===e.length)return!0;for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0},exports.isEqual=function(e,t,r){for(var n=r?r:Object.keys(e),o=0,i=n.length;i>o;o++){var s=n[o];if(e[s]!==t[s])return!1}return!0},exports.wait=function(e,t,r,n){if(e()===!0)return t(null);var o=null,i=setInterval(function(){return e()===!0?(clearInterval(i),clearTimeout(o),void(t&&t(null))):void 0},n||500);o=setTimeout(function(){clearInterval(i),t&&t(new Error("Timeout."))},r||5e3)},exports.request=function(e,t,r,n,o,i,s,a){typeof r===FUNCTION&&(a=s,s=i,i=o,o=n,n=r,r=""),typeof o===NUMBER&&(o=null,a=o),typeof i===NUMBER&&(i=null,a=i),typeof s===NUMBER&&(s=null,a=s);var u="GET",l=0,c=0,p=new events.EventEmitter;if(i=exports.extend({},i||{}),typeof s!==STRING&&(s=ENCODING),null===r&&(r=""),t instanceof Array){l=t.length;for(var f=0;l>f;f++)switch(t[f].toLowerCase()){case"xhr":i["X-Requested-With"]="XMLHttpRequest";break;case"json":i["Content-Type"]="application/json",""===u&&(u="POST"),c=1;break;case"xml":i["Content-Type"]="text/xml",""===u&&(u="POST"),c=2;break;case"get":case"delete":case"options":u=t[f].toUpperCase();break;case"upload":i["Content-Type"]="multipart/form-data";break;case"post":case"put":u=t[f].toUpperCase(),i["Content-Type"]||(i["Content-Type"]="application/x-www-form-urlencoded")}}var d="POST"===u||"PUT"===u;typeof r!==STRING?r=1===c?JSON.stringify(r):qs.stringify(r):"?"===r[0]&&(r=r.substring(1)),d||(r.length>0&&-1===e.indexOf("?")&&(e+="?"+r),r="");var m=parser.parse(e),h=0;if(m.method=u,i["X-Powered-By"]="total.js"+VERSION,o){var g=[],v=Object.keys(o);l=v.length;for(var f=0;l>f;f++)g.push(v[f]+"="+encodeURIComponent(o[v[f]]));g.length>0&&(i.Cookie=g.join("; "))}r.length>0&&(i["Content-Length"]=r.length),m.agent=!1,m.headers=i;var y=function(e){return e._buffer="",e._bufferlength=0,301===e.statusCode?(exports.request(e.headers.location,t,r,n,o,i,s,a),void(e=null)):(e.on("data",function(e){var t=this;t._buffer+=e.toString(s),t._bufferlength+=e.length,p.emit("data",e,h>0?t._bufferlength/h*100:0)}),e.on("end",function(){var e=this;p.emit("end",e._buffer,e.statusCode,e.headers),n&&n(null,e._buffer,e.statusCode,e.headers)}),void e.resume())},b="https:"===m.protocol?https:http;try{var w=d?b.request(m,y):b.get(m,y);n&&(w.on("error",function(e){n(e,null,0,{})}),w.setTimeout(a||1e4,function(){n(new Error(exports.httpStatus(408)),null,0,null)})),w.on("response",function(e){h=parseInt(e.headers["content-length"])||0,p.emit("begin",h)}),d?w.end(r,s):w.end()}catch(k){return n&&n(k,null,0,null),p}return p},exports.download=function(e,t,r,n,o,i,s,a){typeof r===FUNCTION&&(a=s,s=i,i=o,o=n,n=r,r=""),typeof o===NUMBER&&(o=null,a=o),typeof i===NUMBER&&(i=null,a=i),typeof s===NUMBER&&(s=null,a=s);var u="GET",l=0,c=0,p=new events.EventEmitter;if(i=exports.extend({},i||{}),typeof s!==STRING&&(s=ENCODING),null===r&&(r=""),t instanceof Array){l=t.length;for(var f=0;l>f;f++)switch(t[f].toLowerCase()){case"xhr":i["X-Requested-With"]="XMLHttpRequest";break;case"json":i["Content-Type"]="application/json",c=1;break;case"xml":i["Content-Type"]="text/xml",c=2;break;case"get":case"delete":case"options":u=t[f].toUpperCase();break;case"upload":i["Content-Type"]="multipart/form-data";break;case"post":case"put":u=t[f].toUpperCase(),i["Content-Type"]||(i["Content-Type"]="application/x-www-form-urlencoded")}}var d="POST"===u||"PUT"===u;
typeof r!==STRING?r=1===c?JSON.stringify(r):qs.stringify(r):"?"===r[0]&&(r=r.substring(1)),d||(r.length>0&&-1===e.indexOf("?")&&(e+="?"+r),r="");var m=parser.parse(e),h=0;if(m.method=u,i["X-Powered-By"]="total.js"+VERSION,o){var g=[],v=Object.keys(o);l=v.length;for(var f=0;l>f;f++)g.push(v[f]+"="+encodeURIComponent(o[v[f]]));g.length>0&&(i.Cookie=g.join("; "))}r.length>0&&(i["Content-Length"]=r.length),m.agent=!1,m.headers=i;var y=function(e){e._bufferlength=0,e.on("data",function(e){var t=this;t._bufferlength+=e.length,p.emit("data",e,h>0?t._bufferlength/h*100:0)}),e.on("end",function(){var e=this;p.emit("end",e.statusCode,e.headers)}),n(null,e),e.resume()},b="https:"===m.protocol?https:http;try{var w=d?b.request(m,y):b.request(m,y);n&&(w.on("error",function(e){n(e,null,0,{})}),w.setTimeout(a||1e4,function(){n(new Error(exports.httpStatus(408)),null,0,null)})),w.on("response",function(e){h=parseInt(e.headers["content-length"])||0,p.emit("begin",h)}),d?w.end(r,s):w.end()}catch(k){return n&&n(k,null,0,{}),p}return p},exports.send=function(e,t,r,n,o,i){var s=this;if(typeof n===OBJECT){var a=o;n=o,o=a}typeof t===STRING&&(t=fs.createReadStream(t,{flags:"r"}));var u="----"+Math.random().toString(16).substring(2),l={};o&&util._extend(l,o),e=path.basename(e),l["Cache-Control"]="max-age=0",l["Content-Type"]="multipart/form-data; boundary="+u,l["X-Powered-By"]="total.js"+VERSION;var c=parser.parse(r),p={protocol:c.protocol,auth:c.auth,method:i||"POST",hostname:c.hostname,port:c.port,path:c.path,agent:!1,headers:l},f=function(e){n&&(e.body="",e.on("data",function(e){this.body+=e.toString(ENCODING)}),e.on("end",function(){var e=this;n(null,e.body,e.statusCode,e.headers)}))},d="https:"===p.protocol?https:http,m=d.request(p,f);n&&m.on("error",function(e){n(e,null,0,null)});var h=NEWLINE+NEWLINE+"--"+u+NEWLINE+'Content-Disposition: form-data; name="File"; filename="'+e+'"'+NEWLINE+"Content-Type: "+utils.getContentType(path.extname(e))+NEWLINE+NEWLINE;return m.write(h),typeof t.length===NUMBER?(m.end(t.toString("utf8")+NEWLINE+NEWLINE+"--"+u+"--"),s):(t.on("end",function(){m.end(NEWLINE+NEWLINE+"--"+u+"--")}),t.pipe(m,{end:!1}),s)},exports.trim=function(e){var t=typeof e;return t===STRING?e.trim():t!==OBJECT?e:(Object.keys(e).forEach(function(t){var r=e[t];return typeof r===OBJECT?void exports.trim(r):void(typeof r===STRING&&(e[t]=r.trim()))}),e)},exports.noop=function(){},global.noop=function(){},exports.httpStatus=function(e,t){return e+": "+http.STATUS_CODES[e]},exports.extend=function(e,t,r){if(null===e||null===t)return e;if(typeof e!==OBJECT||typeof t!==OBJECT)return e;for(var n=Object.keys(t),o=n.length;o--;){var i=n[o];(r||void 0===e[i])&&(e[i]=t[i])}return e},exports.copy=function(e,t){if(void 0===t)return exports.extend({},e,!0);if(null===t||null===e)return t;if(typeof t!==OBJECT||typeof e!==OBJECT)return t;for(var r=Object.keys(e),n=r.length;n--;){var o=r[n];void 0!==t[o]&&(t[o]=e[o])}return t},exports.reduce=function(e,t){if(null===e||null===t)return e;var r=typeof t;if(t instanceof Array&&Object.keys(e).forEach(function(r){-1===t.indexOf(r)&&delete e[r]}),r===OBJECT){var n=Object.keys(t);Object.keys(e).forEach(function(t){-1===n.indexOf(t)&&delete e[t]})}return e},exports.assign=function(e,t,r){if(null===e||void 0===e)return e;for(var n=t.split("."),o=e[n[0]],i=1;i<n.length-1;i++)o=o[n[i]];return o[n[n.length-1]]=typeof r===FUNCTION?r(o[n[n.length-1]]):r,e},exports.isRelative=function(e){return!("//"===e.substring(0,2)||-1!==e.indexOf("http://")||-1!==e.indexOf("https://"))},exports.encode=function(e){if(void 0===e)return"";var t=typeof e;return t!==STRING&&(e=e.toString()),e.encode()},exports.decode=function(e){if(void 0===e)return"";var t=typeof e;return t!==STRING&&(e=e.toString()),e.decode()},exports.isStaticFile=function(e){var t=/\.\w{2,8}($|\?)+/g;return t.test(e)},exports.isNullOrEmpty=function(e){return typeof e!==STRING?!0:0===e.length},exports.parseInt=function(e,t){if(void 0===e||null===e)return t||0;var r=typeof e;if(r===NUMBER)return e;var n=r!==STRING?e.toString():e;return n.parseInt(t,10)},exports.parseFloat=function(e,t){if(void 0===e||null===e)return t||0;var r=typeof e;if(r===NUMBER)return e;var n=r!==STRING?e.toString():e;return n.parseFloat(t)},exports.isArray=function(e){return e instanceof Array},exports.isRegExp=function(e){return util.isRegExp(e)},exports.isDate=function(e){return util.isDate(e)},exports.getContentType=function(e){return"."===e[0]&&(e=e.substring(1)),contentTypes[e.toLowerCase()]||"application/octet-stream"},exports.setContentType=function(e,t){return"."===e[0]&&(e=e.substring(1)),contentTypes[e.toLowerCase()]=t,!0},exports.etag=function(e,t){for(var r=0,n=e.length,o=0;n>o;o++)r+=e.charCodeAt(o);return r.toString()+(t?":"+t:"")},exports.path=function(e,t){return e||(e=""),t=t||"/",e[e.length-1]===t?e:e+t},exports.random=function(e,t){return e=e||1e5,t=t||0,Math.floor(Math.random()*(e-t+1))+t},exports.GUID=function(e){e=e||40;for(var t=function(){return Math.floor(65536*Math.random()).toString(16)},r="",n=0;e/4+1>n;n++)r+=t();return r.substring(0,e)},exports.validate=function(e,t,r,n,o,i,s){typeof n===FUNCTION&&void 0===o&&(o=n,n=null),void 0===s&&(s={});var a=n,u=void 0===i?"":i+".",l=!1,c="",p=null;if(a instanceof builders.ErrorBuilder||(a=new builders.ErrorBuilder(o)),typeof t===STRING){var f=void 0===s?builders.validation(t):void 0===s[t]?"":s[t].properties;0!==f.length?(c=t,t=f,l=!0,p=void 0===s?builders.schema("default").collection:s,p||(p={})):t=t.replace(/\s/g,"").split(",")}if((void 0===e||null===e)&&(e={}),typeof r!==FUNCTION)throw new Error("Validate hasn't any method to validate properties.\nDefine delegate: framework.onValidate ...");for(var d=0;d<t.length;d++){var m=t[d].toString(),h=e[m],g=typeof h;if(void 0!==h){if(g===FUNCTION&&(h=e[m]()),g!==OBJECT&&l&&(s=builders.schema("default").collection,builders.isJoin(s,m)&&(g=OBJECT)),g===OBJECT&&!exports.isDate(h)&&l){var f=s[c];if(f)if(f=f.schema[m]||null,f===Date||f===String||f===Number||f===Boolean);else if(null!==f&&typeof f===STRING){var v="["===f[0];if(v&&(f=f.substring(1,f.length-1).trim()),v){if(!(h instanceof Array)){a.add(m,"@",u+m);continue}if(void 0===s[f]){var y=r(m,h,u+m,c,e);if(void 0===y)continue;if(g=typeof y,g===STRING){a.add(m,y,u+m);continue}if(g===BOOLEAN){y||a.add(m,"@",u+m);continue}y.isValid===!1&&a.add(m,y.error,u+m);continue}for(var b=h.length,w=0;b>w;w++)exports.validate(h[w],f,r,a,o,u+m,s);continue}exports.validate(h,f,r,a,o,u+m,s);continue}}var k=r(m,h,u+m,c,e);void 0!==k&&(g=typeof k,g!==STRING?g!==BOOLEAN?k.isValid===!1&&a.add(m,k.error,u+m):k||a.add(m,"@",u+m):a.add(m,k,u+m))}else a.add(m,"@",u+m)}return a},exports.isValid=function(e,t){return{isValid:e,error:t||"@"}},exports.isEmail=function(e){return(e||"").toString().isEmail()},exports.isURL=function(e){return(e||"").toString().isURL()},exports.combine=function(){var e=this;return"~"===arguments[0][0]?(arguments[0]=arguments[0].substring(1),path.join.apply(e,arguments)):"."+path.join.apply(e,arguments)},exports.removeDiacritics=function(e){for(var t=["á","ä","č","ď","é","ě","ť","ž","ú","ů","ü","í","ï","ô","ó","ö","š","ľ","ĺ","ý","ÿ","č","ř"],r=["a","a","c","d","e","e","t","z","u","u","u","i","i","o","o","o","s","l","l","y","y","c","r"],n="",o=e.length,i=0;o>i;i++){var s=e[i],a=!1,u=t.indexOf(s);-1===u&&(u=t.indexOf(s.toLowerCase()),a=!0),-1!==u?(s=r[u],a&&(s=s.toUpperCase()),n+=s):n+=s}return n},exports.parseXML=function(e){for(var t=-1,r=0,n=0,o=[],i={},s=-1;;){if(t=e.indexOf("<",t+1),-1===t)break;if(r=e.indexOf(">",t+1),-1===r)break;var a=e.substring(t,r+1),u=a[1];if("?"!==u&&"/"!==u){n=a.indexOf(" ");var l=!0;-1===n&&(n=a.length-1,l=!1),s=t+a.length;var c="/"===a[a.length-2],p=a.substring(1,n);if(c||o.push(p),l){var f=a.match(/\w+\=\".*?\"/g);if(null!==f){for(var d={},m=f.length,h=0;m>h;h++){var g=f[h].indexOf('"');d[f[h].substring(0,g-1)]=f[h].substring(g+1,f[h].length-1)}i[o.join(".")+(c?"."+p:"")+"[]"]=d}}}else{var v=o.pop();if(-1===s||v!==a.substring(2,a.length-1))continue;var y=(o.length>0?o.join(".")+".":"")+v,b=e.substring(s,t);void 0===i[y]?i[y]=b:i[y]instanceof Array?i[y].push(b):i[y]=[i[y],b],s=-1}}return i},exports.getWebSocketFrame=function(e,t,r){var n=getWebSocketFrameMessageBytes(e,t),o=n.length,i=getWebSocketFrameLengthBytes(o),s=new Buffer(1+i.length+o);return s[0]=128|r,i.copy(s,1,0,i.length),n.copy(s,i.length+1,0,o),s},exports.distance=function(e,t,r,n){var o=6371,i=(r-e).toRad(),s=(n-t).toRad(),a=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e.toRad())*Math.cos(r.toRad())*Math.sin(s/2)*Math.sin(s/2),u=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return(o*u).floor(3)},exports.ls=function(e,t,r){var n=new FileList;n.onComplete=t,n.onFilter=r||null,n.walk(e)},Date.prototype.add=function(e,t){var r=this,n=new Date(r.getTime());switch(e){case"s":case"ss":case"second":case"seconds":return n.setSeconds(n.getSeconds()+t),n;case"m":case"mm":case"minute":case"minutes":return n.setMinutes(n.getMinutes()+t),n;case"h":case"hh":case"hour":case"hours":return n.setHours(n.getHours()+t),n;case"d":case"dd":case"day":case"days":return n.setDate(n.getDate()+t),n;case"M":case"MM":case"month":case"months":return n.setMonth(n.getMonth()+t),n;case"y":case"yyyy":case"year":case"years":return n.setFullYear(n.getFullYear()+t),n}return n},Date.prototype.compare=function(e){var t=this,r=t.getTime()-e.getTime();return 0===r?0:0>r?-1:1},Date.compare=function(e,t){return typeof e===STRING&&(e=e.parseDate()),typeof t===STRING&&(t=t.parseDate()),e.compare(t)},Date.prototype.format=function(e){var t=this,r=t.getHours(),n=t.getMinutes().toString(),o=t.getSeconds().toString(),i=(t.getMonth()+1).toString(),s=t.getFullYear().toString(),a=t.getDate().toString(),u="AM",l=r.toString();r>=12&&(r-=12,u="PM"),0===r&&(r=12),r=r.toString();var c=r.padLeft(2,"0"),p=l.padLeft(2,"0"),f=n.padLeft(2,"0"),d=o.padLeft(2,"0"),m=i.padLeft(2,"0"),h=a.padLeft(2,"0"),g=s.substring(2);return void 0===e||null===e||""===e?s+"-"+m+"-"+h+"T"+c+":"+f+":"+d+":"+t.getMilliseconds().toString():e.replace(/yyyy/g,s).replace(/yy/g,g).replace(/MM/g,m).replace(/M/g,i).replace(/dd/g,h).replace(/d/g,a).replace(/HH/g,p).replace(/H/g,l).replace(/hh/g,c).replace(/h/g,r).replace(/mm/g,f).replace(/m/g,n).replace(/ss/g,d).replace(/s/g,d).replace(/a/g,u)},String.prototype.trim||(String.prototype.trim=function(){return this.replace(regexpTRIM,"")}),String.prototype.replaceAt||(String.prototype.replaceAt=function(e,t){var r=this;return r.substr(0,e)+t+r.substr(e+t.length)}),String.prototype.startsWith=function(e,t){var r=this,n=e.length,o=r.substring(0,n);return t?o.length===n&&o.toLowerCase()===e.toLowerCase():o.length===n&&o===e},String.prototype.endsWith=function(e,t){var r=this,n=e.length,o=r.substring(r.length-n);return t?o.length===n&&o.toLowerCase()===e.toLowerCase():o.length===n&&o===e},String.prototype.replacer=function(e,t){var r=this,n=r.indexOf(e);return-1===n?r:r.substring(0,n)+t+r.substring(n+e.length)},String.prototype.hash=function(e){var t=this;switch((e||"").toLowerCase()){case"md5":return t.md5();case"sha1":return t.sha1();case"sha256":return t.sha256();case"sha512":return t.sha512();default:return t.split("").reduce(function(e,t){return e=(e<<5)-e+t.charCodeAt(0),e&e},0)}},String.prototype.count=function(e){var t=0,r=0;do t=this.indexOf(e,t+e.length),t>0&&r++;while(t>0);return r},String.prototype.parseXML=function(){return exports.parseXML(this)},String.prototype.parseDate=function(){var e=this.trim(),t=e.split(-1===e.indexOf(" ")?"T":" "),r=t[0].indexOf(":"),n=t[0].length;if(-1!==r){var o=t[1];t[1]=t[0],t[0]=o}void 0===t[0]&&(t[0]="");for(var i=void 0===t[1]?!0:0===t[1].length,s=0;n>s;s++){var a=t[0].charCodeAt(s);if(!(a>47&&58>a)&&45!==a&&46!==a&&i)return new Date(e)}void 0===t[1]&&(t[1]="00:00:00");var u=-1===t[0].indexOf("-"),l=(t[0]||"").split(u?".":"-"),c=(t[1]||"").split(":"),p=[];if(l.length<4&&c.length<2)return new Date(e);r=(c[2]||"").indexOf("."),-1!==r?(c[3]=c[2].substring(r+1),c[2]=c[2].substring(0,r)):c[3]="0",p.push(parseInt(l[u?2:0],10)),p.push(parseInt(l[1],10)),p.push(parseInt(l[u?0:2],10)),p.push(parseInt(c[0],10)),p.push(parseInt(c[1],10)),p.push(parseInt(c[2],10)),p.push(parseInt(c[3],10));for(var f=new Date,s=0,n=p.length;n>s;s++){isNaN(p[s])&&(p[s]=0);var d=p[s];if(0===d)switch(s){case 0:0>=d&&(p[s]=f.getFullYear());break;case 1:0>=d&&(p[s]=f.getMonth()+1);break;case 2:0>=d&&(p[s]=f.getDate())}}return new Date(p[0],p[1]-1,p[2],p[3],p[4],p[5])},String.prototype.parseDateExpire=function(){for(var e=this,t=e.split(" "),r=new Date,n=t.length,o=0;n>o;o+=2){var i=t[o].parseInt();if(0!==i){var s=t[o+1]||"";""!==s&&(r=r.add(s,i))}}return r},String.prototype.contains=function(e,t){var r=this;if(typeof e===STRING)return-1!==r.indexOf(e,typeof t===NUMBER?t:0);for(var n=e.length,o=0;n>o;o++){var i=-1!==r.indexOf(e[o]);if(t){if(!i)return!1}else if(i)return!0}return t},String.prototype.configuration=function(e){return console.log("OBSOLETE: String.configuration() -> use String.parseConfig([default])"),this.parseConfig(e)},String.prototype.parseConfig=function(e){for(var t=this.split("\n"),r=t.length,n=exports.extend({},e),o=0;r>o;o++){var i=t[o];if(""!==i&&"#"!==i[0]&&"//"!==i.substring(0,2)){var s=i.indexOf(":");-1!==s&&(n[i.substring(0,s).trim()]=i.substring(s+1).trim())}}return n},String.prototype.format=function(){for(var e=this,t=arguments.length,r=0;t>r;r++){var n=new RegExp("\\{"+r+"\\}","gi");e=e.replace(n,arguments[r])}return e},String.prototype.encode=function(){return this.replace(/\&/g,"&amp;").replace(/\>/g,"&gt;").replace(/\</g,"&lt;").replace(/\"/g,"&quot;")},String.prototype.decode=function(){return this.replace(/&gt;/g,">").replace(/\&lt;/g,"<").replace(/\&quot;/g,'"').replace(/&amp;/g,"&")},String.prototype.urlEncode=function(){return encodeURIComponent(this)},String.prototype.urlDecode=function(){return decodeURIComponent(this)},String.prototype.params=function(e){var t=this;if(void 0===e||null===e)return t;var r=/\{[^}\n]*\}/g,n=t.match(r);if(null===n)return t;for(var o=n.length,i=0;o>i;i++){var s=n[i],a=!1,u=s.substring(1,s.length-1).trim(),l="",c=u.indexOf("|");-1!==c&&(l=u.substring(c+1,u.length).trim(),u=u.substring(0,c).trim()),"{!"===s.substring(0,2)?u=u.substring(1):a=!0;var p;if(-1!==u.indexOf(".")){var f=u.split(".");2===f.length?p=e[f[0]][f[1]]:3===f.length?p=e[f[0]][f[1]][f[3]]:4===f.length?p=e[f[0]][f[1]][f[3]][f[4]]:5===f.length&&(p=e[f[0]][f[1]][f[3]][f[4]][f[5]])}else p=0===u.length?e:e[u];if(typeof p===FUNCTION&&(p=p(c)),void 0!==p){if(l.length>0){var d=typeof p;if(d===STRING){var m=parseInt(l,10);isNaN(m)||(p=p.max(m+3,"..."))}else(d===NUMBER||util.isDate(p))&&(l.isNumber()&&(l=parseInt(l)),p=p.format(l))}p=p.toString().dollar(),t=t.replace(s,a?exports.encode(p):p)}}return t},String.prototype.max=function(e,t){var r=this;return t=t||"...",r.length>e?r.substring(0,e-t.length)+t:r},String.prototype.isJSON=function(){var e=this;if(e.length<=1)return!1;var t=e[0],r=e[e.length-1];return'"'===t&&'"'===r||"["===t&&"]"===r||"{"===t&&"}"===r},String.prototype.isURL=function(){var e=this;return e.length<=7?!1:regexpUrl.test(e)},String.prototype.isEmail=function(){var e=this;return e.length<=4?!1:"."===e[0]||"."===e[e.length-1]?!1:regexpMail.test(e)},String.prototype.parseInt=function(e){var t=0,r=this;return t="0"===r.substring(0,1)?parseInt(r.replace(/\s/g,"").substring(1),10):parseInt(r.replace(/\s/g,""),10),isNaN(t)?e||0:t},String.prototype.parseFloat=function(e){var t=0,r=this;return t=parseFloat("0"===r.substring(0,1)?r.replace(/\s/g,"").substring(1).replace(",","."):r.replace(/\s/g,"").replace(",",".")),isNaN(t)?e||0:t},String.prototype.toUnicode=function(){for(var e="",t=this,r=t.length,n=0;r>n;++n)e+=t.charCodeAt(n)>126||t.charCodeAt(n)<32?"\\u"+t.charCodeAt(n).hex(4):t[n];return e},String.prototype.fromUnicode=function(){var e=this.replace(/\\u([\d\w]{4})/gi,function(e,t){return String.fromCharCode(parseInt(t,16))});return unescape(e)},String.prototype.sha1=function(e){var t=crypto.createHash("sha1");return t.update(this+(e||""),ENCODING),t.digest("hex")},String.prototype.sha256=function(e){var t=crypto.createHash("sha256");return t.update(this+(e||""),ENCODING),t.digest("hex")},String.prototype.sha512=function(e){var t=crypto.createHash("sha512");return t.update(this+(e||""),ENCODING),t.digest("hex")},String.prototype.md5=function(e){var t=crypto.createHash("md5");return t.update(this+(e||""),ENCODING),t.digest("hex")},String.prototype.toSearch=function(){return this.trim().replace(/\s{2,}/g," ").toLowerCase().removeDiacritics().replace(/y/g,"i")},String.prototype.encrypt=function(e,t){var r="0"+this,n=r.length,o=e.length,i=(r[n-1],t?exports.random(120)+40:65),s=n+i%o,a=[],u=0;a[0]=String.fromCharCode(i);for(var l=this.length+e.length,c=s-1;c>0;c--)u=r.charCodeAt(c%n),a[c]=String.fromCharCode(u^(e.charCodeAt(c%o)^i));var p=new Buffer(l+"="+a.join(""),ENCODING).toString("base64").replace(/\//g,"-").replace(/\+/g,"_");return u=p.indexOf("="),u>0?p.substring(0,u):p},String.prototype.decrypt=function(e){var t=this.replace(/\-/g,"/").replace(/\_/g,"+"),r=t.length%4;if(r>0)for(var n=0;r>n;n++)t+="=";t=new Buffer(t,"base64").toString(ENCODING);var o=t.indexOf("=");if(-1===o)return null;var i=parseInt(t.substring(0,o),10);if(isNaN(i))return null;t=t.substring(o+1);for(var s=t.length,a=t.charCodeAt(0),u=e.length,l=s-a%u,c=[],n=l-1;n>0;n--)o=t.charCodeAt(n)^(a^e.charCodeAt(n%u)),c[n]=String.fromCharCode(o);var p=c.join("");return i!==p.length+e.length?null:p},String.prototype.base64ToFile=function(e,t){var r=this,n=r.indexOf(",");return-1===n?n=0:n++,t?fs.writeFile(e,r.substring(n),"base64",t):fs.writeFile(e,r.substring(n),"base64",exports.noop),this},String.prototype.base64ContentType=function(){var e=this,t=e.indexOf(";");return-1===t?"":e.substring(5,t)},String.prototype.removeDiacritics=function(){return exports.removeDiacritics(this)},String.prototype.indent=function(e,t){var r=this;return new Array(e+1).join(t||" ")+r},String.prototype.isNumber=function(e){var t=this,r=t.length;if(0===r)return!1;e=e||!1;for(var n=0;r>n;n++){var o=t.charCodeAt(n);if(!e||44!==o&&46!==o){if(48>o||o>57)return!1}else e=!1}return!0},String.prototype.padLeft||(String.prototype.padLeft=function(e,t){var r=this;return new Array(Math.max(0,e-r.length+1)).join(t||" ")+r}),String.prototype.padRight||(String.prototype.padRight=function(e,t){var r=this;return r+new Array(Math.max(0,e-r.length+1)).join(t||" ")}),String.prototype.insert=function(e,t){var r=this,n=r.substring(0,e),o=t.toString()+r.substring(e);return n+o},String.prototype.dollar=function(){for(var e=this,t=e.indexOf("$",0);-1!==t;)"$"===e[t+1]&&(e=e.insert(t,"$")),t=e.indexOf("$",t+2);return e.toString()},String.prototype.linker=function(e){e=e||60;for(var t=this.trim().toLowerCase().removeDiacritics(),r="",n=t.length,o=0;n>o;o++){var i=t[o],s=t.charCodeAt(o);if(r.length>=e)break;if(s>31&&48>s){if("-"===r[r.length-1])continue;r+="-"}else s>47&&58>s?r+=i:s>94&&123>s&&(r+=i)}return r},String.prototype.slug=function(e){return this.linker(e)},String.prototype.link=function(e){return console.log("String.prototype.link: OBSOLETE - Use String.prototype.Linker()"),this.linker(e)},String.prototype.pluralize=function(e,t,r,n){var o=this;return o.parseInt().pluralize(e,t,r,n)},String.prototype.isBoolean=function(){var e=this.toLowerCase();return"true"===e||"false"===e?!0:!1},Number.prototype.floor=function(e){return Math.floor(this*Math.pow(10,e))/Math.pow(10,e)},Number.prototype.padLeft=function(e,t){return this.toString().padLeft(e,t||"0")},Number.prototype.padRight=function(e,t){return this.toString().padRight(e,t||"0")},Number.prototype.format=function(e,t,r){var n=this;if(typeof e===STRING)return n.format2(e);var o=n.toString(),i="",s="",a=o.indexOf(".");if(typeof e===STRING){var u=t;t=e,e=u}void 0===t&&(t=" "),-1!==a&&(i=o.substring(a+1),o=o.substring(0,a));for(var a=-1,l=o.length-1;l>=0;l--)a++,a>0&&a%3===0&&(s=t+s),s=o[l]+s;return(i.length>0||e>0)&&(i=i.length>e?i.substring(0,e):i.padRight(e,"0")),i.length>0&&void 0===r&&(r="."===t?",":"."),s+(i.length>0?r+i:"")},Number.prototype.format2=function(e){console.log("OBSOLETE: Number.prototype.format('### ### ###');");var t=0,r=this.toString(),n=0,o=0,i=0,s="",a=0;if(typeof e===STRING){var u=!1;a=e.length;for(var l=0;a>l;l++){var c=e[l];"#"===c&&(u?o++:n++),"."===c&&(u=!0)}var p=r,f="";if(t=r.indexOf("."),-1!==t&&(p=r.substring(0,t),f=r.substring(t+1)),p.length>n){i=p.length-n;for(var d="",l=0;i>l;l++)d+="#";e=d+e}p.length<n&&(p=p.padLeft(n," ")),f.length<o&&(f=f.padRight(o,"0")),f.length>o&&(f=f.substring(0,o)),u=!1,t=0;var m=!0;a=e.length;for(var l=0;a>l;l++){var c=e[l];if("#"===c){var h=u?f[t]:p[t];m&&(m=-1!==[","," "].indexOf(h)),m||(s+=h),t++}else{if(m)continue;"."===c&&(u=!0,t=0),s+=c}}return s}if(s="### ### ###",n=r.indexOf("."),i=e||0,0===i&&-1!==n&&(i=r.length-(n+1)),i>0){s+=".";for(var l=0;i>l;l++)s+="#"}return this.format(s)},Number.prototype.pluralize=function(e,t,r,n){var o=this,i="";i=0===o?e||"":1===o?t||"":o>1&&5>o?r||"":n;var s=i.indexOf("#"),a=i.lastIndexOf("#");if(-1===s)return i;var u=i.substring(s,a+1);return o.format(u)+i.replace(u,"")},Number.prototype.hex=function(e){for(var t=this.toString(16).toUpperCase();t.length<e;)t="0"+t;return t},Number.prototype.condition=function(e,t){return(this%2===0?e:t)||""},Number.prototype.VAT=function(e,t,r){var n=this,o=typeof t;if(o===BOOLEAN){var i=r;r=t,t=i,o=typeof t}return o===UNDEFINED&&(t=2),void 0===r&&(r=!0),0===e||0===n?n:r?(n/(e/100+1)).floor(t):(n*(e/100+1)).floor(t)},Number.prototype.discount=function(e,t){var r=this;return void 0===t&&(t=2),(r-r/100*e).floor(t)},Number.prototype.parseDate=function(e){return new Date(this+(e||0))},typeof Number.prototype.toRad===UNDEFINED&&(Number.prototype.toRad=function(){return this*Math.PI/180}),Boolean.prototype.condition=function(e,t){return(this?e:t)||""},Array.prototype.take=function(e){for(var t=[],r=this,n=r.length,o=0;n>o;o++)if(t.push(r[o]),t.length>=e)return t;return t},Array.prototype.orderBy=function(e,t){if(typeof e===BOOLEAN){var r=t;t=e,e=r}void 0===t&&(t=!0);var n=this,o=0,i=(e||"").split("."),s=i.length;return n.sort(function(e,r){var n=null,a=null;switch(s){case 1:""===i[0]?(n=e,a=r):(n=e[i[0]],a=r[i[0]]);break;case 2:n=e[i[0]][i[1]],a=r[i[0]][i[1]];break;case 3:n=e[i[0]][i[1]][i[2]],a=r[i[0]][i[1]][i[2]];break;case 4:n=e[i[0]][i[1]][i[2]][i[3]],a=r[i[0]][i[1]][i[2]][i[3]];break;case 5:n=e[i[0]][i[1]][i[2]][i[3]][i[4]],a=r[i[0]][i[1]][i[2]][i[3]][i[4]];break;default:return 0}if(0===o){var u=typeof n;o=u===STRING?1:u===NUMBER?2:u===BOOLEAN?3:4}return 1===o?t?n.removeDiacritics().localeCompare(a.removeDiacritics()):a.removeDiacritics().localeCompare(n.removeDiacritics()):2===o?n>a?t?1:-1:a>n?t?-1:1:0:3===o?n===!0&&a===!1?t?1:-1:n===!1&&a===!0?t?-1:1:0:0}),n},Array.prototype.trim=function(){for(var e=this,t=e.length,r=0;t>r;r++)typeof e[r]===STRING&&(e[r]=e[r].trim());return e},Array.prototype.skip=function(e){for(var t=[],r=this,n=r.length,o=0;n>o;o++)o>=e&&t.push(r[o]);return t},Array.prototype.where=function(e){for(var t=this,r=[],n=t.length,o=0;n>o;o++)e.call(t,t[o],o)&&r.push(t[o]);return r},Array.prototype.find=function(e){for(var t=this,r=t.length,n=0;r>n;n++)if(e.call(t,t[n],n))return t[n];return null},Array.prototype.remove=function(e){for(var t=this,r=[],n=t.length,o=0;n>o;o++)e.call(t,t[o],o)||r.push(t[o]);return r},Array.prototype.random=function(){var e=this;return e[exports.random(e.length-1)]},Array.prototype.waiting=function(e,t){return console.log("Array.prototype.waiting: OBSOLETE. Use Array.prototype.wait"),this.wait(e,t)},Array.prototype.wait=function(e,t,r){var n=this,o=typeof t;if(o===NUMBER||o===BOOLEAN){var i=r;r=t,t=i}void 0===r&&(r=0);var s=r===!0?n.shift():n[r];return void 0===s?(t&&t(),n):(e.call(n,s,function(){setImmediate(function(){typeof r===NUMBER&&r++,n.wait(e,t,r)})}),n)},Array.prototype.async=function(e){var t=this,r=t.shift();return void 0===r?(e&&e(),t):(r(function(){setImmediate(function(){t.async(e)})}),t)},Array.prototype._async_middleware=function(e,t,r){var n=this;if(e.success||e.headersSent)return r&&r.subscribe.success(),t=null,n;var o=n.shift();return void 0===o?(t&&t(),n):(o(function(){setImmediate(function(){n._async_middleware(e,t)})}),n)},Array.prototype.randomize=function(){var e=this,t=(10*Math.floor(1e8*Math.random())).toString(),r=0,n=0;return e.sort(function(){var e=t[r++];return void 0===e&&(e=t[0],r=0),n>e?(n=e,-1):n===e?(n=e,0):(n=e,1)}),e},AsyncTask.prototype.run=function(){var e=this;try{e.isRunning=1,e.owner.tasksWaiting[e.name]=!0,e.owner.emit("begin",e.name);var t=e.owner.tasksTimeout[e.name];t>0&&(e.interval=setTimeout(e.timeout.bind(e),t)),e.fn(e.handlers.oncomplete)}catch(r){e.owner.emit("error",e.name,r),e.complete()}return e},AsyncTask.prototype.timeout=function(e){var t=this;return e>0?(clearTimeout(t.interval),setTimeout(t.timeout.bind(t),e),t):0>=e?(clearTimeout(t.interval),setTimeout(t.timeout.bind(t),e),t):(t.cancel(!0),t)},AsyncTask.prototype.cancel=function(e){var t=this;t.isCanceled=!0,e?t.owner.emit("timeout",t.name):t.owner.emit("cancel",t.name),t.fn=null,t.cb=null},AsyncTask.prototype.complete=function(){var e=this,t=e.owner;if(e.isRunning=2,delete t.tasksPending[e.name],delete t.tasksWaiting[e.name],!e.isCanceled)try{t.emit("end",e.name),e.cb&&e.cb()}catch(r){t.emit("error",r,e.name)}return t.reload(),t.refresh(),t},Async.prototype={get count(){return this._count},get percentage(){var e=this;return 100-Math.floor(100*e._count/e._max)}},Async.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:Async,enumberable:!1}}),Async.prototype.reload=function(){var e=this;return e.tasksAll=Object.keys(e.tasksPending),e.emit("percentage",e.percentage),e},Async.prototype.cancel=function(e){var t=this;if(void 0===e){for(var r=0;r<t._count;r++)t.cancel(tasksAll[r]);return!0}var n=t.tasksPending[e];return n?(delete t.tasksPending[e],delete t.tasksWaiting[e],n.cancel(),t.reload(),t.refresh(),!0):!1},Async.prototype.await=function(e,t,r){var n=this;return typeof e===FUNCTION&&(r=t,t=e,e=exports.GUID(6)),void 0!==n.tasksPending[e]?!1:(n.tasksPending[e]=new AsyncTask(n,e,t,r,null),n._max++,n.reload(),n.refresh(),!0)},Async.prototype.wait=function(e,t,r,n){var o=this;return typeof t===FUNCTION&&(n=r,r=t,t=e,e=exports.GUID(6)),void 0!==o.tasksPending[e]?!1:(o.tasksPending[e]=new AsyncTask(o,e,r,n,t),o._max++,o.reload(),o.refresh(),!0)},Async.prototype.complete=function(e){return this.run(e)},Async.prototype.run=function(e){var t=this;return t._isRunning=!0,e&&t.onComplete.push(e),t.refresh(),t},Async.prototype.isRunning=function(e){var t=this;if(!e)return t._isRunning;var r=t.tasksPending[e];return r?1===r.isRunning:!1},Async.prototype.isWaiting=function(e){var t=this,r=t.tasksPending[e];return r?0===r.isRunning:!1},Async.prototype.isPending=function(e){var t=this,r=t.tasksPending[e];return r?!0:!1},Async.prototype.timeout=function(e,t){var r=this;return 0>=t||void 0===t?(delete r.tasksTimeout[e],r):(r.tasksTimeout[e]=t,r)},Async.prototype.refresh=function(){var e=this;if(!e._isRunning)return e;e._count=e.tasksAll.length;for(var t=0;t<e._count;t++){var r=e.tasksPending[e.tasksAll[t]];0===r.isRunning&&(null===r.waiting||void 0===e.tasksWaiting[r.waiting])&&r.run()}if(0===e._count){e._isRunning=!1,e.emit("complete"),e.emit("percentage",100),e._max=0;var n=e.onComplete,o=n.length;e.onComplete=[];for(var t=0;o>t;t++)try{n[t]()}catch(i){e.emit("error",i)}}return e},FileList.prototype.reset=function(){var e=this;e.file=[],e.directory=[],e.pendingDirectory=[]},FileList.prototype.walk=function(e){var t=this;if(e instanceof Array){for(var r=e.length,n=0;r>n;n++)t.pendingDirectory.push(e[n]);return void t.next()}fs.readdir(e,function(r,n){if(r)return t.next();for(var o=n.length,i=0;o>i;i++)t.pending.push(path.join(e,n[i]));t.next()})},FileList.prototype.stat=function(e){var t=this;fs.stat(e,function(r,n){return r?t.next():n.isDirectory()&&(null===t.onFilter||t.onFilter(e,!0))?(t.directory.push(e),t.pendingDirectory.push(e),void t.next()):((null===t.onFilter||t.onFilter(e,!1))&&t.file.push(e),void t.next())})},FileList.prototype.next=function(){var e=this;if(e.pending.length>0){var t=e.pending.shift();return void e.stat(t)}if(e.pendingDirectory.length>0){var r=e.pendingDirectory.shift();return void e.walk(r)}e.onComplete(e.file,e.directory)},exports.Async=Async,exports.sync=function(e,t){return function(){var r,n,o=[].slice.call(arguments),i=!1,s=t||this;return o.push(function(){r=arguments,!i&&n&&(i=!0,n.apply(s,r))}),e.apply(s,o),function(e){n=e,!i&&r&&(i=!0,n.apply(s,r))}}},exports.async=function(e){return function(t){function r(e,i){var s;try{switch(null===e){case!0:s=o.next(i);break;case!1:s=o.throw(e)}}catch(a){return void(t&&(typeof t===OBJECT&&t.view500?t.view500(a):t(a)))}if(s.done)return void(t&&typeof t!==OBJECT&&t(null,s.value));if(typeof s.value!==FUNCTION)return void r.call(n,null,s.value);try{s.value.call(n,function(){r.apply(n,arguments)})}catch(a){setImmediate(function(){r.call(n,a)})}}var n=this,o=e();return r(null),o.value}},exports.getMessageLength=function(e,t){var r=127&e[1];if(126===r){if(e.length<4)return-1;var n=[e[3],e[2],0,0,0,0,0,0];return converBytesToInt64(n,0,t)}if(127===r){if(e.Length<10)return-1;var n=[e[9],e[8],e[7],e[6],e[5],e[4],e[3],e[2]];return converBytesToInt64(n,0,t)}return r};var queue={};return exports.queue=function(e,t,r){void 0===queue[e]&&(queue[e]={limit:t,running:0,pending:[]});var n=queue[e];return n.running++,n.running>n.limit?void n.pending.push(r):void function(e){setImmediate(function(){r(function(){queue_next(e)})})}(e)},global.async=exports.async,global.sync=exports.sync,module}({exports:{}}),function(e){function t(e,t){return e[t]<<8|e[t+1]}function r(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function n(e,t){var r=typeof e;if(this.builder=[],this.filename="string"===r?e:null,this.currentStream="object"===r?e:null,this.isIM=t||!1,this.outputType="string"===r?u.extname(e).substring(1):"jpg",!e)throw new Error("Image filename is undefined.")}var o=e.exports;global.framework_image=e.exports;var i=require("child_process"),s=i.exec,a=i.spawn,u=require("path"),l={192:!0,193:!0,194:!0,195:!0,197:!0,198:!0,199:!0,201:!0,202:!0,203:!0,205:!0,206:!0,207:!0};return o.measureGIF=function(e){return{width:e[6],height:e[8]}},o.measureJPG=function(e){var r=e.length,n=0,o=255==e[0]&&216==e[1];if(o){for(n+=2;r>n;){for(;255!=e[n];)n++;for(;255==e[n];)n++;{if(l[e[n]]){var i=t(e,n+6),s=t(e,n+4);return{width:i,height:s}}n+=t(e,++n)}}return null}},o.measurePNG=function(e){return{width:r(e,16),height:r(e,20)}},n.prototype.clear=function(){var e=this;return e.builder=[],e},n.prototype.measure=function(e){var t=this,r=t.filename.lastIndexOf(".");if(!t.filename)return void e(new Error("Measure does not support stream."));if(-1===r)return void e(new Error("This type of file is not supported."));var n=t.filename.substring(r).toLowerCase(),i=require("fs").createReadStream(t.filename,{start:0,end:".jpg"===n?4e4:24});return i.on("data",function(t){switch(n){case".jpg":return void e(null,o.measureJPG(t));case".gif":return void e(null,o.measureGIF(t));case".png":return void e(null,o.measurePNG(t))}e(new Error("This type of file is not supported."))}),i.on("error",e),t},n.prototype.save=function(e,t){var r=this;"function"==typeof e&&(t=e,e=null),e=e||r.filename||"";var n=r.cmd(null===r.filename?"-":r.filename,e);if(0===r.builder.length)return void(t&&t(null,e));var o=s(n,function(n){r.clear(),t&&(n?t(n,""):t(null,e))});return r.currentStream&&(r.currentStream instanceof Buffer?o.stdin.end(r.currentStream):r.currentStream.pipe(o.stdin)),r},n.prototype.pipe=function(e,t,r){var n=this;if("object"==typeof t&&(r=t,t=null),0!==n.builder.length){(void 0===t||null===t)&&(t=n.outputType);var o=a(n.isIM?"convert":"gm",n.arg(null===n.filename?"-":n.filename,(t?t+":":"")+"-"));return o.stderr.on("data",e.emit.bind(e,"error")),o.stdout.on("data",e.emit.bind(e,"data")),o.stdout.on("end",e.emit.bind(e,"end")),o.on("error",e.emit.bind(e,"error")),o.stdout.pipe(e,r),n.currentStream&&(n.currentStream instanceof Buffer?o.stdin.end(n.currentStream):n.currentStream.pipe(o.stdin)),n
}},n.prototype.stream=function(e){var t=this;if(0!==t.builder.length){(void 0===e||null===e)&&(e=t.outputType);var r=a(t.isIM?"convert":"gm",t.arg(null===t.filename?"-":t.filename,(e?e+":":"")+"-"));return t.currentStream&&(t.currentStream instanceof Buffer?r.stdin.end(t.currentStream):t.currentStream.pipe(r.stdin)),r.stdout}},n.prototype.cmd=function(e,t){var r=this,n="";r.builder.sort(function(e,t){return e.priority>t.priority?1:-1});for(var o=r.builder.length,i=0;o>i;i++)n+=(n.length>0?" ":"")+r.builder[i].cmd;return(r.isIM?"convert":"gm -convert")+' "'+e+'" '+n+' "'+t+'"'},n.prototype.arg=function(e,t){var r=this,n=[];r.isIM||n.push("-convert"),e&&n.push(e),r.builder.sort(function(e,t){return e.priority>t.priority?1:-1});for(var o=r.builder.length,i=0;o>i;i++){var s=r.builder[i],a=s.cmd.indexOf(" ");-1===a?n.push(s.cmd):(n.push(s.cmd.substring(0,a)),n.push(s.cmd.substring(a+1).replace(/\"/g,"")))}return t&&n.push(t),n},n.prototype.identify=function(e){var t=this;return s((t.isIM?"identify":"gm identify")+' "'+t.fileName+'"',function(t,r){if(t)return void e(t,null);var n=r.split(" "),o=n[2].split("x"),i={type:n[1],width:framework_utils.parseInt(o[0]),height:framework_utils.parseInt(o[1])};e(null,i)}),t},n.prototype.push=function(e,t,r){var n=this;return n.builder.push({cmd:e+(t?' "'+t+'"':""),priority:r}),n},n.prototype.output=function(e){var t=this;return"."===e[0]&&(e=e.substring(1)),t.outputType=e,t},n.prototype.resize=function(e,t,r){r=r||"";var n=this,o="";return e&&t?o=e+"x"+t:e&&!t?o=e:!e&&t&&(o="x"+t),n.push("-resize",o+r,1)},n.prototype.resizeCenter=function(e,t){return this.resize(e,t,"^").align("center").crop(e,t)},n.prototype.scale=function(e,t,r){r=r||"";var n=this,o="";return e&&t?o=e+"x"+t:e&&!t?o=e:!e&&t&&(o="x"+t),n.push("-scale",o+r,1)},n.prototype.crop=function(e,t,r,n){return this.push("-crop",e+"x"+t+"+"+(r||0)+"+"+(n||0),4)},n.prototype.quality=function(e){return this.push("-quality",e||80,5)},n.prototype.align=function(e){var t="";switch(e.toLowerCase().replace("-","")){case"left top":case"top left":t="NorthWest";break;case"left bottom":case"bottom left":t="SouthWest";break;case"right top":case"top right":t="NorthEast";break;case"right bottom":case"bottom right":t="SouthEast";break;case"left center":case"center left":case"left":t="West";break;case"right center":case"center right":case"right":t="East";break;case"bottom center":case"center bottom":case"bottom":t="South";break;case"top center":case"center top":case"top":t="North";break;case"center center":case"center":t="Center";break;default:t=e}return this.push("-gravity",t,3)},n.prototype.gravity=function(e){return this.align(e)},n.prototype.blur=function(e){return this.push("-blur",e,10)},n.prototype.normalize=function(){return this.push("-normalize",null,10)},n.prototype.rotate=function(e){return this.push("-rotate",e||0,8)},n.prototype.flip=function(){return this.push("-flip",null,10)},n.prototype.flop=function(){return this.push("-flop",null,10)},n.prototype.minify=function(){return this.push("+profile","*")},n.prototype.grayscale=function(){return this.push("-colorspace","Gray",10)},n.prototype.bitdepth=function(e){return this.push("-depth",e,10)},n.prototype.colors=function(e){return this.push("-colors",e,10)},n.prototype.background=function(e){return this.push("-background",e,2)},n.prototype.sepia=function(){return this.push("-modulate","115,0,100",4).push("-colorize","7,21,50",5)},n.prototype.command=function(e,t,r){return this.push(e,t,r||10)},o.Image=n,o.Picture=n,o.init=function(e,t){return new n(e,t)},o.load=function(e,t){return new n(e,t)},e}({exports:{}}),function(module){function Database(e,t,r){typeof t===BOOLEAN&&(r=t,t=null),this.isReady=!1,this.status_prev=STATUS_UNKNOWN,this.status=STATUS_UNKNOWN,this.changes=void 0===r?!0:r===!0,this.countRead=0,this.countWrite=0,this.pendingRead=[],this.pendingEach=[],this.pendingLock=[],this.pendingDrop=[],this.pendingWrite=[],this.pendingClear=[],this.isPending=!1,-1!==e.indexOf(EXTENSION)&&(e=e.replace(EXTENSION,"")),this.filename=e+EXTENSION,this.filenameTemp=e+EXTENSION_TMP,this.filenameChanges=e+EXTENSION_CHANGES,this.filenameStored=e+EXTENSION_STORED,this.filenameMeta=e+EXTENSION_META,this.name=path.basename(e),this.directory=path.dirname(e),this.views=new Views(this),this.meta={version:VERSION,views:{},stored:{},description:"",created:new Date,custom:null},this.binary=0===(t||"").length?null:new Binary(this,t),this.changelog=new Changelog(this,this.filenameChanges),this.file=new FileReader(this),this.stored=new Stored(this,this.filenameStored),this._metaLoad()}function Views(e){this.views={},this.db=e,this.directory=e.directory,this.emit=e.emit}function View(e,t,r){this.db=e,this.status=STATUS_UNKNOWN,this.countRead=0,this.pendingRead=[],this.pendingOperation=[],this.filename=r,this.name=t,this.emit=e.emit,this.file=new FileReader(e)}function Stored(e,t){this.filename=t,this.db=e,this.stored={},this.cache={},this.isReaded=!1}function Binary(e,t){this.db=e,this.directory=t,this.exists=!1}function Changelog(e,t){this.filename=t,this.db=e}function FileReader(e){this.db=e}function noop(){}function appendFile(e,t,r,n){if(0===t.length)return void r();var o="";t.slice(0,30).forEach(function(e){o+=JSON.stringify(e)+NEWLINE}),fs.appendFile(e,o,function(o){o&&n.emit("error",o),appendFile(e,t.slice(30),r,n)})}function filterPrepare(fnFilter){return 0===fnFilter.length?function(){return!0}:eval("(function(doc){"+(-1===fnFilter.indexOf("return ")?"return ":"")+fnFilter+"})")}function onBuffer(e,t,r){var n=e.indexOf(NEWLINE);if(-1===n)return void r(e);var o=r(e.substring(0,n));try{t(null,JSON.parse(o),o)}catch(i){t(i,null,o)}onBuffer(e.substring(n+1),t,r)}function updatePrepare(e,t,r,n){return typeof e===STRING&&(e=filterPrepare(e)),{filter:e,callback:t,count:0,type:n,changes:r}}function u16(e,t){return e[t]<<8|e[t+1]}function u32(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function dimensionGIF(e){return{width:e[6],height:e[8]}}function dimensionJPG(e){var t=e.length,r=0,n=255==e[0]&&216==e[1];if(n)for(r+=2;t>r;){for(;255!=e[r];)r++;for(;255==e[r];)r++;{if(sof[e[r]]){var o=u16(e,r+6),i=u16(e,r+4);return{width:o,height:i}}r+=u16(e,++r)}}}function dimensionPNG(e){return{width:u32(e,16),height:u32(e,20)}}var exports=module.exports;global.framework_nosql=module.exports;var fs=require("fs"),path=require("path"),util=require("util"),events=require("events"),VERSION="v2.0.9",STATUS_UNKNOWN=0,STATUS_READING=1,STATUS_WRITING=2,STATUS_LOCKING=3,STATUS_PENDING=4,EXTENSION=".nosql",EXTENSION_VIEW=".nosql",EXTENSION_BINARY=".nosql-binary",EXTENSION_TMP=".nosql-tmp",EXTENSION_CHANGES=".changelog",EXTENSION_STORED=".nosql-stored",EXTENSION_META=".meta",MAX_WRITESTREAM=2,MAX_READSTREAM=4,MAX_BUFFER_SIZE=40960,BINARY_HEADER_LENGTH=2e3,NEWLINE="\n",STRING="string",FUNCTION="function",UNDEFINED="undefined",BOOLEAN="boolean";typeof setImmediate===UNDEFINED&&(global.setImmediate=function(e){process.nextTick(e)}),Database.prototype={get created(){var e=this.meta.created;return util.isDate(e)?e:null===e||void 0===e?null:new Date(Date.parse(e.toString()))}},Database.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:Database,enumberable:!1}}),Database.prototype.insert=function(e,t,r){var n=this;typeof t===STRING&&(r=t,t=null),e instanceof Array||(e=[e]);var o=e.length;if(n.status===STATUS_LOCKING||n.status===STATUS_PENDING||n.countWrite>=MAX_WRITESTREAM){for(var i=0;o>i;i++)n.pendingWrite.push({json:e[i],changes:r});return t&&t(-1),n}for(var s=[],a=[],i=0;o>i;i++){var u=e[i];void 0!==u.json?(s.push(u.json),u.changes&&a.push(u.changes)):(s.push(u),r&&a.push(r))}return 0===s.length?void n.next():(n.emit("insert",!0,s.length),n.status=STATUS_WRITING,n.countWrite++,appendFile(n.filename,s,function(){if(n.countWrite--,n.emit("insert",!1,s.length),n.next(),n.changelog.insert(a),t){var r=s.length;setImmediate(function(){t(r)})}s=null,a=null,e=null;for(var o=Object.keys(n.meta.views),r=o.length,i=0;r>i;i++)n.views.refresh(o[i])},n),n)},Database.prototype.read=function(e,t,r,n,o,i){var s=this,a=r||0,u=n||0;if(s.status===STATUS_LOCKING||s.status===STATUS_PENDING||s.countRead>=MAX_READSTREAM)return s.pendingRead.push(function(){s.read(e,t,r,n,o)}),s;void 0===t&&(t=e,e=function(e){return e}),typeof e===STRING&&(e=filterPrepare(e)),null===e&&(e=function(e){return e}),s.emit(i||"read",!0,0),s.countRead++,s.status=STATUS_READING;{var l=[],c="",p=0,f=!0,d=function(e){return c+=e},m=function(t,r){if(f&&(c="",!t)){var n=e(r);n!==!1&&null!==n&&void 0!==n&&(p++,a>0&&a>=p||(o||l.push(n===!0?r:n),u>0&&l.length===u&&(f=!1)))}};s.file.open(s.filename,MAX_BUFFER_SIZE,function(e){return onBuffer(e,m,d),f},function(){s.countRead--,s.next(),setImmediate(function(){s.emit(i||"read",!1,o?p:l.length),t(o?p:l)})})}return s},Database.prototype.all=function(e,t,r,n){return this.read(e,t,r,n,!1,"all")},Database.prototype.one=function(e,t){var r=function(e){t(e[0]||null)};return this.read(e,r,0,1,!1,"one")},Database.prototype.top=function(e,t,r){return this.read(t,r,0,e,!1,"top")},Database.prototype.count=function(e,t){return this.read(e,t,0,0,!0,"count")},Database.prototype.each=function(e,t){var r=this;if(r.status===STATUS_LOCKING||r.status===STATUS_PENDING||r.countRead>=MAX_READSTREAM)return e&&r.pendingEach.push({item:e,callback:t}),r;var n=[];e&&n.push({item:e,callback:t});for(var o=r.pendingEach.length,i=0;o>i;i++)n.push(r.pendingEach[i]);if(0===n.length)return r.next(),r;r.countRead++,r.status=STATUS_READING;var s="",a=0;r.pendingEach=[];var u=function(e){return s+=e},l=function(e,t){if(s="",e)return void r.emit("error",e,"each-buffer");for(var o=n.length,i=0;o>i;i++)try{n[i].item(t,a,"each-buffer")}catch(u){r.emit("error",u)}a++};r.emit("each",!0,0);r.file.open(r.filename,MAX_BUFFER_SIZE,function(e){return onBuffer(e,l,u),!0},function(){r.countRead--,r.next(),setImmediate(function(){r.emit("each",!1,a);for(var e=n.length,t=0;e>t;t++){var o=n[t];o.callback&&o.callback()}})});return r},Database.prototype.sort=function(e,t,r,n,o){var i=this,s=[],a=0;typeof e===STRING&&(e=filterPrepare(e)),n=n||30,r=r||0;var u=function(){s.sort(t),(r>0||n>0)&&(s=s.slice(r,r+n)),o(s,a)},l=function(t){var r=e(t);r!==!1&&null!==r&&void 0!==r&&(a++,s.push(r===!0?t:r))};return i.each(l,u),i},Database.prototype.clear=function(e,t){var r=this,n=typeof e;if(void 0===e&&(e=null),n===STRING&&(t=e,e=null),r.pendingClear.push(function(){t&&r.changelog.insert(t),e&&e()}),r.status!==STATUS_UNKNOWN)return r;r.status=STATUS_LOCKING;for(var o=[],i=r.pendingClear.length,s=0;i>s;s++){var a=r.pendingClear[s];null!==a&&o.push(a)}return r.emit("clear",!0,!1),r.pendingClear=[],fs.exists(r.filename,function(e){return e?void fs.unlink(r.filename,function(e){e&&r.emit("error",e,"clear"),r.next(),setImmediate(function(){r.emit("clear",!1,null===e);for(var t=o.length,n=0;t>n;n++){var i=o[n];i&&i()}})}):(r.next(),void setImmediate(function(){r.emit("clear",!1,!0);for(var e=o.length,t=0;e>t;t++){var n=o[t];n&&n()}}))}),r},Database.prototype.drop=function(e){var t=this;if(void 0===e&&(e=null),t.pendingDrop.push(e),t.status!==STATUS_UNKNOWN)return t;t.status=STATUS_LOCKING;var r=[];return t.pendingDrop.forEach(function(e){null!==e&&r.push(e)}),t.emit("drop",!0,!1),t.pendingDrop=[],t._drop(),fs.exists(t.filename,function(e){return e?(fn.unlink(t.filenameMeta,noop),void fs.unlink(t.filename,function(e){e&&t.emit("error",e,"drop"),t.next(),setImmediate(function(){t.emit("drop",!1,null===e),r.forEach(function(t){t&&t(null===e)})})})):(t.next(),void setImmediate(function(){t.emit("drop",!1,!0),r.forEach(function(e){e&&e()})}))}),t},Database.prototype._drop=function(){var e=this;return fs.readdirSync(e.directory).forEach(function(t){var r=-1!==t.indexOf(e.name+"#")&&-1!==t.indexOf(EXTENSION_VIEW);if(r)return void fs.unlink(path.join(e.directory,t),noop);var n=e.name+EXTENSION_CHANGES===t;return n?void fs.unlink(path.join(e.directory,t),noop):void 0}),null===e.binary?e:(fs.readdirSync(e.binary.directory).forEach(function(t){-1!==t.indexOf(e.name+"#")&&-1!==t.indexOf(EXTENSION_BINARY)&&fs.unlink(path.join(e.binary.directory,t),noop)}),e)},Database.prototype.update=function(e,t,r,n){var o=this;if(typeof t===STRING&&(r=t,t=null),void 0!==e&&o.pendingLock.push(updatePrepare(e,t,r,n||"update")),o.status!==STATUS_UNKNOWN)return o;var i=[];if(o.pendingLock.forEach(function(e){i.push(e)}),0===i.length)return o.next(),o;o.status=STATUS_LOCKING;var s="",a=i.length,u=[],l=0,c=0,p=0,f=!1;o.emit("update/remove",!0,0,0),o.pendingLock=[];var d=function(){i.forEach(function(e){return"update"===e.type?void(e.count=c):void("remove"===e.type&&(e.count=l))}),fs.rename(o.filenameTemp,o.filename,function(e){e&&o.emit("error",e,"update/rename-file"),o.emit("update/remove",!1,c,l);var t=[];i.forEach(function(e){void 0!==e.changes&&t.push(e.changes),e.callback&&function(e,t){setImmediate(function(){e(t)})}(e.callback,e.count)}),t.length>0&&o.changelog.insert(t),o.next()})},m=function(e,t){if(u.length>25||t){if(0===u.length)return void(f&&0>=p&&d());p++,fs.appendFile(o.filenameTemp,u.join(NEWLINE)+NEWLINE,function(){p--,f&&0>=p&&d()}),u=[]}typeof e===STRING&&u.push(e)},h=function(e){return s+=e},g=function(e,t,r){s="";for(var n=null,u=0;a>u;u++){var p=i[u];if(n=p.filter(t)||null,null===n)break}if(null===n)return o.emit("remove",t),void l++;var f=JSON.stringify(n);f!==r&&(o.emit("update",n),c++),m(f)};fs.appendFile(o.filenameTemp,"");o.file.open(o.filename,MAX_BUFFER_SIZE,function(e){return onBuffer(e.toString(),g,h),!0},function(e){return e?(f=!0,void m(null,!0)):void o.next()});return o},Database.prototype.prepare=function(e,t,r){var n=this;return void 0!==e&&n.pendingLock.push(updatePrepare(e,t,r,"update")),n},Database.prototype.remove=function(e,t,r){var n=this;typeof e===STRING&&(e=filterPrepare(e));var o=function(t){return e(t)===!0?null:t};return n.update(o,t,r,"remove"),n},Database.prototype.pause=function(){var e=this;return e.isPending===!0?e:(e.isPending=!0,e.status===STATUS_UNKNOWN&&(e.status=STATUS_PENDING,e.emit("pause/resume",!0)),e)},Database.prototype.resume=function(){var e=this;return e.isPending?(e.isPending=!1,e.emit("pause/resume",!1),e.next(),e):e},Database.prototype.next=function(){var e=this;if(e.isPending)return void(e.status!==STATUS_PENDING&&(e.status=STATUS_PENDING,e.emit("pause")));if(e.status_prev=e.status,e.status=STATUS_UNKNOWN,e.countRead>0)return void(e.status=STATUS_READING);if(e.countWrite>0)return void(e.status=STATUS_WRITING);if(e.pendingWrite.length>0)return e.insert(e.pendingWrite),void(e.pendingWrite=[]);if(e.pendingLock.length>0)return void e.update();if(e.pendingEach.length>0)return void e.each();if(!(e.pendingRead.length>0))return e.pendingDrop.length>0?void e.drop():e.pendingClear.length>0?void e.clear():void setImmediate(function(){e.emit("complete",e.status_prev)});var t=e.pendingRead.length;t>MAX_READSTREAM&&(t=MAX_READSTREAM);for(var r=0;t>r;r++)e.pendingRead.shift()()},Database.prototype.description=function(e){var t=this;return void 0===e?t.meta.description:(t.meta.description=(e||"").toString(),t._metaSave(),t)},Database.prototype.custom=function(e){var t=this;return void 0===e?t.meta.custom:(t.meta.custom=e,t._metaSave(),t)},Database.prototype._metaSave=function(){var e=this;return void 0===e.meta.created&&(e.meta.created=new Date),fs.writeFile(e.filenameMeta,JSON.stringify(e.meta),noop),e},Database.prototype._metaLoad=function(e){var t=this;return fs.readFile(t.filenameMeta,function(r,n){var o=t.isReady;if(t.isReady=!0,r)return o||(t.emit("ready"),t.emit("load")),void(e&&e(!1,t.meta));t.meta=JSON.parse(n.toString("utf8"));for(var i=Object.keys(t.meta.views),s=i.length,a=0;s>a;a++)t.meta.views[i[a]].isReady=!0;o||(t.emit("ready"),t.emit("load")),e&&e(!0,t.meta)}),t},Views.prototype.all=function(e,t,r,n,o){var i=this,s=i.views[e];void 0===s&&(s=i.getView(e),i.views[e]=s);var a=typeof r;return a===FUNCTION||a===STRING?(o=r,r=0,n=0):(a=typeof n,(a===FUNCTION||a===STRING)&&(o=n,n=0)),typeof o===STRING&&(o=filterPrepare(o)),typeof o!==FUNCTION&&(o=function(e){return e}),s.read(o,t,r,n),i.db},Views.prototype.top=function(e,t,r,n){var o=this,i=o.views[e];return void 0===i&&(i=o.getView(e),o.views[e]=i),typeof n===STRING&&(n=filterPrepare(n)),typeof n!==FUNCTION&&(n=function(e){return e}),i.read(n,r,0,t,!0),o.db},Views.prototype.one=function(e,t,r){var n=this,o=n.views[e];return void 0===o&&(o=n.getView(e),n.views[e]=o),void 0===r&&(r=t,t=null),typeof t===STRING&&(t=filterPrepare(t)),typeof t!==FUNCTION&&(t=function(e){return e}),o.read(t,r,0,1,!0),n.db},Views.prototype.drop=function(e,t,r){var n=this,o=n.views[e];return typeof t===STRING&&(r=t,t=null),void 0===o&&(o=n.getView(e),n.views[e]=o),delete n.db.meta.views[e],n.db._metaSave(),n.db.emit("view/drop",!0,e),o.operation(function(i){fs.exists(o.filename,function(s){return n.db.emit("view/drop",!1,e),r&&n.db.changelog.insert(r),s?void fs.unlink(o.filename,function(e){e&&n.db.emit("error",e,"view/drop"),t&&t(!0),i&&i()}):(t&&t(!0),void(i&&i()))})}),n.db},Views.prototype.refresh=function(name,fnCallback){var self=this,schema=self.db.meta.views[name];schema.isReady=!1;var fnSort=schema.sort||"",fnMap=schema.map;fnSort=0===fnSort.length?null:eval("("+fnSort+")"),fnMap=eval("("+fnMap+")");var selected=[],count=0;self.db.emit("view/refresh",!0,name,"");var onCallback=function(){fnSort&&selected.sort(fnSort);var e=self.views[name];void 0===e&&(e=self.getView(name),self.views[name]=e);var t=self.getFileName(name);e.operation(function(e){var r=function(){appendFile(t,selected,function(){self.db.emit("view/refresh",!1,name,count),schema.isReady=!0,fnCallback&&setImmediate(function(){fnCallback(count)}),e&&e()},self.db)};fs.exists(t,function(n){return n?void fs.unlink(t,function(t){return t?(self.db.emit("error",t,"view/refresh"),void(e&&e())):void r()}):void r()})})},onItem=function(e){var t=fnMap(e)||null;null!==t&&(count++,selected.push(t))};self.db.each(onItem,onCallback)},Views.prototype.create=function(e,t,r,n,o){var i=this;return typeof n===STRING&&(o=n,n=null),typeof t===STRING&&(t=filterPrepare(t)),i.db.meta.views[e]={map:t.toString(),sort:(r||"").toString(),isReady:!1},i.db._metaSave(),i.db.emit("view/create",!0,e,0),o&&i.db.changelog.insert(o),i.refresh(e,n),i},Views.prototype.getView=function(e){var t=this;return new View(t.db,e,t.getFileName(e))},Views.prototype.getFileName=function(e){var t=this;return path.join(t.directory,t.db.name+"#"+e+EXTENSION_VIEW)},View.prototype.read=function(e,t,r,n,o,i){var s=this,a=r||0,u=n||0;if(o=o||!1,s.status===STATUS_LOCKING||s.countRead>=MAX_READSTREAM)return s.pendingRead.push(function(){s.read(e,t,r,n,i)}),s;s.status=STATUS_READING,typeof e===STRING&&(e=filterPrepare(e)),null===e&&(e=function(e){return e}),s.db.emit("view",!0,s.name,0),s.countRead++;{var l=[],c="",p=0,f=!0,d=function(e){return c+=e},m=function(t,r){if(f&&(c="",!t)){var n=e(r);n!==!1&&null!==n&&void 0!==n&&(p++,a>0&&a>=p||(i||l.push(n===!0?r:n),u>0&&l.length===u&&(f=!1)))}};s.file.open(s.filename,MAX_BUFFER_SIZE,function(e){return o&&!f?(p=-1,!1):(onBuffer(e,m,d),f)},function(){s.countRead--,s.next(),setImmediate(function(){s.emit("view",!1,s.name,p),t(l,p)})})}return s},View.prototype.operation=function(e){var t=this;if(void 0!==e&&t.pendingOperation.push(e),t.status!==STATUS_UNKNOWN)return t;t.status=STATUS_LOCKING;var r=t.pendingOperation.shift();return r(function(){t.next()}),t},View.prototype.next=function(){var e=this;if(e.status=STATUS_UNKNOWN,e.countRead>0)return void(e.status=STATUS_READING);if(e.pendingOperation.length>0)return void e.operation();if(e.pendingRead.length>0){var t=e.pendingRead.length;t>MAX_READSTREAM&&(t=MAX_READSTREAM);for(var r=0;t>r;r++)e.pendingRead.shift()()}else;},Stored.prototype.create=function(e,t,r,n){if(typeof r===STRING){n=r,r=n}var o=this;return o.db.meta.stored[e]=t.toString(),o.db._metaSave(r),delete o.cache[e],n&&o.db.changelog.insert(n),o.db.emit("stored/create",e),o.db},Stored.prototype.remove=function(e,t,r){var n=this;if(typeof t===STRING){r=t,t=r}return r&&n.db.changelog.insert(r),delete n.cache[e],delete n.db.meta.stored[e],n.db._metaSave(t),n.db},Stored.prototype.clear=function(e,t){var r=this;if(typeof e===STRING){t=e,e=t}return t&&r.db.changelog.insert(t),r.cache={},r.db.meta.stored={},r.db._metaSave(e),r.db},Stored.prototype.execute=function(name,params,fnCallback,changes){var self=this,type=typeof params;if(type===FUNCTION&&(changes=fnCallback,fnCallback=params,params=null),typeof fnCallback===STRING){var tmp=changes;changes=fnCallback,fnCallback=tmp}changes&&self.db.changelog.insert(changes);var fn=self.db.meta.stored[name];if(void 0===fn)return void(fnCallback&&fnCallback());var cache=self.cache[name];return self.db.emit("stored",name),void 0===fn?void(fnCallback&&fnCallback()):(void 0===cache?(fn=eval("("+fn+")"),self.cache[name]=fn):fn=cache,void 0===fnCallback&&(fnCallback=function(){}),fn.call(self.db,self.db,fnCallback,params||null),self)},Binary.prototype.insert=function(e,t,r,n,o){typeof r===STRING&&(r=new Buffer(r,"base64")),typeof n===STRING&&(o=n,n=null);var i=this,s=r.length,a={width:0,height:0};i.check(),-1!==e.indexOf(".gif")?a=dimensionGIF(r):-1!==e.indexOf(".png")?a=dimensionPNG(r):-1!==e.indexOf(".jpg")&&(a=dimensionJPG(r));var u=new Buffer(BINARY_HEADER_LENGTH);u.fill(" "),u.write(JSON.stringify({name:e,size:s,type:t,width:a.width,height:a.height}));var l=(new Date).getTime().toString()+Math.random().toString(36).substring(10),c=i.db.name+"#"+l,p=fs.createWriteStream(path.join(i.directory,c+EXTENSION_BINARY));return p.write(u,"binary"),p.end(r),p=null,o&&i.db.changelog.insert(o),n&&n(l,u),l},Binary.prototype.update=function(e,t,r,n,o,i){typeof n===STRING&&(n=new Buffer(n,"base64")),typeof o===STRING&&(i=o,o=null);var s=this,a=n.length,u={width:0,height:0},l=e;s.check(),-1===l.indexOf("#")&&(l=s.db.name+"#"+l),-1!==t.indexOf(".gif")?u=dimensionGIF(n):-1!==t.indexOf(".png")?u=dimensionPNG(n):-1!==t.indexOf(".jpg")&&(u=dimensionJPG(n));var c=new Buffer(BINARY_HEADER_LENGTH);c.fill(" "),c.write(JSON.stringify({name:t,size:a,type:r,width:u.width,height:u.height}));var p=fs.createWriteStream(path.join(s.directory,l+EXTENSION_BINARY));return p.write(c,"binary"),p.end(n),p=null,i&&s.db.changelog.insert(i),o&&o(e,c),e},Binary.prototype.read=function(e,t){var r=this;r.check(),-1===e.indexOf("#")&&(e=r.db.name+"#"+e);var n=path.join(r.directory,e+EXTENSION_BINARY),o=fs.createReadStream(n,{start:0,end:BINARY_HEADER_LENGTH-1,encoding:"binary"});return o.on("error",function(e){t(e,null,null)}),o.on("data",function(e){var r=new Buffer(e,"binary").toString("utf8").replace(/^[\s]+|[\s]+$/g,"");o=fs.createReadStream(n,{start:BINARY_HEADER_LENGTH}),t(null,o,JSON.parse(r))}),r.db},Binary.prototype.remove=function(e,t,r){var n=this,o=e;n.check(),-1===o.indexOf("#")&&(o=n.db.name+"#"+o);var i=path.join(n.directory,o+EXTENSION_BINARY);return typeof t===STRING&&(r=t,t=null),fs.exists(i,function(e){return r&&n.db.changelog.insert(r),e?void fs.unlink(i,function(){t&&t(!0)}):void(t&&t(!1))}),n.db},Binary.prototype.check=function(){var e=this;return e.exists?e:(e.exists=!0,fs.existsSync(e.directory)?e:(fs.mkdirSync(e.directory),e))},Changelog.prototype.insert=function(e){var t=this;if(!t.db.changes)return t.db;if(void 0===e)return t.db;if(e instanceof Array||(e=[e||""]),0===e.length)return t.db;var r="",n=new Date,o=n.getFullYear(),i=(n.getMonth()+1).toString(),s=n.getDate().toString(),a=n.getHours().toString(),u=n.getMinutes().toString(),l=n.getSeconds().toString();1===i.length&&(i="0"+i),1===s.length&&(s="0"+s),1===u.length&&(u="0"+u),1===a.length&&(a="0"+a),1===l.length&&(l="0"+l);var c=o+"-"+i+"-"+s+" "+a+":"+u+":"+l;return e.forEach(function(e){r+=c+" | "+e+NEWLINE,t.db.emit("change",e)}),fs.appendFile(t.filename,r,function(){}),t.db},Changelog.prototype.read=function(e){var t=this;return fs.exists(t.filename,function(r){return r?void fs.readFile(t.filename,function(t,r){if(t)return void e([]);var n=r.toString("utf8").split("\n");""===n[n.length-1]&&n.pop(),e(n)}):void e([])}),t.db},Changelog.prototype.clear=function(e){var t=this;return fs.exists(t.filename,function(r){return r?void fs.unlink(t.filename,function(t){return t?void(e&&e(!1)):void(e&&e(!0))}):void(e&&e(!1))}),t.db},FileReader.prototype.open=function(e,t,r,n){var o=this;fs.open(e,"r",function(e,i){if(e)return void n(!1);t=t||1024;var s=function a(e,s){return e?(fs.close(i),i=null,void n(!0)):void o.read(i,s+t,t,r,a)};o.read(i,0,t,r,s)})},FileReader.prototype.read=function(e,t,r,n,o){var i=new Buffer(r);fs.read(e,i,0,r,t,function(e,s){var a=s!==r,u=i.toString("utf8",0,s);if(a)return u=u.replace(/\s+$/g,""),u[u.length-1]!==NEWLINE&&(u+=NEWLINE),n(u),void o(!0);try{a=!n(u)}catch(e){a=!0}setImmediate(function(){o(a,t,r)})})};var sof={192:!0,193:!0,194:!0,195:!0,197:!0,198:!0,199:!0,201:!0,202:!0,203:!0,205:!0,206:!0,207:!0};return exports.database=Database,exports.load=exports.open=exports.nosql=exports.init=function(e,t,r){return new Database(e,t,r)},module}({exports:{}}),function(e){function t(){this.debug=!1,this.Message=n,this.Mail=n}function r(e,t){p.resolveMx(e,function(r,n){function o(e){if(e>=n.length)return void t(new Error(h.connection));var r=u.createConnection(25,n[e].exchange);r.on("error",function(){o(++e)}),r.on("connect",function(){r.removeAllListeners("error"),t(null,r)})}return r?void t(r,n):n&&0!==n.length?(n.sort(function(e,t){return e.priority<t.priority}),void o(0)):void t(new Error(h.resolve+e))})}function n(e,t){this.subject=e||"",this.body=t||"",this.files=[],this.addressTo=[],this.addressReply=[],this.addressCC=[],this.addressBCC=[],this.addressFrom={name:"",address:""},this.callback=null}function o(e){for(var t=0,r="",n=e.length;n>t;){var o=t+68;o>n&&(o=n),r+=e.substring(t,o)+"\n",t=o}return r}function i(e){return e.substring(e.indexOf("@")+1)}function s(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1).toUpperCase()}function a(){return s()+s()+"-"+s()+"-"+s()+"-"+s()+"-"+s()+s()+s()}e.exports;global.framework_mail=e.exports;var u=require("net"),l=require("tls"),c=require("events"),p=require("dns"),f=require("fs"),d=require("path"),m="\r\n",h={notvalid:"E-mail address is not valid",resolve:"Cannot resolve MX of ",connection:"Cannot connect to any SMTP server."};t.prototype=new c.EventEmitter,t.prototype.create=function(e,t){return new n(e,t)},n.prototype.sender=function(e,t){return this.from(e,t)},n.prototype.from=function(e,t){if(!e.isEmail())throw new Error(h.notvalid);var r=this;return r.addressFrom.name=t||"",r.addressFrom.address=e,r},n.prototype.to=function(e){if(!e.isEmail())throw new Error(h.notvalid);var t=this;return t.addressTo.push(e),t},n.prototype.cc=function(e){if(!e.isEmail())throw new Error(h.notvalid);var t=this;return t.addressCC.push(e),t},n.prototype.bcc=function(e){if(!e.isEmail())throw new Error(h.notvalid);var t=this;return t.addressBCC.push(e),t},n.prototype.reply=function(e){if(!e.isEmail())throw new Error(h.notvalid);var t=this;return t.addressReply.push(e),t},n.prototype.attachment=function(e,t){var r=this;return void 0===t&&(t=d.basename(e)),r.files.push({name:t,filename:e,contentType:framework_utils.getContentType(d.extname(t))}),r},n.prototype.send=function(e,t,n){var o=this;if(e=e||null,"function"==typeof t){var s=n;n=t,t=s}if(o.callback=n,t=framework_utils.copy(t,{secure:!1,port:25,user:"",password:"",timeout:1e4}),null===e||""===e)return e=i(o.addressFrom.address),r(e,function(e,r){return e?(g.emit("error",e,o),void(n&&n(e))):(r.on("error",function(e){g.emit("error",e,o),n&&n(e)}),void o._send(r,t))}),o;var a;if(t.secure){var c=framework_utils.copy(t);c.host=e,a=l.connect(c,function(){o._send(this,t)})}else a=u.createConnection(t.port,e);return a.on("error",function(e){g.emit("error",e,o)}),a.on("clientError",function(e){g.emit("error",e,o)}),a.on("connect",function(){t.secure||o._send(a,t)}),o},n.prototype._send=function(e,t){var r=this,n="",u=[],l=[],c=i(r.addressFrom.address),p=new Date,f="--totaljs"+p.getTime(),d=!1,h=!1,v="",y=[],b=null,w=null;g.emit("send",r),e.setTimeout(t.timeout||5e3,function(){g.emit("error",new Error(framework_utils.httpStatus(408)),r),null!==e&&e.destroy(),e=null}),e.setEncoding("utf8");var k=function(t){g.debug&&console.log("SEND",t),e.write(t+m)};u.push("MAIL FROM: <"+r.addressFrom.address+">"),l.push("Message-ID: <"+a()+"@WIN-"+s()+">"),l.push("MIME-Version: 1.0"),l.push("From: "+(r.addressFrom.name.length>0?'"'+r.addressFrom.name+'" <'+r.addressFrom.address+">":r.addressFrom.address));var E=r.addressTo.length,S="";if(E>0){for(var T=0;E>T;T++){var _="<"+r.addressTo[T]+">";u.push("RCPT TO: "+_),S+=(""!==S?", ":"")+_}l.push("To: "+S),S=""}if(E=r.addressCC.length,E>0){for(var T=0;E>T;T++){var _="<"+r.addressCC[T]+">";u.push("RCPT TO: "+_),S+=(""!==S?", ":"")+_}l.push("Cc: "+S),S=""}if(E=r.addressBCC.length,E>0)for(var T=0;E>T;T++)u.push("RCPT TO: <"+r.addressBCC[T]+">");if(u.push("DATA"),u.push("QUIT"),u.push(""),l.push("Date: "+p.toUTCString()),l.push("Subject: "+r.subject),E=r.addressReply.length,E>0){for(var T=0;E>T;T++)S+=(""!==S?", ":"")+"<"+r.addressReply[T]+">";l.push("Reply-To: "+S),S=""}l.push("Content-Type: multipart/mixed; boundary="+f),l.push(""),l.push("--"+f),l.push("Content-Type: "+(-1!==r.body.indexOf("<")&&-1!==r.body.lastIndexOf(">")?"text/html":"text/plain")+"; charset=utf-8"),l.push("Content-Transfer-Encoding: base64"),l.push(""),l.push(o(new Buffer(r.body.replace(/\r\n/g,"\n").replace(/\n/g,"\r\n")).toString("base64"))),E=r.files.length,g.debug&&e.on("end",function(){console.log("END")}),e.on("data",function(t){for(var r=t.toString().split(m),n=r.length,o=0;n>o;o++){var i=r[o];""!==i&&e&&e.emit("line",i)}}),e.on("line",function(o){o=o.toUpperCase(),g.debug&&console.log("–––>",o);var i=parseInt(o.match(/\d+/)[0],10);if(250!==i||h||(-1!==o.indexOf("AUTH LOGIN PLAIN")||-1!==o.indexOf("AUTH PLAIN LOGIN")||t.user&&t.password)&&(v="plain",h=!0,-1===o.indexOf("XOAUTH")?(y.push("AUTH LOGIN"),y.push(new Buffer(t.user).toString("base64")),y.push(new Buffer(t.password).toString("base64"))):y.push("AUTH PLAIN "+new Buffer("\x00"+t.user+"\x00"+t.password).toString("base64"))),"-"!==o.substring(3,4))switch(!d&&h&&(d=!0,i=334),i){case 220:n=/\besmtp\b/i.test(o)?"EHLO":"HELO",k(n+" "+c);break;case 221:case 250:case 251:case 235:k(u.shift()),0===u.length&&(g.emit("success",r),r.callback&&r.callback(null),w=setTimeout(function(){null!==e&&e.destroy(),e=null},500));break;case 334:var s=y.shift();if(void 0===s){b=new Error("Forbidden."),g.emit("error",b,r),r.callback&&r.callback(b),null!==e&&e.destroy(),e=null;break}k(s);break;case 354:if(k(l.join(m)),r.files.length>0)return l=null,void r._writeAttachment(k,f,e);k("--"+f+"--"),k(""),k("."),l=null;break;default:if(400>i)break;b=new Error(o),null!==e&&e.destroy(),e=null,g.emit("error",b,r),r.callback&&r.callback(b)}})},n.prototype._writeAttachment=function(e,t,r){var n=this,o=n.files.shift();if(void 0===o)return e("--"+t+"--"),e(""),void e(".");{var i=o.name,s=f.createReadStream(o.filename,{encoding:"base64"}),a=[];d.extname(o.filename)}return a.push("--"+t),a.push('Content-Disposition: attachment; filename="'+i+'"'),a.push('Content-Type: application/octet-stream; name="'+i+'"'),a.push("Content-Transfer-Encoding: base64"),a.push(m),e(a.join(m)),s.on("data",function(t){for(var r=t.length,n=0,o=0;r>n;)n+=68,n>r&&(n=r),e(t.slice(o,n).toString("base64")),o=n}),s.on("end",function(){e(m),n._writeAttachment(e,t,r)}),n};var g=new t;return e.exports=g,e}({exports:{}}),function(module){function HttpFile(e,t,r,n,o,i,s){this.name=e,this.filename=t,this.length=n,this.contentType=o,this.path=r,this.width=i,this.height=s}function compile_autovendor(e){var t=/\n|\s{2,}/g,r=/\s?\{\s{1,}/g,n=/\s?\}\s{1,}/g,o=/\s?\:\s{1,}/g,i=/\s?\;\s{1,}/g,s="@#auto-vendor-prefix#@",a=e.startsWith(s);return a?e=e.replace(s,""):(s="/*auto*/",a=-1!==e.indexOf(s),a&&(e=e.replace(s,""))),a&&(e=autoprefixer(e)),e.replace(t,"").replace(r,"{").replace(n,"}").replace(o,":").replace(i,";").replace(/\s\}/g,"}").replace(/\s\{/g,"{").trim()
}function autoprefixer(e){var t=["appearance","column-count","column-gap","column-rule","display","transform","transform-style","transform-origin","transition","user-select","animation","perspective","animation-name","animation-duration","animation-timing-function","animation-delay","animation-iteration-count","animation-direction","animation-play-state","opacity","background","background-image","font-smoothing","text-size-adjust","backface-visibility","box-sizing"];e=autoprefixer_keyframes(e);for(var r,n=[],o=0,i=0;i<t.length;i++)for(r=t[i],o=0;-1!==o;)if(o=e.indexOf(r,o+1),-1!==o){var s=e.indexOf(";",o),a=e.indexOf("}",o),u=Math.min(s,a);if(-1===u&&(u=Math.max(s,a)),-1!==u){var l="-"===e.substring(o-1,o);if(!l){var c=e.substring(o,u);u=c.indexOf(":"),-1!==u&&c.substring(0,u+1).replace(/\s/g,"")===r+":"&&n.push({name:r,property:c})}}}for(var p=[],f=n.length,i=0;f>i;i++){var d=n[i].name;r=n[i].property;var m=r,h=";",g=m+h;if("opacity"!==d)if("background"!==d&&"background-image"!==d)if("text-overflow"!==d)if("display"!==d)g+="-webkit-"+m+h,g+="-moz-"+m,-1===d.indexOf("animation")&&(g+=h+"-ms-"+m),g+=h+"-o-"+m,e=e.replacer(r,"@[["+p.length+"]]"),p.push(g);else{if(-1===r.indexOf("box"))continue;g=m+h,g+=m.replacer("box","-webkit-box")+h,g+=m.replacer("box","-moz-box"),e=e.replacer(r,"@[["+p.length+"]]"),p.push(g)}else g=m+h,g+=m.replacer("text-overflow","-ms-text-overflow"),e=e.replacer(r,"@[["+p.length+"]]"),p.push(g);else{if(-1===r.indexOf("linear-gradient"))continue;g=m.replacer("linear-","-webkit-linear-")+h,g+=m.replacer("linear-","-moz-linear-")+h,g+=m.replacer("linear-","-o-linear-")+h,g+=m.replacer("linear-","-ms-linear-")+h,g+=m+h,e=e.replacer(r,"@[["+p.length+"]]"),p.push(g)}else{var v=parseFloat(m.replace("opacity","").replace(":","").replace(/\s/g,""));if(isNaN(v))continue;g+="filter:alpha(opacity="+Math.floor(100*v)+");",e=e.replacer(r,"@[["+p.length+"]]"),p.push(g)}}f=p.length;for(var i=0;f>i;i++)e=e.replacer("@[["+i+"]]",p[i]);return p=null,n=null,t=null,e}function autoprefixer_keyframes(e){for(var t=[],r=0;-1!==r;)if(r=e.indexOf("@keyframes",r+1),-1!==r){for(var n=0,o=-1,i=r+10;i<e.length;i++)if("{"===e[i]&&n++,"}"===e[i]){if(!(n>1)){o=i;break}n--}if(-1!==o){var s=e.substring(r,o+1);t.push({name:"keyframes",property:s})}}for(var a=[],u=t.length,l=0;u>l;l++){var c=t[l].name,p=t[l].property;if("keyframes"===c){var f=p.substring(1),d="\n",m="@"+f+d;m+="@-webkit-"+f+d,m+="@-moz-"+f+d,m+="@-o-"+f+d,e=e.replacer(p,"@[["+a.length+"]]"),a.push(m)}}u=a.length;for(var l=0;u>l;l++)e=e.replace("@[["+l+"]]",a[l]);return t=null,a=null,e}function JavaScript(e){function t(){u=13,r(3);for(;u!==p;)switch(u){case 32:r(a(l)?1:2);break;case 13:switch(l){case 123:case 91:case 40:case 43:case 45:r(1);break;case 32:r(3);break;default:r(a(l)?1:2)}break;default:switch(l){case 32:if(a(u)){r(1);break}r(3);break;case 13:switch(u){case 125:case 93:case 41:case 43:case 45:case 34:case 92:r(1);break;default:r(a(u)?1:3)}break;default:r(1)}}}function r(e){if(1>=e&&s(u),2>=e&&(u=l,39===u||34===u))for(;s(u),u=i(),u!==l;){if(13>=u)return void(c=p);92===u&&(s(u),u=i())}if(3>=e&&(l=n(),47===l&&(40===u||44===u||61===u||91===u||33===u||58===u||38===u||124===u||63===u||123===u||125===u||59===u||13===u))){for(s(u),s(l);u=i(),47!==u;){if(92===u)s(u),u=i();else if(13>=u)return void(c=p);s(u)}l=n()}}function n(){var e=i();if(47!==e)return e;switch(o()){case 47:for(;;)if(e=i(),13>=e)return e;break;case 42:for(i();;)switch(i()){case 42:if(47===o())return i(),32;break;case p:return void(e=p)}break;default:return e}return e}function o(){return d=i()}function i(){var t=d;return d=p,t===p&&(t=e.charCodeAt(m++),isNaN(t)&&(t=p)),t>=32||13===t||t===p?t:10===t?13:32}function s(e){f.push(13===e||10===e?" ":String.fromCharCode(e))}function a(e){return e>=97&&122>=e||e>=48&&57>=e||e>=65&&90>=e||95===e||36===e||92===e||e>126}var u,l,p=-1,f=[],d=p,m=0;return t(),f.join("")}function MultipartParser(){this.boundary=null,this.boundaryChars=null,this.lookbehind=null,this.state=S.PARSER_UNINITIALIZED,this.index=null,this.flags=0}function View(){}function view_parse(content,minify){function escaper(e){return e=compressHTML(e,minify),""===e?"$EMPTY":null!==e.match(/\n|\t|\r|\'|\\/)?DELIMITER_UNESCAPE+escape(e)+DELIMITER_UNESCAPE_END:DELIMITER+e+DELIMITER}content=removeComments(compressCSS(compressJS(content,0),0));var DELIMITER="'",DELIMITER_UNESCAPE="unescape('",DELIMITER_UNESCAPE_END="')",SPACE=" ",builder="var $EMPTY='';var $length=0;var $source=null;var $tmp=index;var $output=$EMPTY",command=view_find_command(content,0),compressed="";null===command&&(builder+="+"+escaper(content));for(var old=null,newCommand="",tmp="",index=0,counter=0,functions=[],functionsName=[],isFN=!1,isSECTION=!1,builderTMP="",sectionName="",isSitemap=!1;null!==command;){if(null!==old){var text=content.substring(old.end+1,command.beg);""!==text&&(view_parse_plus(builder)&&(builder+="+"),builder+=escaper(text))}else{var text=content.substring(0,command.beg);""!==text&&(view_parse_plus(builder)&&(builder+="+"),builder+=escaper(text))}var cmd=content.substring(command.beg+2,command.end),cmd8=cmd.substring(0,8);"section "===cmd8&&-1===cmd.lastIndexOf(")")?(builderTMP=builder,builder="+(function(){var $output=$EMPTY",sectionName=cmd.substring(8),isSECTION=!0,isFN=!0):"helper "===cmd.substring(0,7)?(builderTMP=builder,builder="function "+cmd.substring(7).trim()+"{var $output=$EMPTY",isFN=!0,functionsName.push(cmd.substring(7,cmd.indexOf("(",7)).trim())):"foreach "===cmd8?(counter++,-1!==cmd.indexOf("foreach var ")&&(cmd=cmd.replace(" var ",SPACE)),newCommand=(cmd.substring(8,cmd.indexOf(SPACE,8))||"").trim(),index=cmd.trim().indexOf(SPACE,newCommand.length+10),builder+="+(function(){var $source="+cmd.substring(index).trim()+";if (!($source instanceof Array) || source.length === 0)return $EMPTY;var $length=$source.length;var $output=$EMPTY;var index=0;for(var i=0;i<$length;i++){index = i;var "+newCommand+"=$source[i];$output+=$EMPTY"):"end"===cmd?isFN&&0>=counter?(counter=0,isSECTION?(builder=builderTMP+builder+";repository['$section_"+sectionName+"']=$output;return $EMPTY})()",builderTMP=""):(builder+=";return $output;}",functions.push(builder),builder=builderTMP,builderTMP=""),isSECTION=!1,isFN=!1):(counter--,builder+="}return $output;})()",newCommand=""):"if "===cmd.substring(0,3)?builder+=";if ("+cmd.substring(3)+"){$output+=$EMPTY":"else"===cmd?builder+="} else {$output+=$EMPTY":"endif"===cmd?builder+="}$output+=$EMPTY":(tmp=view_prepare(command.command,newCommand,functionsName),tmp.length>0&&(view_parse_plus(builder)&&(builder+="+"),builder+=tmp)),old=command,command=view_find_command(content,command.end),command&&command.command&&-1!==command.command.indexOf("sitemap(")&&(isSitemap=!0)}if(null!==old){var text=content.substring(old.end+1);text.length>0&&(builder+="+"+escaper(text))}var fn="(function(self,repository,model,session,get,post,url,global,helpers,user,config,functions,index,output,date){"+(isSitemap?"var sitemap = function() { return self.sitemap.apply(self, arguments);};":"")+(functions.length>0?functions.join("")+";":"")+"var controller=self;"+builder+";return $output;})";return eval(fn)}function view_parse_plus(e){var t=e[e.length-1];return"!"!==t&&"?"!==t&&"+"!==t&&"."!==t&&":"!==t?!0:!1}function view_prepare(e,t,r){var n=e.indexOf("."),o=e.indexOf("("),i=e.indexOf("["),s=[],a=0;-1!==n&&s.push(n),-1!==o&&s.push(o),-1!==i&&s.push(i);var u=Math.min.apply(this,s);-1===u&&(u=e.length);var l=e.substring(0,u);if(l===t)return"("+e+").toString().encode()";if("!"===l[0]&&l.substring(1)===t)return"("+e.substring(1)+").toString()";switch(l){case"foreach":case"end":return"";case"section":return a=e.indexOf("("),-1===a?"":"(repository['$section_"+e.substring(a+1,e.length-1).replace(/\'/g,"")+"'] || '')";case"log":case"LOG":return"("+("log"===l?"framework.":"")+e+"?$EMPTY:$EMPTY)";case"console":return"("+e+"?$EMPTY:$EMPTY)";case"model":case"repository":case"get":case"post":case"query":case"global":case"session":case"user":case"config":case"controller":return view_is_assign(e)?"self.$set("+e+")":"("+e+").toString().encode()";case"body":return view_is_assign(e)?"self.$set("+e+")":-1===e.lastIndexOf(".")?"output":"("+e+").toString().encode()";case"CONFIG":case"FUNCTION":case"MODEL":case"SCHEMA":case"MODULE":case"functions":return"("+e+").toString().encode()";case"!controller":case"!repository":case"!get":case"!post":case"!body":case"!query":case"!global":case"!session":case"!user":case"!config":case"!functions":case"!model":case"!CONFIG":case"!SCHEMA":case"!FUNCTION":case"!MODEL":case"!MODULE":return"("+e.substring(1)+")";case"resource":case"RESOURCE":return"(self."+e+").toString().encode()";case"!resource":case"!RESOURCE":return"(self."+e.substring(1)+")";case"host":case"hostname":return-1===e.indexOf("(")?"self.host()":"self."+e;case"url":return-1!==e.indexOf("(")?"self.$"+e:e="url";case"title":case"description":case"keywords":return-1!==e.indexOf("(")?"self.$"+e:"(repository['$"+e+"'] || '').toString().encode()";case"!title":case"!description":case"!keywords":return"(repository['$"+e.substring(1)+"'] || '')";case"head":return-1!==e.indexOf("(")?"self.$"+e:"self."+e+"()";case"sitemap":case"place":return-1!==e.indexOf("(")?"self.$"+e:"(repository['$"+e+"'] || '')";case"meta":return-1!==e.indexOf("(")?"self.$"+e:"self.$meta()";case"js":case"script":case"css":case"favicon":return"self.$"+e+(-1===e.indexOf("(")?"()":"");case"index":return"("+e+")";case"routeJS":case"routeCSS":case"routeImage":case"routeFont":case"routeDownload":case"routeVideo":case"routeStatic":return"self."+e;case"json":case"image":case"layout":case"template":case"templateToggle":case"view":case"viewToggle":case"helper":case"download":case"selected":case"currentContent":case"currentCSS":case"currentDownload":case"currentImage":case"currentJS":case"currentTemplate":case"currentVideo":case"currentView":case"disabled":case"checked":case"etag":case"header":case"modified":case"options":case"readonly":case"canonical":case"dns":case"next":case"prefetch":case"prerender":case"prev":return"self.$"+e;case"radio":case"text":case"checkbox":case"hidden":case"textarea":case"password":return"self.$"+exports.appendModel(e);default:return framework.helpers[l]?"helpers."+view_insert_call(e):-1===r.indexOf(l)?"!"===e[0]?e.substring(1)+".toString()":e+".toString().encode()":e+".toString()"}return e}function view_insert_call(e){var t=e.indexOf("(");if(-1===t)return e;for(var r=e.length,n=0,o=t+1;r>o;o++){var i=e[o];if("("===i||")"===i)if("("!==i){if(!(n>0)){var s=e.substring(t+1);return e.substring(0,t)+".call(self"+(s.length>1?","+s:")")}n--}else n++}return e}function view_is_assign(e){for(var t=e.length,r=0,n=0;t>n;n++){var o=e[n];if("["!==o)if("]"!==o){var i=e[n+1]||"";if("+"===o&&("+"===i||"="===i)&&0===r)return!0;if("-"===o&&("-"===i||"="===i)&&0===r)return!0;if("*"===o&&("*"===i||"="===i)&&0===r)return!0;if("="===o&&0===r)return!0}else r--;else r++}return!1}function view_find_command(e,t){var t=e.indexOf("@{",t);if(-1===t)return null;for(var r=e.length,n=0,o=t+2;r>o;o++){var i=e[o];if("{"!==i){if("}"===i){if(!(n>0))return{beg:t,end:o,command:e.substring(t+2,o).trim()};n--}}else n++}return null}function removeCondition(e,t){if(t){if("+"===e[0])return e.substring(1,e.length)}else if("+"===e[e.length-1])return e.substring(0,e.length-1);return e}function removeComments(e){for(var t="<!--",r="-->",n=e.indexOf(t),o=0;-1!==n&&(o=e.indexOf(r,n+4),-1!==o);){var i=e.substring(n,o+3);-1===i.indexOf("[if")&&-1===i.indexOf("[endif")?(e=e.replacer(i,""),n=e.indexOf(t,o+3)):n=e.indexOf(t,o+3)}return e}function compressJS(e,t){var r='<script type="text/javascript">',n="</script>",o=e.indexOf(r,t||0);if(-1===o&&(r="<script>",o=e.indexOf(r,t||0),-1===o))return e;var i=e.indexOf(n,o+r.length);if(-1===i)return e;var s=e.substring(o,i+n.length).trim(),a=e.indexOf(s);if(-1===a)return e;var u=s.substring(r.length,s.length-n.length).trim(),l=exports.compile_javascript(u);return e=e.replacer(s,r+l.dollar().trim()+n.trim()),compressJS(e,o+l.length+9)}function compressCSS(e,t){var r='<style type="text/css">',n="</style>",o=e.indexOf(r,t||0);if(-1===o&&(r="<style>",o=e.indexOf(r,t||0),-1===o))return e;var i=e.indexOf(n,o+r.length);if(-1===i)return e;var s=e.substring(o,i+n.length),a=s.substring(r.length,s.length-n.length).trim(),u=exports.compile_css(a,!0);return e=e.replacer(s,(r+u.trim()+n).trim()),compressCSS(e,o+u.length+8)}function compressHTML(e,t){if(null===e||""===e||!t)return e;e=removeComments(e);for(var r=["script","textarea","pre","code"],n="["+(new Date).getTime()+"]#",o={},i=0,s=r.length,a=0;s>a;a++)for(var u=r[a],l="<"+u,c="</"+u,p=e.indexOf(l),f=0,d=c.length;-1!==p&&(f=e.indexOf(c,p+3),-1!==f);){var m=n+i++,h=e.substring(p,f+d);if(0===a){if(f=h.indexOf(">"),d=h.indexOf('type="text/template"'),f>d&&-1!==d)break;if(d=h.indexOf('type="text/html"'),f>d&&-1!==d)break;if(d=h.indexOf('type="text/ng-template"'),f>d&&-1!==d)break}o[m]=h,e=e.replacer(h,m),p=e.indexOf(l,p+l.length)}e=e.replace(REG_1,"").replace(REG_2,"");var g=Object.keys(o);s=g.length;for(var a=0;s>a;a++){var m=g[a];e=e.replacer(m,o[m])}return e}var exports=module.exports;global.framework_internal=module.exports;var crypto=require("crypto"),fs=require("fs"),ENCODING="utf8",UNDEFINED="undefined",FUNCTION="function",OBJECT="object",REG_1=/[\n\r\t]+/g,REG_2=/\s{3,}/g,HTTPVERBS={GET:!0,POST:!0,OPTIONS:!0,PUT:!0,DELETE:!0,PATCH:!0,upload:!0,HEAD:!0,TRACE:!0,PROPFIND:!0};exports.parseMULTIPART=function(e,t,r,n,o,i){var s=new MultipartParser,a=t.split(";")[1],u=0,l=null,c={name:"",value:"",contentType:"",fileName:"",fileNameTmp:"",fileSize:0,isFile:!1,step:0,width:0,height:0},p=e.ip.replace(/\./g,""),f=0,d=!1,m=null;a=a.substring(a.indexOf("=")+1),e.buffer_exceeded=!1,e.buffer_has=!0,s.initWithBoundary(a),s.onPartBegin=function(){c.value="",c.fileSize=0,c.step=0,c.isFile=!1},s.onHeaderValue=function(t,r,o){if(!e.buffer_exceeded&&!d){var i=t.slice(r,o).toString(ENCODING).split(";");return 1===c.step?(c.contentType=i[0],void(c.step=2)):void(0===c.step&&(c.name=i[1].substring(i[1].indexOf("=")+2),c.name=c.name.substring(0,c.name.length-1),c.step=1,3===i.length&&(c.fileName=i[2].substring(i[2].indexOf("=")+2),c.fileName=c.fileName.substring(0,c.fileName.length-1),c.isFile=!0,c.fileNameTmp=framework_utils.combine(n,p+"-"+(new Date).getTime()+"-"+framework_utils.random(1e5)+".upload"),l=fs.createWriteStream(c.fileNameTmp,{flags:"w"}),l.once("close",function(){f--}),l.once("error",function(){f--}),f++)))}},s.onPartData=function(t,n,o){if(!e.buffer_exceeded&&!d){var i=t.slice(n,o),s=i.length;if(u+=s,u>=r)return e.buffer_exceeded=!0,void(null===m?m=[c.fileNameTmp]:m.push(c.fileNameTmp));if(!c.isFile)return void(c.value+=i.toString(ENCODING));if(0===c.fileSize){var a=null;switch(c.contentType){case"image/jpeg":a=framework_image.measureJPG(i);break;case"image/gif":a=framework_image.measureGIF(i);break;case"image/png":a=framework_image.measurePNG(i)}a&&(c.width=a.width,c.height=a.height)}l.write(i),c.fileSize+=s}},s.onPartEnd=function(){if(null!==l&&(l.end(),l=null),!e.buffer_exceeded){if(c.isFile)return void e.files.push(new HttpFile(c.name,c.fileName,c.fileNameTmp,c.fileSize,c.contentType,c.width,c.height));o(c.value)&&(d=!0);var t=e.body[c.name];if(void 0===t)return void(e.body[c.name]=c.value);if(framework_utils.isArray(t))return void e.body[c.name].push(c.value);t=[t],t.push(c.value),e.body[c.name]=t}},s.onEnd=function(){var t=function(){return f>0?void setImmediate(t):(d&&(e.flags.push("xss"),framework.stats.request.xss++),null!==m&&framework.unlink(m),void i())};t()},e.on("data",s.write.bind(s)),e.on("end",s.end.bind(s))},exports.parseMULTIPART_MIXED=function(e,t,r,n,o){var i=new MultipartParser,s=t.split(";")[1],a=null,u={name:"",contentType:"",fileName:"",fileNameTmp:"",fileSize:0,isFile:!1,step:0,width:0,height:0},l=e.ip.replace(/\./g,""),c=0;s=s.substring(s.indexOf("=")+1),e.buffer_exceeded=!1,e.buffer_has=!0,i.initWithBoundary(s),i.onPartBegin=function(){u.fileSize=0,u.step=0,u.isFile=!1},i.onHeaderValue=function(t,n,o){if(!(e.buffer_exceeded||u.step>1)){var i=t.slice(n,o).toString(ENCODING).split(";");if(1===u.step)return u.contentType=i[0],void(u.step=2);if(0===u.step){if(u.name=i[1].substring(i[1].indexOf("=")+2),u.name=u.name.substring(0,u.name.length-1),u.step=1,3!==i.length)return;return u.fileName=i[2].substring(i[2].indexOf("=")+2),u.fileName=u.fileName.substring(0,u.fileName.length-1),u.isFile=!0,u.fileNameTmp=framework_utils.combine(r,l+"-"+(new Date).getTime()+"-"+framework_utils.random(1e5)+".upload"),a=fs.createWriteStream(u.fileNameTmp,{flags:"w"}),a.on("close",function(){c--}),a.on("error",function(){c--}),void c++}}},i.onPartData=function(e,t,r){var n=e.slice(t,r),o=n.length;if(u.isFile){if(0===u.fileSize){var i=null;switch(u.contentType){case"image/jpeg":i=framework_image.measureJPG(n);break;case"image/gif":i=framework_image.measureGIF(n);break;case"image/png":i=framework_image.measurePNG(n)}i&&(u.width=i.width,u.height=i.height)}a.write(n),u.fileSize+=o}},i.onPartEnd=function(){null!==a&&(a.end(),a=null),u.isFile&&n(new HttpFile(u.name,u.fileName,u.fileNameTmp,u.fileSize,u.contentType,u.width,u.height))},i.onEnd=function(){var e=function t(){return c>0?void setImmediate(t):(n(null),void o())};e()},e.on("data",i.write.bind(i))},exports.routeSplit=function(e,t){t||(e=e.toLowerCase()),"/"===e[0]&&(e=e.substring(1)),"/"===e[e.length-1]&&(e=e.substring(0,e.length-1));var r=e.split("/");return 1===r.length&&""===r[0]&&(r[0]="/"),r},exports.routeCompare=function(e,t,r,n){var o=e.length,i=t.length;if(i!==o&&!n)return!1;for(var s=1===o&&"/"===e[0],a=0;o>a;a++){var u=t[a];if(!r&&n&&void 0===u)return!0;if((r||s||"{"!==u[0])&&e[a]!==u)return r?!1:n?a===i:!1}return!0},exports.routeCompareSubdomain=function(e,t){return null===t||null===e||0===t.length?!0:t.indexOf(e)>-1},exports.routeCompareFlags=function(e,t,r){for(var n=!1,o=e,i=t,s=e.length,a=t.length,u=s>a?o:i,l=s>a?i:o,c=Math.max(s,a),p="authorize",f="unauthorize",d=0;c>d;d++){var m=u[d],h=m[0];if("!"!==h&&"#"!==h&&"$"!==h&&"@"!==h&&"+"!==h&&(!r||m!==p&&m!==f)){var g=l.indexOf(m),v=m.toUpperCase();if(-1===g&&!HTTPVERBS[v])return m===p||m===f?-1:0;n=n||-1!==g&&HTTPVERBS[v]}}return n?1:0},exports.routeCompareFlags2=function(e,t,r){if(t.isXHR&&!e.xhr)return 0;var n=e.method;if(t.method){if(t.method!==n)return 0}else if(-1===t.flags.indexOf(n.toLowerCase()))return 0;if(t.isREFERER&&-1===e.flags.indexOf("referer"))return 0;for(var o=0,i=e.flags.length;i>o;o++){var s=e.flags[o];switch(s){case"proxy":if(!t.isPROXY)return 0;continue;case"debug":if(!t.isDEBUG&&t.isRELEASE)return 0;continue;case"release":if(!t.isRELEASE&&t.isDEBUG)return 0;continue;case"referer":continue;case"upload":if(!t.isUPLOAD)return 0;continue;case"https":if(!t.isHTTPS&&t.isHTTP)return 0;continue;case"http":if(!t.isHTTP&&t.isHTTPS)return 0;continue;case"xhr":case"+xhr":if(!t.isBOTH&&!t.isXHR)return 0;continue}if(!r||!t.isMEMBER){var a=t.flags.indexOf(s);if(-1===a)return t.isMEMBER?0:-1}}return 1},exports.routeParam=function(e,t){var r=[];if(!t||!e)return r;var n=t.param.length;if(0===n)return r;for(var o=0;n>o;o++){var i=e[t.param[o]];r.push("/"===i?"":i)}return r},HttpFile.prototype.copy=function(e,t){var r=this;if(!t)return void fs.createReadStream(r.path).pipe(fs.createWriteStream(e));var n=fs.createReadStream(r.path),o=fs.createWriteStream(e);return n.on("close",t),n.pipe(o),r},HttpFile.prototype.readSync=function(){return fs.readFileSync(this.path)},HttpFile.prototype.read=function(e){var t=this;return fs.readFile(t.path,e),t},HttpFile.prototype.md5=function(e){var t=this,r=crypto.createHash("md5"),n=fs.createReadStream(t.path);return n.on("data",function(e){r.update(e)}),n.on("error",function(t){e(t,null)}),n.on("end",function(){e(null,r.digest("hex"))}),t},HttpFile.prototype.stream=function(e){var t=this;return fs.createReadStream(t.path,e)},HttpFile.prototype.pipe=function(e,t){var r=this;return fs.createReadStream(r.path,t).pipe(e,t)},HttpFile.prototype.isImage=function(){var e=this;return-1!==e.contentType.indexOf("image/")},HttpFile.prototype.isVideo=function(){var e=this;return-1!==e.contentType.indexOf("video/")},HttpFile.prototype.isAudio=function(){var e=this;return-1!==e.contentType.indexOf("audio/")},HttpFile.prototype.image=function(e){var t=e;return void 0===t&&(t="im"===framework.config["default-image-converter"]),framework_image.init(this.path,t)},exports.compile_css=function(e){if(null!==framework.onCompileCSS)return framework.onCompileCSS("",e);try{return compile_autovendor(e)}catch(t){return framework.error(new Error("JS CSS exception: "+t.message)),""}},exports.compile_javascript=function(e){var t=typeof framework===OBJECT;try{return t&&null!==framework.onCompileJS?framework.onCompileJS("",e):JavaScript(e)}catch(r){return t&&framework.error(r,"JavaScript compressor"),e}},exports.compile_html=function(e){return compressHTML(e,!0)};var Buffer=require("buffer").Buffer,s=0,S={PARSER_UNINITIALIZED:s++,START:s++,START_BOUNDARY:s++,HEADER_FIELD_START:s++,HEADER_FIELD:s++,HEADER_VALUE_START:s++,HEADER_VALUE:s++,HEADER_VALUE_ALMOST_DONE:s++,HEADERS_ALMOST_DONE:s++,PART_DATA_START:s++,PART_DATA:s++,PART_END:s++,END:s++},f=1,F={PART_BOUNDARY:f,LAST_BOUNDARY:f*=2},LF=10,CR=13,SPACE=32,HYPHEN=45,COLON=58,A=97,Z=122,lower=function(e){return 32|e};for(s in S)exports[s]=S[s];return exports.MultipartParser=MultipartParser,MultipartParser.stateToString=function(e){for(var t in S){var r=S[t];if(r===e)return t}},MultipartParser.prototype.initWithBoundary=function(e){var t=this;t.boundary=new Buffer(e.length+4),framework.versionNode>=1111?(t.boundary.write("\r\n--",0,"ascii"),t.boundary.write(e,4,"ascii")):(t.boundary.write("\r\n--","ascii",0),t.boundary.write(e,"ascii",4)),t.lookbehind=new Buffer(t.boundary.length+8),t.state=S.START,t.boundaryChars={};for(var r=0;r<t.boundary.length;r++)t.boundaryChars[t.boundary[r]]=!0},MultipartParser.prototype.write=function(e){var t,r,n=this,o=0,i=e.length,s=n.index,a=n.index,u=n.state,l=n.flags,c=n.lookbehind,p=n.boundary,f=n.boundaryChars,d=n.boundary.length,m=d-1,h=e.length,g=function(e){n[e+"Mark"]=o},v=function(e){delete n[e+"Mark"]},y=function(e,t,r,o){if(void 0===r||r!==o){var i="on"+e.substr(0,1).toUpperCase()+e.substr(1);i in n&&n[i](t,r,o)}},b=function(t,r){var i=t+"Mark";i in n&&(r?(y(t,e,n[i],o),delete n[i]):(y(t,e,n[i],e.length),n[i]=0))};for(o=0;i>o;o++)switch(t=e[o],u){case S.PARSER_UNINITIALIZED:return o;case S.START:a=0,u=S.START_BOUNDARY;case S.START_BOUNDARY:if(a==p.length-2){if(t==HYPHEN)l|=F.LAST_BOUNDARY;else if(t!=CR)return o;a++;break}if(a-1==p.length-2){if(l&F.LAST_BOUNDARY&&t==HYPHEN)y("end"),u=S.END,l=0;else{if(l&F.LAST_BOUNDARY||t!=LF)return o;a=0,y("partBegin"),u=S.HEADER_FIELD_START}break}t!=p[a+2]&&(a=-2),t==p[a+2]&&a++;break;case S.HEADER_FIELD_START:u=S.HEADER_FIELD,g("headerField"),a=0;case S.HEADER_FIELD:if(t==CR){v("headerField"),u=S.HEADERS_ALMOST_DONE;break}if(a++,t==HYPHEN)break;if(t==COLON){if(1==a)return o;b("headerField",!0),u=S.HEADER_VALUE_START;break}if(r=lower(t),A>r||r>Z)return o;break;case S.HEADER_VALUE_START:if(t==SPACE)break;g("headerValue"),u=S.HEADER_VALUE;case S.HEADER_VALUE:t==CR&&(b("headerValue",!0),y("headerEnd"),u=S.HEADER_VALUE_ALMOST_DONE);break;case S.HEADER_VALUE_ALMOST_DONE:if(t!=LF)return o;u=S.HEADER_FIELD_START;break;case S.HEADERS_ALMOST_DONE:if(t!=LF)return o;y("headersEnd"),u=S.PART_DATA_START;break;case S.PART_DATA_START:u=S.PART_DATA,g("partData");case S.PART_DATA:if(s=a,0===a){for(o+=m;h>o&&!(e[o]in f);)o+=d;o-=m,t=e[o]}if(a<p.length)p[a]==t?(0===a&&b("partData",!0),a++):a=0;else if(a==p.length)a++,t==CR?l|=F.PART_BOUNDARY:t==HYPHEN?l|=F.LAST_BOUNDARY:a=0;else if(a-1==p.length)if(l&F.PART_BOUNDARY){if(a=0,t==LF){l&=~F.PART_BOUNDARY,y("partEnd"),y("partBegin"),u=S.HEADER_FIELD_START;break}}else l&F.LAST_BOUNDARY&&t==HYPHEN?(y("partEnd"),y("end"),u=S.END,l=0):a=0;a>0?c[a-1]=t:s>0&&(y("partData",c,0,s),s=0,g("partData"),o--);break;case S.END:break;default:return o}return b("headerField"),b("headerValue"),b("partData"),n.index=a,n.state=u,n.flags=l,i},MultipartParser.prototype.end=function(){var e=this,t=function(e,t){var r="on"+t.substr(0,1).toUpperCase()+t.substr(1);r in e&&e[r]()};if(e.state==S.HEADER_FIELD_START&&0===e.index||e.state==S.PART_DATA&&e.index==e.boundary.length)t(e,"partEnd"),t(e,"end");else if(e.state!=S.END)return t(e,"partEnd"),t(e,"end"),new Error("MultipartParser.end(): stream ended unexpectedly: "+e.explain())},MultipartParser.prototype.explain=function(){return"state = "+MultipartParser.stateToString(this.state)},View.prototype.read=function(e){var t=framework.config,r="."===e[0],n=r?e.substring(1):framework_utils.combine(t["directory-views"],e);if(fs.existsSync(n))return view_parse(fs.readFileSync(n).toString("utf8"),t["allow-compile-html"]);if(r)return null;var o=e.lastIndexOf("/");return-1===o?null:(n=framework_utils.combine(t["directory-views"],e.substring(o+1)),fs.existsSync(n)?view_parse(fs.readFileSync(n).toString("utf8"),t["allow-compile-html"]):null)},View.prototype.load=function(e,t){var r=this;if(-1!==e.indexOf("@{")||-1!==e.indexOf("<"))return r.dynamic(e);var n=framework.routes.views[e];n?t="."+n.filename:t+=".html";var o="view#"+t,i=framework.temporary.views[o]||null;return null!==i?i:(i=r.read(t),framework.isDebug||(framework.temporary.views[o]=i),i)},View.prototype.dynamic=function(e){var t=e.md5(),r=framework.temporary.views[t]||null;return null!==r?r:(r=view_parse(e,framework.config["allow-compile-html"]),framework.isDebug||(framework.temporary.views[t]=r),r)},exports.generateView=function(e,t){return(new View).load(e,t)},exports.appendModel=function(e){var t=e.indexOf("(");if(-1===t)return e;var r=e.substring(t+1);return e.substring(0,t)+"(model"+(")"===r[0]?r:","+r)},module}({exports:{}});var qs=require("querystring"),os=require("os"),fs=require("fs"),zlib=require("zlib"),path=require("path"),crypto=require("crypto"),parser=require("url"),events=require("events"),sys=require("sys"),http=require("http"),directory=process.cwd(),child=require("child_process"),util=require("util"),ENCODING="utf8",UNDEFINED="undefined",STRING="string",TYPE_FUNCTION="function",NUMBER="number",OBJECT="object",BOOLEAN="boolean",REQUEST_COMPRESS_EXTENSION=["js","css","txt"],EXTENSION_JS=".js",EXTENSION_COFFEE=".coffee",RESPONSE_HEADER_CACHECONTROL="Cache-Control",RESPONSE_HEADER_CONTENTTYPE="Content-Type",RESPONSE_HEADER_CONTENTLENGTH="Content-Length",CONTENTTYPE_TEXTPLAIN="text/plain",CONTENTTYPE_TEXTHTML="text/html",REQUEST_COMPRESS_CONTENTTYPE=[CONTENTTYPE_TEXTPLAIN,"text/javascript","text/css","application/x-javascript",CONTENTTYPE_TEXTHTML],_controller="",_test="";global.framework_internal||(global.framework_internal=require("./internal")),global.framework_builders||(global.framework_builders=require("./builders")),global.framework_utils||(global.framework_utils=require("./utils")),global.framework_mail||(global.framework_mail=require("./mail")),global.framework_image||(global.framework_image=require("./image")),global.framework_nosql||(global.framework_nosql=require("./nosql")),global.Builders=global.builders=framework_builders;var utils=global.Utils=global.utils=framework_utils;global.Mail=global.MAIL=framework_mail,global.include=global.INCLUDE=global.source=global.SOURCE=function(e,t){return framework.source(e,t)},global.MODULE=function(e){return framework.module(e)},global.DATABASE=function(){return typeof framework.database===OBJECT?framework.database:framework.database.apply(framework,arguments)},global.CONFIG=function(e){return framework.config[e]},global.INSTALL=function(e,t,r,n,o){return framework.install(e,t,r,n,o)},global.UNINSTALL=function(e,t,r){return framework.uninstall(e,t,r)},global.RESOURCE=function(e,t){return framework.resource(e,t)},global.LOG=function(){return framework.log.apply(framework,arguments)},global.MODEL=function(e){return framework.model(e)},global.SCHEMA=function(e){return Builders.schema(e)},global.FUNCTION=function(e){return framework.functions[e]},typeof setImmediate===UNDEFINED&&(global.setImmediate=function(e){process.nextTick(e)}),Framework.prototype={get async(){var e=this;return typeof e._async===UNDEFINED&&(e._async=new utils.Async(e)),e._async}},Framework.prototype.__proto__=new events.EventEmitter,Framework.prototype.refresh=function(){var e=this;return e.emit("clear","refresh"),e.resources={},e.databases={},e._configure(),e._configure_versions(),e.temporary.path={},e.temporary.range={},e.temporary.views={},e.temporary.other={},e.emit("reconfigure"),e},Framework.prototype.controller=function(e){return this.controllers[e]||null},Framework.prototype._routesSort=function(){var e=this;return e.routes.web.sort(function(e,t){return e.priority>t.priority?-1:e.priority<t.priority?1:0}),e.routes.websockets.sort(function(e,t){return e.priority>t.priority?-1:e.priority<t.priority?1:0}),e},Framework.prototype.database=function(e){var t=this,r=t.databases[e];return void 0!==r?r:(t._verify_directory("databases"),r=framework_nosql.load(path.join(directory,this.config["directory-databases"],e),path.join(directory,this.config["directory-databases"],e+"-binary"),!0),t.databases[e]=r,r)},Framework.prototype.stop=function(e){var t=this;return typeof process.send===TYPE_FUNCTION&&process.send("stop"),t.cache.stop(),t.server.close(),process.exit(e||0),t},Framework.prototype.redirect=function(e,t,r,n){var o=this;return"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),"/"===t[t.length-1]&&(t=t.substring(0,t.length-1)),o.routes.redirects[e]={url:t,path:r,permanent:n},o._request_check_redirect=!0,o},Framework.prototype.resize=function(e,t,r,n,o,i){var s=this,a=null,u=e.lastIndexOf(".");a=-1!==u?[e.substring(u)]:i||[".jpg",".png",".gif"];for(var l=a.length,c=0;l>c;c++)a[c]=("."!==a[c][0]?".":"")+a[c].toLowerCase();return u=e.lastIndexOf("/"),-1!==u&&(e=e.substring(0,u)),"/"!==e[0]&&(e="/"+e),"/"!==e[e.length-1]&&(e+="/"),o=o||e,n||(n={}),s.routes.resize[e]={width:t,height:r,extension:a,path:o||e,grayscale:n.grayscale,blur:n.blur,rotate:n.rotate,flip:n.flip,flop:n.flop,sepia:n.sepia,quality:n.quality},s},Framework.prototype.route=function(e,t,r,n,o,i,s){if(""===e&&(e="/"),utils.isArray(n)){var a=o;o=n,n=a}var u=typeof t,l=0;if(u===OBJECT||t instanceof Array){var a=t;t=r,r=a}if(u===STRING){var c=t;t=function(){this.view(c)}}else if(typeof t!==TYPE_FUNCTION){var c=e;c.endsWith("/")&&(c=c.substring(0,c.length-1)),l=c.lastIndexOf("/"),-1!==l&&(c=c.substring(l+1)),(""===c||"/"===c)&&(c="index"),t=function(){this.view(c)}}utils.isArray(r)||"object"!=typeof r||(n=r.max||r.length||r.maximum||r.maximumSize||r.size,o=r.middleware||r.partials||r.partial,i=r.timeout,s=r.options,r=r.flags||r.flag);var p=this,f=0,d=null,m=-1!==e.indexOf("*");l=e.indexOf("]"),f=e.count("/"),m&&(e=e.replace("*","").replace("//","/"),f=-10-f),l>0&&(d=e.substring(1,l).trim().toLowerCase().split(","),e=e.substring(l+1),f+=2);var h=!1,g=!1,v="";if(r){for(var a=[],y=0,b=0;b<r.length;b++)if("#"!==r[b][0]){y++;var w=r[b].toString().toLowerCase();switch(w){case"noxhr":case"-xhr":g=!0;continue;case"raw":h=!0;break;case"authorize":f+=2,a.push("authorize");break;case"unauthorize":f+=2,a.push("unauthorize");break;case"logged":f+=2,a.push("authorize"),console.log('OBSOLETE: flag "logged" - use "authorize".');break;case"unlogged":a.push("unauthorize"),console.log('OBSOLETE: flag "unlogged" - use "unauthorize".');break;case"referer":case"referrer":a.push("referer");break;case"delete":case"get":case"head":case"options":case"patch":case"post":case"propfind":case"put":case"trace":a.push(w),v+=(v.length>0?",":"")+w;break;default:a.push(w)}}else null===(o||null)&&(o=[]),o.push(r[b].substring(1));r=a,f+=2*y}else r=["get"],v="get";var k=-1!==r.indexOf("mmr");if(k&&-1!==e.indexOf("{"))throw new Error("Mixed route cannot contain dynamic path.");if(k&&-1!==r.indexOf("upload"))throw new Error("Multipart mishmash: mmr vs. upload.");var E=!1;-1===r.indexOf("logged")&&-1===r.indexOf("authorize")&&-1===r.indexOf("unauthorize")&&-1===r.indexOf("unlogged")&&(E=!0);
var S=framework_internal.routeSplit(e.trim()),T=[];return-1!==e.indexOf("{")&&(S.forEach(function(e,t){"{"===e.substring(0,1)&&T.push(t)}),f-=T.length),-1!==e.indexOf("#")&&(f-=100),-1!==r.indexOf("proxy")&&-1===r.indexOf("json")&&(r.push("json"),f++),-1===r.indexOf("json")&&-1===r.indexOf("xml")&&!h||-1!==r.indexOf("post")||-1!==r.indexOf("put")||-1!==r.indexOf("patch")||(r.push("post"),v+=(v.length>0?",":"")+"post",f++),k&&-1===r.indexOf("post")&&-1===r.indexOf("put")&&-1===r.indexOf("upload")&&(r.push("upload"),f++),-1!==r.indexOf("upload")&&-1===r.indexOf("post")&&-1===w.indexOf("put")&&(r.push("post"),v+=(v.length>0?",":"")+"post"),-1===r.indexOf("get")&&-1===r.indexOf("options")&&-1===r.indexOf("post")&&-1===r.indexOf("delete")&&-1===r.indexOf("put")&&-1===r.indexOf("upload")&&-1===r.indexOf("head")&&-1===r.indexOf("trace")&&-1===r.indexOf("patch")&&-1===r.indexOf("propfind")&&(r.push("get"),v+=(v.length>0?",":"")+"get"),-1!==r.indexOf("referer")&&(p._request_check_referer=!0),p._request_check_POST||-1===r.indexOf("post")&&-1===r.indexOf("put")&&-1===r.indexOf("upload")&&-1===r.indexOf("mmr")&&-1===r.indexOf("json")&&-1===r.indexOf("patch")&&-1===r.indexOf("options")||(p._request_check_POST=!0),o instanceof Array||(o=null),v=-1!==v.indexOf(",")||""===v?void 0:v.toUpperCase(),p.routes.web.push({priority:f,subdomain:d,name:0===(_controller||"").length?"unknown":_controller,url:S,param:T,flags:r||[],method:v,onExecute:t,maximumSize:1024*(n||p.config["default-request-length"]),middleware:o,timeout:void 0===i?p.config["default-request-timeout"]:i,isJSON:-1!==r.indexOf("json"),isXML:-1!==r.indexOf("xml"),isRAW:h,isMEMBER:E,isXSS:-1!==r.indexOf("xss"),isASTERIX:m,isREFERER:-1!==r.indexOf("referer"),isHTTPS:-1!==r.indexOf("https"),isHTTP:-1!==r.indexOf("http"),isDEBUG:-1!==r.indexOf("debug"),isRELEASE:-1!==r.indexOf("release"),isPROXY:-1!==r.indexOf("proxy"),isBOTH:g?!1:!0,isXHR:-1!==r.indexOf("xhr"),isUPLOAD:-1!==r.indexOf("upload"),options:s}),p.emit("route-add","web",p.routes.web[p.routes.web.length-1]),0===_controller.length&&p._routesSort(),p},Framework.prototype.merge=function(e){for(var t=[],r=this,n=1,o=arguments.length;o>n;n++){var i=arguments[n];i instanceof Array||(i=[i]);for(var s=0,a=i.length;a>s;s++)t.push(i[s])}"/"!==e[0]&&(e="/"+e);var u=r.path.temp("merge-"+e.substring(1).replace(/\//g,"-"));return r.routes.merge[e]={filename:u,files:t},r},Framework.prototype.mapping=function(e,t){return"/"!==e[0]&&(e="/"+e),this.routes.mapping[e]=t,this},Framework.prototype.middleware=function(e,t){var r=this;return r.install("middleware",e,t),r},Framework.prototype.use=function(e){var t=this;if(arguments.length>0)for(var r=0;r<arguments.length;r++)t.routes.request.push(arguments[r]);else if(e instanceof Array)for(var r=0;r<e.length;r++)t.routes.request.push(e[r]);else t.routes.request.push(e);return t._length_request_middleware=t.routes.request.length,t},Framework.prototype.partial=function(e,t){return console.log("OBSOLETE: framework.partial(), use: framework.middleware()"),this.middleware(e,t)},Framework.prototype.websocket=function(e,t,r,n,o,i,s,a){if(""===e&&(e="/"),utils.isArray(i)){var u=s;s=i,i=u}if(typeof funcExecute===OBJECT){var u=r;funcExecute=r,r=u}r instanceof Array||typeof r!==OBJECT||(n=r.protocols||r.protocol,o=r.allow||r.origin,i=r.max||r.length||r.maximum||r.maximumSize,s=r.middleware,a=r.options,r=r.flags),void 0===s&&(s=null);var l=this,c=0,p=e.indexOf("]"),f=null,d=-1!==e.indexOf("*");c=e.count("/"),p>0&&(f=e.substring(1,p).trim().toLowerCase().split(","),e=e.substring(p+1),c+=2),d&&(e=e.replace("*","").replace("//","/"),c=-10-c);var m=[],h=framework_internal.routeSplit(e.trim());-1!==e.indexOf("{")&&(h.forEach(function(e,t){"{"===e.substring(0,1)&&m.push(t)}),c-=m.length),typeof o===STRING&&(o=o[o]),typeof n===STRING&&(n=n[n]),typeof r===STRING&&(r=r[r]);var g=!1,v=!1,u=[],y=0;void 0===r&&(r=[]);for(var b=0;b<r.length;b++)"#"!==r[b][0]?(r[b]=r[b].toString().toLowerCase(),y++,"json"===r[b]&&(g=!0),"binary"===r[b]&&(v=!0),"raw"===r[b]&&(v=!1,g=!1),"json"!==r[b]&&"binary"!==r[b]&&"raw"!==r[b]&&u.push(r[b])):(null===(s||null)&&(s=[]),s.push(r[b].substring(1)));r=u,-1===r.indexOf("get")&&r.unshift("get"),c+=2*y;var w=!1;return r&&-1!==r.indexOf("authorize")||(w=!0),l.routes.websockets.push({name:0===(_controller||"").length?"unknown":_controller,url:h,param:m,subdomain:f,priority:c,flags:r||[],onInitialize:t,protocols:n||[],allow:o||[],length:1024*(i||l.config["default-websocket-request-length"]),isMEMBER:w,isJSON:g,isBINARY:v,isASTERIX:d,isHTTPS:r.indexOf("https"),isHTTP:r.indexOf("http"),isDEBUG:r.indexOf("debug"),isRELEASE:r.indexOf("release"),middleware:s,options:a}),l.emit("route-add","websocket",l.routes.websockets[l.routes.websockets.length-1]),0===_controller.length&&l._routesSort(),l},Framework.prototype.file=function(e,t,r,n,o){var i=this;if(utils.isArray(t)){var s=r,a=n;n=t,t=s,r=a}else if(utils.isArray(r)){var s=r;r=n,n=s}return void 0===n&&(n=null),i.routes.files.push({controller:0===(_controller||"").length?"unknown":_controller,name:e,onValidation:t,onExecute:r||t,middleware:n,options:o}),i.emit("route-add","file",i.routes.files[i.routes.files.length-1]),i._length_files++,i},Framework.prototype.error=function(e,t,r){if(void 0===e)return function(e){e&&framework.error(e,t,r)};var n=this;return null!==n.errors&&(n.errors.push({error:e,name:t,uri:r,date:new Date}),n.errors.length>50&&n.errors.shift()),n.onError(e,t,r),n},Framework.prototype.problem=function(e,t,r,n){var o=this;return null!==o.problems&&(o.problems.push({message:e,name:t,uri:r,ip:n}),o.problems.length>50&&o.problems.shift()),o.emit("problem",e,t,r,n),o},Framework.prototype.change=function(e,t,r,n){var o=this;return null!==o.changes&&(o.changes.push({message:e,name:t,uri:r,ip:n}),o.changes.length>50&&o.changes.shift()),o.emit("change",e,t,r,n),o},Framework.prototype.module=function(e){return this.modules[e]||null},Framework.prototype.load=function(){function e(t,n,o,i){fs.existsSync(r)&&(i||(i=EXTENSION_JS),fs.readdirSync(t).forEach(function(s){var a=fs.statSync(path.join(t,s)).isDirectory();if(a)return n++,void e(path.join(t,s),n,o,i);var u=path.extname(s).toLowerCase();if(u===i){var l=(n>0?t.replace(r,"")+"/":"")+s.substring(0,s.length-u.length);o.push({name:"/"===l[0]?l.substring(1):l,filename:path.join(r,l)+i})}}))}var t=this,r=path.join(directory,t.config["directory-controllers"]),n=[];return n=[],e(r,0,n),n.forEach(function(e){t.install("controller",e.name,e.filename,void 0,void 0,void 0,!0)}),r=path.join(directory,t.config["directory-modules"]),fs.existsSync(r)&&fs.readdirSync(r).forEach(function(e){var r=path.extname(e),n=r.toLowerCase();if(n===EXTENSION_JS){var o=path.join(directory,t.config["directory-modules"],e);t.install("module",e.replace(r,""),o,void 0,void 0,void 0,!0)}}),r=path.join(directory,t.config["directory-definitions"]),n=[],e(r,0,n),n.forEach(function(e){t.install("definition",e.name,e.filename,void 0,void 0,void 0,!0)}),r=path.join(directory,t.config["directory-models"]),n=[],e(r,0,n),n.forEach(function(e){t.install("model",e.name,e.filename,void 0,void 0,void 0,!0)}),r=path.join(directory,t.config["directory-packages"]),n=[],e(r,0,n,".package"),n.forEach(function(e){t.install("package",e.name,e.filename,void 0,void 0,void 0,!0)}),t._routesSort(),t},Framework.prototype.install=function(type,name,declaration,options,callback,internal,useRequired,skipEmit){var self=this,obj=null;"config"!==type&&"version"!==type&&"STRING"==typeof name&&(name.startsWith("http://")||name.startsWith("https://"))&&typeof declaration===OBJECT&&(callback=options,options=declaration,declaration=name,name="");var t=typeof declaration,key="",tmp=null;if(t===OBJECT){var t=typeof options;t===TYPE_FUNCTION&&(callback=options),options=declaration,declaration=void 0}if(void 0===declaration&&(declaration=name,name=""),typeof declaration===STRING&&(declaration.startsWith("http://")||declaration.startsWith("https://")))return utils.request(declaration,["get"],function(e,t,r){return 200===r||e||(e=new Error(t)),e?(self.error(e,"framework.install('{0}', '{1}')".format(type,declaration),null),void(callback&&callback(e))):void self.install(type,name,t,options,callback,declaration)}),self;if("middleware"===type)return self.routes.middleware[name]=typeof declaration===TYPE_FUNCTION?declaration:eval(declaration),self._length_middleware=Object.keys(self.routes.middleware).length,callback&&callback(null),key=type+"."+name,self.temporary.dependencies[key]?self.temporary.dependencies[key].updated=new Date:(self.temporary.dependencies[key]={name:name,type:type,installed:new Date,updated:null,count:0},internal&&(self.temporary.dependencies[key].url=internal)),self.temporary.dependencies[key].count++,setTimeout(function(){self.emit("install",type,name)},500),self;if("config"===type||"configuration"===type||"settings"===type)return self._configure(declaration instanceof Array?declaration:declaration.toString().split("\n"),!0),setTimeout(function(){delete self.temporary["mail-settings"],self.emit("install",type,name)},500),callback&&callback(null),self;if("version"===type||"versions"===type)return self._configure_versions(declaration.toString(),!0),setTimeout(function(){self.emit("install",type,name)},500),callback&&callback(null),self;if("package"===type){var backup=new Backup,id=path.basename(declaration,".package"),dir=path.join(framework.path.root(),framework.config["directory-temp"],id);return self.routes.packages[id]=dir,backup.restore(declaration,dir,function(){var e=path.join(dir,"index.js");self.install("module",id,e,options,function(e){setTimeout(function(){self.emit("install",type,name)},500),callback&&callback(e)},internal,useRequired,!0)}),self}var plus=null===self.id?"":"instance-"+self.id+"-";if("view"===type){var item=self.routes.views[name];return key=type+"."+name,void 0===item&&(item={},item.filename=self.path.temporary("installed-"+plus+"view-"+utils.GUID(10)+".tmp"),item.url=internal,item.count=0,self.routes.views[name]=item),item.count++,fs.writeFileSync(item.filename,declaration),setTimeout(function(){self.emit("install",type,name)},500),callback&&callback(null),self}if("definition"===type||"eval"===type){_controller="";try{useRequired?(delete require.cache[require.resolve(declaration)],obj=require(declaration),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration))):obj=eval(typeof declaration===TYPE_FUNCTION?"("+declaration.toString()+")()":declaration)}catch(ex){return self.error(ex,"framework.install('"+type+"')",null),callback&&callback(ex),self}return callback&&callback(null),setTimeout(function(){self.emit("install",type,name)},500),self}if("model"===type||"source"===type){_controller="";try{if(useRequired)obj=require(declaration),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration));else{typeof declaration!==STRING&&(declaration=declaration.toString());var filename=directory+self.path.temporary("installed-"+plus+type+"-"+utils.GUID(10)+".js").substring(1);fs.writeFileSync(filename,declaration),obj=require(filename),function(e,t){setTimeout(function(){fs.unlinkSync(t),delete require.cache[e]},1e3)}(require.resolve(filename),filename)}}catch(ex){return self.error(ex,"framework.install('"+type+"', '"+name+"')",null),callback&&callback(ex),self}return name||typeof obj.id!==STRING?name||typeof obj.name!==STRING||(name=obj.name):name=obj.id,key=type+"."+name,tmp=self.temporary.dependencies[key],self.uninstall(type,name),tmp?(self.temporary.dependencies[key]=tmp,self.temporary.dependencies[key].updated=new Date):(self.temporary.dependencies[key]={name:name,type:type,installed:new Date,updated:null,count:0},internal&&(self.temporary.dependencies[key].url=internal)),self.temporary.dependencies[key].count++,obj.reinstall?self.temporary.dependencies[key].reinstall=obj.reinstall.toString().parseDateExpire():delete self.temporary.dependencies[key],"model"===type?self.models[name]=obj:self.sources[name]=obj,typeof obj.install===TYPE_FUNCTION&&obj.install(self,options,name),skipEmit||setTimeout(function(){self.emit("install",type,name)},500),callback&&callback(null),self}if("module"===type||"controller"===type){_controller="TMP"+Utils.random(1e4);try{if(useRequired)obj=require(declaration),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration));else{typeof declaration!==STRING&&(declaration=declaration.toString());var filename=directory+self.path.temporary("installed-"+plus+type+"-"+utils.GUID(10)+".js").substring(1);fs.writeFileSync(filename,declaration),obj=require(filename),function(e,t){setTimeout(function(){fs.unlinkSync(t),delete require.cache[e]},1e3)}(require.resolve(filename),filename)}}catch(ex){return self.error(ex,"framework.install('"+type+"', '"+(0===name.length?internal:"")+"')",null),callback&&callback(ex),self}typeof obj.name===STRING&&(name=obj.name),key=type+"."+name,tmp=self.temporary.dependencies[key],self.uninstall(type,name),tmp?(self.temporary.dependencies[key]=tmp,self.temporary.dependencies[key].updated=new Date):(self.temporary.dependencies[key]={name:name,type:type,installed:new Date,updated:null,count:0},internal&&(self.temporary.dependencies[key].url=internal)),self.temporary.dependencies[key].count++,obj.reinstall?self.temporary.dependencies[key].reinstall=obj.reinstall.toString().parseDateExpire():delete self.temporary.dependencies[key].reinstall,typeof obj.install===TYPE_FUNCTION&&obj.install(self,options,name);for(var id=("module"===type?"#":"")+name,length=self.routes.web.length,i=0;length>i;i++)self.routes.web[i].name===_controller&&(self.routes.web[i].name=id);length=self.routes.websockets.length;for(var i=0;length>i;i++)self.routes.websockets[i].name===_controller&&(self.routes.websockets[i].name=id);length=self.routes.files.length;for(var i=0;length>i;i++)self.routes.files[i].name===_controller&&(self.routes.files[i].name=id);return self._routesSort(),"module"===type?self.modules[name]=obj:self.controllers[name]=obj,_controller="",skipEmit||setTimeout(function(){self.emit("install",type,name)},500),callback&&callback(null),self}return self},Framework.prototype.uninstall=function(e,t,r,n){var o=this,i=null;if("schema"===e)return Builders.remove(t),o.emit("uninstall",e,t),o;if("mapping"===e)return delete o.routes.mapping[t],o.emit("uninstall",e,t),o;if("middleware"===e)return o.routes.middleware[t]?(delete o.routes.middleware[t],delete o.temporary.dependencies[e+"."+t],o._length_middleware=Object.keys(o.routes.middleware).length,o.emit("uninstall",e,t),o):o;if("package"===e)return delete o.routes.packages[t],o.uninstall("module",t,r,!0),o;if("view"===e||"precompile"===e)return(i=o.routes.views[t])?(delete o.routes.views[t],delete o.temporary.dependencies[e+"."+t],fs.exists(i.filename,function(e){e&&fs.unlink(i.filename)}),o.emit("uninstall",e,t),o):o;if("model"===e||"source"===e)return(i="model"===e?o.models[t]:o.sources[t])?(i.id&&delete require.cache[require.resolve(i.id)],typeof i.uninstall===TYPE_FUNCTION&&i.uninstall(o,r,t),"model"===e?delete o.models[t]:delete o.sources[t],delete o.temporary.dependencies[e+"."+t],o._routesSort(),o.emit("uninstall",e,t),o):o;if("module"===e||"controller"===e){var s="module"===e;if(i=s?o.modules[t]:o.controllers[t],!i)return o;i.id&&delete require.cache[require.resolve(i.id)];var a=(s?"#":"")+t;return o.routes.web=o.routes.web.remove(function(e){return e.name===a}),o.routes.files=o.routes.files.remove(function(e){return e.name===a}),o.routes.websockets=o.routes.websockets.remove(function(e){return e.name===a}),i&&(i.uninstall&&i.uninstall(o,r,t),s?delete o.modules[t]:delete o.controllers[t]),o._routesSort(),delete o.temporary.dependencies[e+"."+t],n||o.emit("uninstall",e,t),o}return o},Framework.prototype.eval=function(e){return this.install("eval",e)},Framework.prototype.onError=function(e,t,r){return console.log("======= "+(new Date).format("yyyy-MM-dd HH:mm:ss")+": "+(t?t+" ---> ":"")+e.toString()+(r?" ("+r.toString()+")":""),e.stack),this},Framework.prototype.onAuthorization=null,Framework.prototype.onVersion=null,Framework.prototype.onMapping=function(e,t){return"/"!==e[0]&&(e="/"+e),this.routes.mapping[e]?this.routes.mapping[e]:t},Framework.prototype.onValidation=null,Framework.prototype.onMail=function(e,t,r,n){var o=Mail.create(t,r);if(e instanceof Array)for(var i=e.length,s=0;i>s;s++)o.to(e[s]);else o.to(e);var a=this;o.from(a.config["mail.address.from"]||"",a.config.name);var u=a.config["mail.address.reply"];u&&u.length>0&&u.isEmail()&&o.reply(a.config["mail.address.reply"]),u=a.config["mail.address.copy"],u&&u.length>0&&u.isEmail()&&o.bcc(u);var l=a.temporary["mail-settings"];if(void 0===l){var c=a.config["mail.smtp.options"];c&&c.isJSON()&&(l=JSON.parse(c)),a.temporary["mail-settings"]=l}return o.send(a.config["mail.smtp"],l,n),a},Framework.prototype.onXSS=function(e){return null===e||0===e.length?!1:(e=decodeURIComponent(e),-1!==e.indexOf("<")&&-1!==e.lastIndexOf(">"))},Framework.prototype.onMeta=function(){for(var e=this,t="",r=arguments.length,n=0;r>n;n++){var o=utils.encode(arguments[n]);if(null!==o&&0!==o.length)switch(n){case 0:t+="<title>"+(o+("/"===e.url||e.config["allow-custom-titles"]?"":" - "+e.config.name))+"</title>";break;case 1:t+='<meta name="description" content="'+o+'" />';break;case 2:t+='<meta name="keywords" content="'+o+'" />';break;case 3:var i=o.substring(0,6),s="http:/"===i||"https:"===i||"//"===o.substring(0,2)?o:e.hostname(e.routeImage(o));t+='<meta property="og:image" content="'+s+'" /><meta name="twitter:image" content="'+s+'" />'}}return t},Framework.prototype.log=function(){for(var e=this,t=new Date,r=t.getFullYear()+"-"+(t.getMonth()+1).toString().padLeft(2,"0")+"-"+t.getDate().toString().padLeft(2,"0"),n=t.getHours().toString().padLeft(2,"0")+":"+t.getMinutes().toString().padLeft(2,"0")+":"+t.getSeconds().toString().padLeft(2,"0"),o="",i=arguments.length,s=0;i>s;s++)o+=(o.length>0?" ":"")+(arguments[s]||"");return e._verify_directory("logs"),fs.appendFile(utils.combine(e.config["directory-logs"],r+".log"),n+" | "+o+"\n"),e},Framework.prototype.usage=function(e){var t=this,r=process.memoryUsage(),n=Object.keys(t.cache.items),o=Object.keys(t.resources),i=Object.keys(t.controllers),s=Object.keys(t.connections),a=Object.keys(t.workers),u=Object.keys(t.modules),l=Object.keys(t.models),c=Object.keys(t.helpers),p=(Object.keys(t.temporary.path),Object.keys(t.temporary.range),Object.keys(t.routes.redirects)),f=(utils.combine(t.config["directory-temp"]),{});return f.framework={pid:process.pid,node:process.version,version:"v"+t.version_header,platform:process.platform,processor:process.arch,uptime:Math.floor(process.uptime()/60),memoryTotal:(r.heapTotal/1024/1024).floor(2),memoryUsage:(r.heapUsed/1024/1024).floor(2),mode:t.config.debug?"debug":"release",port:t.port,ip:t.ip,directory:process.cwd()},f.counter={resource:o.length,controller:i.length,module:u.length,cache:n.length,worker:a.length,connection:s.length,helper:c.length,error:t.errors.length,problem:t.problem.length},f.routing={webpage:t.routes.web.length,websocket:t.routes.websockets.length,file:t.routes.files.length,middleware:Object.keys(t.routes.middleware).length,redirect:p.length},f.stats={request:t.stats.request,response:t.stats.response},f.redirects=p,t.restrictions.isRestrictions&&(f.restrictions={allowed:[],blocked:[],allowedHeaders:t.restrictions.allowedCustomKeys,blockedHeaders:t.restrictions.blockedCustomKeys}),e?(f.controllers=[],i.forEach(function(e){var r=t.controllers[e];f.controllers.push({name:e,usage:void 0===r.usage?null:r.usage()})}),f.connections=[],s.forEach(function(e){f.connections.push({name:e,online:t.connections[e].online})}),f.modules=[],u.forEach(function(e){var r=t.modules[e];f.modules.push({name:e,usage:void 0===r.usage?null:r.usage()})}),f.models=[],l.forEach(function(e){var r=t.models[e];f.models.push({name:e,usage:void 0===r.usage?null:r.usage()})}),f.helpers=c,f.cache=n,f.resources=o,f.errors=t.errors,f.problems=t.problems,f.changes=t.changes,f):f},Framework.prototype.onCompileCSS=null,Framework.prototype.onCompileJS=null,Framework.prototype.compileContent=function(e,t){var r=this;switch(e){case"js":return r.config["allow-compile-js"]?framework_internal.compile_javascript(t):t;case"css":t=r.config["allow-compile-css"]?framework_internal.compile_css(t):t;var n=t.match(/url\(.*?\)/g);return null===n?t:(n.forEach(function(e){var n=e.substring(4,e.length-1);t=t.replace(e,"url("+r._version(n)+")")}),t)}return t},Framework.prototype.compileFile=function(e,t,r,n,o){var i=this;return fs.readFile(r,function(s,a){if(s)return i.error(s,r,e),i.temporary.path[t]=null,void o();var u=i.path.temp((null===i.id?"":"instance-"+i.id+"-")+e.pathname.replace(/\//g,"-").substring(1));i._verify_directory("temp"),fs.writeFileSync(u,i.compileContent(n,a.toString(ENCODING),r),ENCODING),i.temporary.path[t]=u+";"+fs.statSync(u).size,o()}),i},Framework.prototype.compileMerge=function(e,t,r,n){var o=this,i=o.routes.merge[e.pathname],s=i.filename;if(!o.config.debug&&fs.existsSync(s))return o.temporary.path[t]=s+";"+fs.statSync(s).size,n(),o;var a=fs.createWriteStream(i.filename);return i.files.wait(function(t,n){if(t.startsWith("http://")||t.startsWith("https://"))return void Utils.request(t,["get"],function(e,i){var s=o.compileContent(r,i,t).trim();"js"===r?";"!==s[s.length-1]&&(s+=";"):"html"===r&&s[s.length-1]!==NEWLINE&&(s+=NEWLINE),a.write(s,ENCODING),n()});if("~"!==t[0]){var s=o.path.public(t);o.isVirtualDirectory&&!fs.existsSync(s)&&(s=utils.combine(o.config["directory-public-virtual"],t)),t=s}else t=t.substring(1);fs.readFile(t,function(s,u){if(s)return o.error(s,i.filename,e),void n();var l=o.compileContent(r,u.toString(ENCODING),t).trim();"js"===r?";"!==l[l.length-1]&&(l+=";"):"html"===r&&l[l.length-1]!==NEWLINE&&(l+=NEWLINE),a.write(l,ENCODING),n()})},function(){a.end(),o.temporary.path[t]=s+";"+fs.statSync(s).size,n()}),o},Framework.prototype.compileValidation=function(e,t,r,n,o){var i=this;if(i.routes.merge[e.pathname])return void i.compileMerge(e,t,n,o);if(!fs.existsSync(r)){if(!i.isVirtualDirectory)return i.temporary.path[t]=null,o(),i;var s=i.isWindows?r.replace(i.config["directory-public"].replace(/\//g,"\\"),i.config["directory-public-virtual"].replace(/\//g,"\\")):r.replace(i.config["directory-public"],i.config["directory-public-virtual"]),a=!0;if(s!==r&&(r=s,a=!fs.existsSync(r)),a)return i.temporary.path[t]=null,o(),i}return"js"!==n&&"css"!==n||-1!==r.lastIndexOf(".min.")||-1!==r.lastIndexOf("-min.")?(i.temporary.path[t]=r+";"+fs.statSync(r).size,o(),i):(i.compileFile(e,t,r,n,o),i)},Framework.prototype.responseStatic=function(e,t){var r=this;if(t.success)return r;var n=e.url,o=n.indexOf("?");-1!==o&&(n=n.substring(0,o)),o=n.lastIndexOf("/");var i=r.routes.resize[n.substring(0,o+1)]||null,s=!1,a=void 0;return null!==i?(n=n.substring(o+1),o=n.lastIndexOf("."),s="*"===i.extension||-1!==i.extension.indexOf(n.substring(o).toLowerCase()),s?(n=i.path+decodeURIComponent(n),a=r.onMapping(n,"~"===n[0]?n.substring(1):"."===n[0]?n:utils.combine(r.config["directory-public"],n))):a=r.onMapping(n,utils.combine(r.config["directory-public"],decodeURIComponent(n)))):a=r.onMapping(n,utils.combine(r.config["directory-public"],decodeURIComponent(n))),s?(r.responseImage(e,t,a,function(e){(i.width||i.height)&&(i.width&&i.height?e.resizeCenter(i.width,i.height):e.resize(i.width,i.height)),i.grayscale&&e.grayscale(),i.blur&&e.blur("number"==typeof i.blur?i.blur:1),i.rotate&&typeof i.rotate==NUMBER&&e.rotate(i.rotate),i.flop&&e.flop(),i.flip&&e.flip(),i.sepia&&e.sepia("number"==typeof i.sepia?i.sepia:100),e.quality(i.quality?i.quality:r.config["default-image-quality"]),e.minify()}),r):(r.responseFile(e,t,a,""),r)},Framework.prototype.isProcessed=function(e){var t=this;if(e.url){var r=e.url,n=r.indexOf("?");-1!==n&&(r=r.substring(0,n)),e=utils.combine(t.config["directory-public"],decodeURIComponent(r))}return void 0!==t.temporary.path[e]?!0:!1},Framework.prototype.isProcessing=function(e){var t=this;if(e.url){var r=e.url,n=r.indexOf("?");-1!==n&&(r=r.substring(0,n)),e=utils.combine(t.config["directory-public"],decodeURIComponent(r))}var r=t.temporary.processing[e];return void 0!==t.temporary.processing[e]?!0:!1},Framework.prototype.noCache=function(e,t){return e.noCache(),t&&t.noCache(),this},Framework.prototype.responseFile=function(e,t,r,n,o,i){var s=this;if(t.success)return s;e.clear(!0),i=i||r;var a=s.temporary.path[i];if(null===a)return s.config.debug&&delete s.temporary.path[i],s.response404(e,t),s;var u=path.extname(i).substring(1);0===u.length&&(u=path.extname(a).substring(1));var l=u.lastIndexOf(";");if(-1!==l&&(u=u.substring(0,l)),-1===s.config["static-accepts"].indexOf("."+u))return s.response404(e,t),s;var c=utils.etag(e.url,s.config["etag-version"]);if(!s.config.debug&&e.headers["if-none-match"]===c)return t.success=!0,t.writeHead(304),t.end(),s.stats.response.notModified++,s._request_stats(!1,e.isStaticFile),e.isStaticFile||s.emit("request-end",e,t),s;if(void 0===a)return s.isProcessing(i)?e.processing>s.config["default-request-timeout"]?void s.response408(e,t):(e.processing+=500,setTimeout(function(){framework.responseFile(e,t,r,n,o,i)},500),s):(s.temporary.processing[i]=!0,s.compileValidation(e.uri,i,r,u,function(){delete s.temporary.processing[i],framework.responseFile(e,t,r,n,o,i)}),s);l=a.lastIndexOf(";");var p=null;-1===l?l=a.length:p=a.substring(l+1),a=a.substring(0,l);var f=e.headers["accept-encoding"]||"",d={};d["Accept-Ranges"]="bytes",d[RESPONSE_HEADER_CACHECONTROL]="public",d.Expires=(new Date).add("d",15),d.Vary="Accept-Encoding",o&&utils.extend(d,o,!0),n&&n.length>0&&(d["Content-Disposition"]='attachment; filename="'+n+'"'),c.length>0&&(d.Etag=c),d[RESPONSE_HEADER_CONTENTTYPE]||(d[RESPONSE_HEADER_CONTENTTYPE]=utils.getContentType(u));var m=s.config["allow-gzip"]&&-1!==REQUEST_COMPRESS_CONTENTTYPE.indexOf(d[RESPONSE_HEADER_CONTENTTYPE]),h=e.headers.range||"",g=-1!==f.lastIndexOf("gzip");if(t.success=!0,h.length>0)return s.responseRange(a,h,d,e,t);s.config.debug&&s.isProcessed(i)&&delete s.temporary.path[i],null===p||"0"===p||m||(d[RESPONSE_HEADER_CONTENTLENGTH]=p);var v;return m&&g?(d["Content-Encoding"]="gzip",t.writeHead(200,d),v=fs.createReadStream(a).pipe(zlib.createGzip()),v.pipe(t),s.stats.response.file++,s._request_stats(!1,e.isStaticFile),e.isStaticFile||s.emit("request-end",e,t),s):(t.writeHead(200,d),v=fs.createReadStream(a),v.pipe(t),s.stats.response.file++,s._request_stats(!1,e.isStaticFile),e.isStaticFile||s.emit("request-end",e,t),s)},Framework.prototype.responsePipe=function(e,t,r,n,o,i){var s=this;if(t.success)return s;var a=parser.parse(r),u={};u[RESPONSE_HEADER_CACHECONTROL]="private",n&&utils.extend(u,n,!0),u["X-Powered-By"]="total.js v"+s.version_header;var l={protocol:a.protocol,auth:a.auth,method:"GET",hostname:a.hostname,port:a.port,path:a.path,agent:!1,headers:u},c="https:"===l.protocol?https:http,p=-1!==(e.headers["accept-encoding"]||"").lastIndexOf("gzip"),f=c.get(l,function(e){var r=e.headers["content-type"],n=-1!==(e.headers["content-encoding"]||"").lastIndexOf("gzip"),o=!n&&p&&(-1!==r.indexOf("text/")||-1!==r.lastIndexOf("javascript")||-1!==r.lastIndexOf("json")),i=e.headers["content-disposition"]||"";return i.length>0&&t.setHeader("Content-Disposition",i),t.setHeader(RESPONSE_HEADER_CONTENTTYPE,r),t.setHeader("Vary","Accept-Encoding"),o?(t.setHeader("Content-Encoding","gzip"),void e.pipe(zlib.createGzip()).pipe(t)):void(!p&&n?e.pipe(zlib.createGunzip()).pipe(t):e.pipe(t))});return(o||0)>0&&f.setTimeout(o||3e3,function(){s.response408(e,t),i&&i()}),f.on("close",function(){t.success||(e.clear(!0),t.success=!0,s.stats.response.pipe++,s._request_stats(!1,e.isStaticFile),t.success=!0,e.isStaticFile||s.emit("request-end",e,t),i&&i())}),s},Framework.prototype.responseCustom=function(e,t){var r=this;return t.success?r:(e.clear(!0),t.success=!0,r.stats.response.custom++,r._request_stats(!1,e.isStaticFile),e.isStaticFile||r.emit("request-end",e,t),r)},Framework.prototype.responseImage=function(e,t,r,n,o,i){var s=this,a=null;typeof r===OBJECT&&(a=r);var u="image-"+e.url.substring(1),l=s.temporary.path[u];if(null===l)return s.response404(e,t),s;if(void 0!==l)return s.responseFile(e,t,r,"",o,u),s;var c=i;if(void 0===c&&(c="im"===s.config["default-image-converter"]),s.isProcessing(u))return e.processing>s.config["default-request-timeout"]?void s.response408(e,t):(e.processing+=500,void setTimeout(function(){s.responseImage(e,t,r,n,o,c)},500));var p=framework_image,f=null===s.id?"":"instance-"+s.id+"-";return l=s.path.temp(f+u.replace(/\//g,"-")),s.temporary.processing[u]=!0,null!==a?(fs.exists(l,function(r){if(r)return delete s.temporary.processing[u],s.temporary.path[u]=l,s.responseFile(e,t,l,"",o,u),void(s.isDebug&&delete s.temporary.path[u]);s._verify_directory("temp");var i=p.load(a,c);n(i);var f=path.extname(l);f.substring(1)!==i.outputType&&(l=l.substring(0,l.lastIndexOf(f))+"."+i.outputType),i.save(l,function(r){return delete s.temporary.processing[u],r?(s.temporary.path[u]=null,s.response500(e,t,r),void(s.isDebug&&delete s.temporary.path[u])):(s.temporary.path[u]=l+";"+fs.statSync(l).size,void s.responseFile(e,t,l,"",o,u))})}),s):(fs.exists(r,function(i){if(!i)return delete s.temporary.processing[u],s.temporary.path[u]=null,s.response404(e,t),void(s.isDebug&&delete s.temporary.path[u]);s._verify_directory("temp");var a=p.load(r,c);n(a);var f=path.extname(l);f.substring(1)!==a.outputType&&(l=l.substring(0,l.lastIndexOf(f))+"."+a.outputType),a.save(l,function(r){return delete s.temporary.processing[u],r?(s.temporary.path[u]=null,s.response500(e,t,r),void(s.isDebug&&delete s.temporary.path[u])):(s.temporary.path[u]=l+";"+fs.statSync(l).size,void s.responseFile(e,t,l,"",o,u))})}),s)},Framework.prototype.responseImageWithoutCache=function(e,t,r,n,o,i){var s=this,a=null;typeof r===OBJECT&&(a=r);var u="image-"+e.url.substring(1);return utils.queue(u,10,function(u){var l=i;void 0===l&&(l="im"===s.config["default-image-converter"]);var c=framework_image;if(null!==a){u();var p=c.load(a,l);return n(p),s.responseStream(e,t,utils.getContentType(p.outputType),p.stream(),null,o),s}fs.exists(r,function(i){if(u(),!i)return void s.response404(e,t);s._verify_directory("temp");var a=c.load(r,l);n(a),s.responseStream(e,t,utils.getContentType(a.outputType),a.stream(),null,o)})}),s},Framework.prototype.responseStream=function(e,t,r,n,o,i){var s=this;if(t.success)return s;e.clear(!0),-1===r.lastIndexOf("/")&&(r=utils.getContentType(r));var a=s.config["allow-gzip"]&&-1!==REQUEST_COMPRESS_CONTENTTYPE.indexOf(r),u=e.headers["accept-encoding"]||"",l={};if(l[RESPONSE_HEADER_CACHECONTROL]="public",l.Expires=(new Date).add("d",15),l.Vary="Accept-Encoding",i&&utils.extend(l,i,!0),o=o||"",o.length>0&&(l["Content-Disposition"]="attachment; filename="+encodeURIComponent(o)),l[RESPONSE_HEADER_CONTENTTYPE]=r,a&&-1!==u.lastIndexOf("gzip")){l["Content-Encoding"]="gzip",t.writeHead(200,l);var c=zlib.createGzip();return n.pipe(c).pipe(t),s.stats.response.stream++,s._request_stats(!1,e.isStaticFile),e.isStaticFile||s.emit("request-end",e,t),s}return t.writeHead(200,l),n.pipe(t),s.stats.response.stream++,s._request_stats(!1,e.isStaticFile),e.isStaticFile||s.emit("request-end",e,t),s},Framework.prototype.responseRange=function(e,t,r,n,o){var i=this,s=t.replace(/bytes=/,"").split("-"),a=parseInt(s[0]||"0",10),u=parseInt(s[1]||"0",10),l=i.temporary.range[e]||0;0===l&&(l=fs.statSync(e).size,i.temporary.range[e]=l),0===u&&(u=l-1),a>u&&(a=0,u=l-1);var c=u-a+1;r[RESPONSE_HEADER_CONTENTLENGTH]=c,r["Content-Range"]="bytes "+a+"-"+u+"/"+l,o.writeHead(206,r);var p=fs.createReadStream(e,{start:a,end:u});return p.pipe(o),i.stats.response.streaming++,i._request_stats(!1,n.isStaticFile),n.isStaticFile||i.emit("request-end",n,o),i},Framework.prototype.setModified=function(e,t,r){var n=this,o=typeof r===STRING;return o?(t.setHeader("Etag",r+":"+n.config["etag-version"]),n):(r=r||new Date,t.setHeader("Last-Modified",r.toUTCString()),n)
},Framework.prototype.notModified=function(e,t,r,n){var o=this,i=typeof r;if(i===BOOLEAN){var s=r;r=n,n=s,i=typeof r}var a=i===STRING,u=e.headers[a?"if-none-match":"if-modified-since"];if(a){if(void 0===u)return!1;var l=r+":"+o.config["etag-version"];if(u!==l)return!1}else{if(void 0===u)return!1;var c=void 0===r?(new Date).toUTCString():r.toUTCString();if(n){if(new Date(Date.parse(u))===new Date(c))return!1}else if(new Date(Date.parse(u))<new Date(c))return!1}return t.success=!0,t.writeHead(304),t.end(),o.stats.response.notModified++,o._request_stats(!1,e.isStaticFile),e.isStaticFile||o.emit("request-end",e,t),!0},Framework.prototype.response400=function(e,t){var r=this;if(t.success)return r;r._request_stats(!1,e.isStaticFile),e.clear(!0),t.success=!0;var n={},o=400;return n[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN,t.writeHead(o,n),t.end(utils.httpStatus(o)),e.isStaticFile||r.emit("request-end",e,t),r.stats.response.error400++,r},Framework.prototype.response401=function(e,t){var r=this;if(t.success)return r;r._request_stats(!1,e.isStaticFile),e.clear(!0),t.success=!0;var n={},o=401;return n[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN,t.writeHead(o,n),t.end(utils.httpStatus(o)),e.isStaticFile||r.emit("request-end",e,t),r.stats.response.error401++,r},Framework.prototype.response403=function(e,t){var r=this;if(t.success)return r;r._request_stats(!1,e.isStaticFile),e.clear(!0),t.success=!0;var n={},o=403;return n[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN,t.writeHead(o,n),t.end(utils.httpStatus(o)),e.isStaticFile||r.emit("request-end",e,t),r.stats.response.error403++,r},Framework.prototype.response404=function(e,t){var r=this;if(t.success)return r;r._request_stats(!1,e.isStaticFile),e.clear(!0),t.success=!0;var n={},o=404;return n[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN,t.writeHead(o,n),t.end(utils.httpStatus(o)),e.isStaticFile||r.emit("request-end",e,t),r.stats.response.error404++,r},Framework.prototype.response408=function(e,t){var r=this;if(t.success)return r;r._request_stats(!1,e.isStaticFile),e.clear(!0),t.success=!0;var n={},o=408;return n[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN,t.writeHead(o,n),t.end(utils.httpStatus(o)),e.isStaticFile||r.emit("request-end",e,t),r.stats.response.error408++,r},Framework.prototype.response431=function(e,t){var r=this;if(t.success)return r;r._request_stats(!1,e.isStaticFile),e.clear(!0),t.success=!0;var n={},o=431;return n[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN,t.writeHead(o,n),t.end(utils.httpStatus(o)),e.isStaticFile||r.emit("request-end",e,t),r.stats.response.error431++,r},Framework.prototype.response500=function(e,t,r){var n=this;if(t.success)return n;n._request_stats(!1,e.isStaticFile),e.clear(!0),r&&framework.error(r,null,e.uri),t.success=!0;var o={},i=500;return o[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN,t.writeHead(i,o),t.end(utils.httpStatus(i)),e.isStaticFile||n.emit("request-end",e,t),n.stats.response.error500++,n},Framework.prototype.response501=function(e,t){var r=this;if(t.success)return r;r._request_stats(!1,e.isStaticFile),e.clear(!0),t.success=!0;var n={},o=501;return n[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN,t.writeHead(o,n),t.end(utils.httpStatus(o)),e.isStaticFile||r.emit("request-end",e,t),r.stats.response.error501++,r},Framework.prototype.responseContent=function(e,t,r,n,o,i,s){var a=this;if(t.success)return a;e.clear(!0),t.success=!0,(null===n||void 0===n)&&(n="");var u=e.headers["accept-encoding"]||"",l={};return l[RESPONSE_HEADER_CACHECONTROL]="private",l.Vary="Accept-Encoding",s&&utils.extend(l,s,!0),"application/json"===o&&(l[RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate"),/text|application/.test(o)&&(o+="; charset=utf-8"),l[RESPONSE_HEADER_CONTENTTYPE]=o,i&&-1!==u.lastIndexOf("gzip")?(zlib.gzip(new Buffer(n),function(e,o){return e?(t.writeHead(r,l),void t.end(n,ENCODING)):(l["Content-Encoding"]="gzip",t.writeHead(r,l),void t.end(o,ENCODING))}),a._request_stats(!1,e.isStaticFile),e.isStaticFile||a.emit("request-end",e,t),a):(t.writeHead(r,l),t.end(n,ENCODING),a._request_stats(!1,e.isStaticFile),e.isStaticFile||a.emit("request-end",e,t),a)},Framework.prototype.responseRedirect=function(e,t,r,n){var o=this;if(t.success)return o;o._request_stats(!1,e.isStaticFile),e.clear(!0),t.success=!0;var i={Location:r};return i[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTHTML+"; charset=utf-8",t.writeHead(n?301:302,i),t.end(),e.isStaticFile||o.emit("request-end",e,t),o},Framework.prototype.initialize=function(e,t,r){var n=this;if(null!==n.server)return n;r||(r={});{var o=r.port,i=r.ip;r.config||{}}if(n.isHTTPS=typeof e.STATUS_CODES===UNDEFINED,process.argv.forEach(function(e){-1!==e.toLowerCase().indexOf("coffee")&&(n.isCoffee=!0)}),isNaN(o)&&typeof o!==STRING&&(o=null),n.config.debug=t,n.isDebug=t,n._configure(),n._configure_versions(),n.config["disable-strict-server-certificate-validation"]===!0&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),n.isTest&&n._configure("config-test",!1),n.cache.init(),n.isVirtualDirectory=fs.existsSync(utils.combine(n.config["directory-public-virtual"])),n.emit("init"),n.load(),n.server=r.https?e.createServer(r.https,function(e,t){framework._request(e,t)}):e.createServer(function(e,t){framework._request(e,t)}),n.config["allow-websocket"]&&n.server.on("upgrade",function(e,t,r){framework._upgrade(e,t,r)}),!o)if("auto"===n.config["default-port"]){var s=parseInt(process.env.PORT||"");isNaN(s)||(o=s)}else o=n.config["default-port"];return n.port=o||8e3,null!==i?(n.ip=i||n.config["default-ip"]||"127.0.0.1",("null"===n.ip||n.ip===UNDEFINED||"auto"===n.ip)&&(n.ip=void 0)):n.ip=void 0,n.server.listen(n.port,n.ip),(void 0===n.ip||null===n.ip)&&(n.ip="auto"),n.isLoaded=!0,process.connected||n.console(),setTimeout(function(){try{n.emit("load",n),n.emit("ready",n)}catch(e){n.error(e,'framework.on("load/ready")')}n.removeAllListeners("load"),n.removeAllListeners("ready")},500),n.isTest?(n.test(!0,r.tests||r.test),n):(setTimeout(function(){framework.isTest||(delete framework.tests,delete framework.test,delete framework.testing,delete framework.assert)},5e3),n)},Framework.prototype.run=function(e,t,r,n,o){if(console.log('OBSOLETE: please use for beginning framework.http("debug", [options([ip: String], [port: Number], [config: Object])]) or framework.http("release", [options([ip: String], [port: Number], [config: Object])]) or framework.http("test", [options([ip: String], [port: Number], [config: Object], tests: [String Array])])'),typeof e===STRING)return this.mode(e,t,r,n,o);var i=!1,s=typeof t;s===BOOLEAN?i=t:s===OBJECT&&(i=t.debug,o.config=t);var a=this;if(a.isHTTPS=typeof e.STATUS_CODES===UNDEFINED,isNaN(r)&&typeof r!==STRING&&(r=null),null!==r&&typeof r===OBJECT){var u=o;o=r,r=u}else if(null!==n&&typeof n===OBJECT){var u=o;o=n,n=u}return void 0===o&&(o={}),o.ip=n,o.port=r,this.initialize(e,i,o)},Framework.prototype.http=function(e,t){return void 0===t&&(t={}),t.port||(t.port=parseInt(process.argv[2])),this.mode(require("http"),e,t)},Framework.prototype.https=function(e,t){return void 0===t&&(t={}),this.mode(require("https"),e,t)},Framework.prototype.mode=function(e,t,r){var n=!1,o=!1,i=this;switch(t.toLowerCase().replace(/\.|\s/g,"-")){case"release":case"production":break;case"debug":case"develop":case"development":o=!0;break;case"test":case"testing":case"test-debug":case"testing-debug":n=!0,o=!0,i.isTest=!0;break;case"test-release":case"testing-release":case"test-production":case"testing-production":n=!0,o=!1}return i.initialize(e,o,r)},Framework.prototype.console=function(){console.log("===================================================="),console.log("PID          : "+process.pid),console.log("node.js      : "+process.version),console.log("total.js     : v"+framework.version_header),console.log("===================================================="),console.log("Name         : "+framework.config.name),console.log("Version      : "+framework.config.version),console.log("Author       : "+framework.config.author),console.log("Date         : "+(new Date).format("yyyy-MM-dd HH:mm:ss")),console.log("Mode         : "+(framework.config.debug?"debug":"release")),console.log("====================================================\n"),console.log("{2}://{0}:{1}/".format(framework.ip,framework.port,framework.isHTTPS?"https":"http")),console.log("")},Framework.prototype.reconnect=function(){var e=this;return void 0!==e.config["default-port"]&&(e.port=e.config["default-port"]),void 0!==e.config["default-ip"]&&(e.ip=e.config["default-ip"]),e.server.close(function(){e.server.listen(e.port,e.ip)}),e},Framework.prototype._verify_directory=function(e){var t=this,r="$directory-"+e;if(t.temporary.path[r])return t;var n=utils.combine(t.config["directory-"+e]);return fs.existsSync(n)||fs.mkdirSync(n),t.temporary.path[r]=!0,t},Framework.prototype._service=function(e){var t=this;t.config.debug&&(t.resources={}),e%framework.config["default-interval-clear-resources"]===0&&(t.emit("clear","resources"),t.resources={},typeof gc!==UNDEFINED&&gc()),e%framework.config["default-interval-clear-cache"]===0&&(t.emit("clear","temporary",t.temporary),t.temporary.path={},t.temporary.range={},t.temporary.views={},t.temporary.other={}),e%framework.config["default-interval-precompile-views"]===0&&Object.keys(t.routes.views).wait(function(e,r){var n=t.routes.views[e];t.install("view",e,n.url,null,r)},!0),e%framework.config["default-interval-websocket-ping"]===0&&Object.keys(framework.connections).wait(function(e,t){var r=framework.connections[e];r&&typeof r.ping===TYPE_FUNCTION&&r.ping(),t()},!0),t.emit("service",e)},Framework.prototype._request=function(e,t){var r=this;r.config["allow-performance"]&&(e.connection.setNoDelay(!0),e.connection.setTimeout(0)),t.req=e,r.stats.request.request++,r.emit("request",e,t);var n=e.headers,o=e.connection.encrypted||"https"===n["x-forwarded-protocol"]?"https":"http";if(r._request_check_redirect){var i=r.routes.redirects[o+"://"+e.host];if(i)return r.stats.response.forward++,r.responseRedirect(e,t,i.url+(i.path?e.url:""),i.permanent),r}if(r.restrictions.isRestrictions){if(r.restrictions.isAllowedIP&&-1===r.restrictions.allowedIP.indexOf(e.ip))return r.stats.response.restriction++,e.connection.destroy(),r;if(r.restrictions.isBlockedIP&&-1!==r.restrictions.blockedIP.indexOf(e.ip))return r.stats.response.restriction++,e.connection.destroy(),r;if(r.restrictions.isAllowedCustom&&!r.restrictions._allowedCustom(n))return r.stats.response.restriction++,e.connection.destroy(),r;if(r.restrictions.isBlockedCustom&&r.restrictions._blockedCustom(n))return r.stats.response.restriction++,e.connection.destroy(),r}if(e.uri=parser.parse(o+"://"+e.host+e.url),e.path=framework_internal.routeSplit(e.uri.pathname),e.body={},e.files=[],e.processing=0,e.session=null,e.user=null,e.isAuthorized=!0,e.xhr="XMLHttpRequest"===n["x-requested-with"],t.success=!1,t.setHeader("X-Powered-By","total.js v"+r.version_header),r.isDebug&&t.setHeader("Mode","debug"),e.isStaticFile=framework.config["allow-handle-static-files"]?utils.isStaticFile(e.uri.pathname):!1,r._request_stats(!0,!0),0===r._length_request_middleware)return r._request_continue(e,t,n,o);for(var s=[],a=0;a<r._length_request_middleware;a++){var u=r.routes.middleware[r.routes.request[a]];u?!function(r){s.push(function(n){r.call(framework,e,t,n)})}(u):r.error("Middleware not found: "+route.middleware[a],null,e.uri)}s._async_middleware(t,function(){r._request_continue(e,t,n,o)})},Framework.prototype._request_continue=function(e,t,r,n){var o=this;if(null===e||null===t||t.headersSent||t.success)return o;if(e.isStaticFile)return o.stats.request.file++,0===o._length_files?(o.responseStatic(e,t),o):(new Subscribe(o,e,t,3).file(),o);e.isProxy="total.js"===r["x-proxy"],e.flags=null,e.buffer_exceeded=!1,e.buffer_data="",e.buffer_has=!1;var i=!1,s=r.accept;o.stats.request.web++,e.uri.query&&e.uri.query.length>0&&null!==o.onXSS&&(i=o.onXSS(e.uri.query));var a=[e.method.toLowerCase()],u=e.headers["content-type"]||"";if(a.push(n),-1===u.indexOf("/form-data")&&(-1!==u.indexOf("/json")?a.push("json"):-1!==u.indexOf("/xml")&&a.push("xml"),-1===u.indexOf("mixed")?u="":a.push("mmr")),u.length>0&&a.push("upload"),e.isProxy&&a.push("proxy"),"text/event-stream"===s&&a.push("sse"),o.config.debug&&a.push("debug"),e.xhr&&(o.stats.request.xhr++,a.push("xhr")),i&&(a.push("xss"),o.stats.request.xss++),o._request_check_referer){var l=r.referer||"";""!==l&&-1!==l.indexOf(r.host)&&a.push("referer")}e.flags=a,o.emit("request-begin",e,t);var c=e.method;return"GET"===c||"DELETE"===c||"OPTIONS"===c?("DELETE"===c?o.stats.request["delete"]++:o.stats.request.get++,new Subscribe(o,e,t,0).end(),o):!o._request_check_POST||"POST"!==c&&"PUT"!==c?(o.emit("request-end",e,t),o._request_stats(!1,!1),o.stats.request.blocked++,e.connection.destroy(),o):(u.length>0?(o.stats.request.upload++,new Subscribe(o,e,t,2).multipart(u)):("PUT"===c?o.stats.request.put++:o.stats.request.post++,new Subscribe(o,e,t,1).urlencoded()),o)},Framework.prototype._upgrade=function(e,t,r){if("websocket"===(e.headers.upgrade||"").toLowerCase()){var n=this,o=e.headers;if(n.emit("websocket",e,t,r),n.stats.request.websocket++,n.restrictions.isRestrictions){if(n.restrictions.isAllowedIP&&-1===n.restrictions.allowedIP.indexOf(e.ip))return n.stats.response.restriction++,e.connection.destroy(),n;if(n.restrictions.isBlockedIP&&-1!==n.restrictions.blockedIP.indexOf(e.ip))return n.stats.response.restriction++,e.connection.destroy(),n;if(n.restrictions.isAllowedCustom&&!n.restrictions._allowedCustom(o))return n.stats.response.restriction++,e.connection.destroy(),n;if(n.restrictions.isBlockedCustom&&n.restrictions._blockedCustom(o))return n.stats.response.restriction++,e.connection.destroy(),n}e.uri=parser.parse((e.connection.encrypted||"https"===o["x-forwarded-protocol"]||"wss"===o["x-forwarded-protocol"]?"wss":"ws")+"://"+e.headers.host+e.url),e.session=null,e.user=null,e.flags=[e.isSecure?"https":"http","get"];var i=utils.path(e.uri.pathname),s=new WebSocketClient(e,t,r);if(e.path=framework_internal.routeSplit(e.uri.pathname),0===n._length_request_middleware)return n._upgrade_prepare(e,s,i,o);for(var a=[],u=0;u<n._length_request_middleware;u++){var l=n.routes.middleware[n.routes.request[u]];l?!function(t){a.push(function(r){t.call(framework,e,null,r)})}(l):n.error("Middleware not found: "+route.middleware[u],null,e.uri)}a._async_middleware(s,function(){n._upgrade_prepare(e,s,i,o)})}},Framework.prototype._upgrade_prepare=function(e,t,r){var n=this;if(null===n.onAuthorization){var o=n.lookup_websocket(e,t.uri.pathname,!0);return null===o?(t.close(),void e.connection.destroy()):void n._upgrade_continue(o,e,t,r)}n.onAuthorization.call(n,e,t,e.flags,function(o,i){i&&(e.user=i),e.flags.push(o?"authorize":"unauthorize");var s=n.lookup_websocket(e,t.uri.pathname,!1);return null===s?(t.close(),void e.connection.destroy()):void n._upgrade_continue(s,e,t,r)})},Framework.prototype._upgrade_continue=function(e,t,r,n){var o=this;if(!r.prepare(e.flags,e.protocols,e.allow,e.length,o.version_header))return r.close(),t.connection.destroy(),o;var i=n+(e.flags.length>0?"#"+e.flags.join("-"):"");e.isBINARY?r.type=1:e.isJSON&&(r.type=3);var s=function(){if(void 0===o.connections[i]){var s=new WebSocket(o,n,e.name,i);o.connections[i]=s,e.onInitialize.apply(s,framework_internal.routeParam(e.param.length>0?framework_internal.routeSplit(t.uri.pathname,!0):t.path,e))}r.upgrade(o.connections[i])};if(e.middleware instanceof Array&&e.middleware.length>0){for(var a=[],u=0,l=e.middleware.length;l>u;u++){var c=framework.routes.middleware[file.middleware[u]];c&&!function(r){a.push(function(n){r.call(framework,t,res,n,e.options)})}(c)}return a._async_middleware(res,s),o}return s(),o},Framework.prototype._request_stats=function(e){var t=this;return e?t.stats.request.pending++:t.stats.request.pending--,t.stats.request.pending<0&&(t.stats.request.pending=0),t},Framework.prototype.model=function(e){var t=this,r=t.models[e];if(r||null===r)return r;if(void 0!==t.models[e])return t.models[e];var n=path.join(directory,t.config["directory-models"],e+EXTENSION_JS);return fs.existsSync(n)&&t.install("model",e,n,void 0,void 0,void 0,!0),t.models[e]||null},Framework.prototype.source=function(e){var t=this,r=t.sources[e];if(r||null===r)return r;if(void 0!==t.sources[e])return t.sources[e];var n=path.join(directory,t.config["directory-source"],e+EXTENSION_JS);return fs.existsSync(n)&&t.install("source",e,n,void 0,void 0,void 0,!0),t.sources[e]||null},Framework.prototype.include=function(e,t,r){return this.source(e,t,r)},Framework.prototype._log=function(){var e=this;if(!e.isDebug)return!1;for(var t=arguments.length,r=["---->"],n=0;t>n;n++)r.push(arguments[n]);setTimeout(function(){console.log.apply(console,r)},1e3)},Framework.prototype.mail=function(){var e=new Controller("",null,null,null);if(typeof layout===OBJECT){var t=repository;repository=layout,layout=t}return e.layoutName=layout||"",typeof repository===OBJECT&&null!==repository&&(e.repository=repository),e.mail.apply(e,arguments),self},Framework.prototype.view=function(e,t,r,n){var o=new Controller("",null,null,null);if(typeof r===OBJECT){var i=n;n=r,r=i}o.layoutName=r||"",typeof n===OBJECT&&null!==n&&(o.repository=n);var s=o.view(e,t,!0);return o=null,s},Framework.prototype.assert=function(e,t,r,n,o,i,s){var a=this;if(typeof t===TYPE_FUNCTION)return a.tests.push({name:_test+": "+e,priority:framework.testsPriority,index:a.tests.length,run:t}),a;var u="GET",l=0,c=0;if(s=utils.extend({},s||{}),r instanceof Array){l=r.length;for(var p=0;l>p;p++)switch(r[p].toLowerCase()){case"xhr":s["X-Requested-With"]="XMLHttpRequest";break;case"json":s["Content-Type"]="application/json",c=1;break;case"xml":s["Content-Type"]="text/xml",c=2;break;case"get":case"delete":case"options":u=r[p].toUpperCase();break;case"upload":s["Content-Type"]="multipart/form-data";break;case"post":case"put":u=r[p].toUpperCase(),s["Content-Type"]||(s["Content-Type"]="application/x-www-form-urlencoded")}}if(s["X-Assertion-Testing"]="1",s["X-Powered-By"]="total.js v"+a.version_header,i){var f=[],d=Object.keys(i);l=d.length;for(var p=0;l>p;p++)f.push(d[p]+"="+encodeURIComponent(i[d[p]]));f.length>0&&(s.Cookie=f.join("; "))}var m={name:_test+": "+e,priority:framework.testsPriority,index:a.tests.length,url:t,callback:n,method:u,data:o,headers:s};return a.tests.push(m),a},Framework.prototype.testing=function(e,t){void 0===e&&(e=!0);var r=this;if(0===r.tests.length)return t&&t(framework.isTestError===!0),e&&r.stop(framework.isTestError?1:0),r;var n=function(e,t,r){var n=Math.floor(new Date-t)+" ms";return r?(framework.isTestError=!0,void console.error("Failed [x] ".padRight(20,".")+" "+e+" <"+(-1!==r.name.toLowerCase().indexOf("assert")?r.toString():r.stack)+"> ["+n+"]")):void console.info("Passed ".padRight(20,".")+" "+e+" ["+n+"]")},o=r.tests.shift(),i=o.name,s=new Date;if(o.run){try{framework.testContinue=function(o){n(i,s,o),o?framework.testsNO++:framework.testsOK++,r.testing(e,t)},o.run.call(r,function(){r.testContinue()},i)}catch(a){n(i,s,a),framework.isTestError=!0,framework.testsNO++,r.testing(e,t)}return r}var u=function(a){a._buffer="",a.on("data",function(e){this._buffer+=e.toString(ENCODING)}),a.on("end",function(){var u=a.headers.cookie||"",l={};if(0!==u.length)for(var c=u.split(";"),p=c.length,f=0;p>f;f++){var d=c[f].trim().split("=");l[d.shift()]=unescape(d.join("="))}try{o.callback(null,a._buffer,a.statusCode,a.headers,l,i),n(i,s),framework.testsOK++,r.testing(e,t)}catch(m){throw framework.testsNO++,n(i,s,m),r.testing(e,t),m}}),a.resume()},l=parser.parse((o.url.indexOf("http://")>0||o.url.indexOf("https://")>0?"":"http://"+r.ip+":"+r.port)+o.url);typeof o.data===TYPE_FUNCTION&&(o.data=o.data()),typeof o.data!==STRING&&(o.data=-1!==(o.headers[RESPONSE_HEADER_CONTENTTYPE]||"").indexOf("json")?JSON.stringify(o.data):qs.stringify(o.data)),o.data&&o.data.length>0&&(o.headers[RESPONSE_HEADER_CONTENTLENGTH]=o.data.length),l.method=o.method,l.headers=o.headers;var c="https:"===l.protocol?https:http,p="POST"===o.method||"PUT"===o.method?c.request(l,u):c.get(l,u);return p.on("error",function(o){n(i,s,o),r.testsNO++,r.testing(e,t)}),o.data&&o.data.length>0?p.end(o.data,ENCODING):p.end(),r},Framework.prototype.test=function(e,t,r){var n=this;void 0===e&&(e=!0),typeof t===TYPE_FUNCTION?(r=t,t=[]):t=t||[];var o=0;n.isTest=!0;var i=n.config["directory-tests"];if(!fs.existsSync(utils.combine(i)))return r&&r(),e&&setTimeout(function(){framework.stop(0)},500),n;n._configure("config-test",!0);var s=function(e,t,r){var n=Math.floor(new Date-t)+" ms";return r?(framework.isTestError=!0,void console.error("Failed [x] ".padRight(20,".")+" "+e+" <"+(-1!==r.name.toLowerCase().indexOf("assert")?r.toString():r.stack)+"> ["+n+"]")):void console.info("Passed ".padRight(20,".")+" "+e+" ["+n+"]")},a=function(){0!==framework.testsResults.length&&(console.log(""),console.log("====== RESULTS ======"),console.log(""),framework.testsResults.forEach(function(e){e()}))};return framework.testsResults||(framework.testsResults=[]),framework.testsOK||(framework.testsOK=0),framework.testsNO||(framework.testsNO=0),utils.ls(utils.combine(i),function(u){return u.forEach(function(e){var r=path.relative(utils.combine(i),e),a=path.join(directory,e),u=path.extname(a).toLowerCase();if(!(u!==EXTENSION_JS&&u!==EXTENSION_COFFEE||t.length>0&&-1===t.indexOf(r.substring(0,r.length-3)))){var l=require(a),c=new Date;try{var p=void 0!==l.run,f=void 0!==l.isInstall,d=void 0!==l.init,m=void 0!==l.load;if(_test=r,l.disabled===!0)return;framework.testsPriority=void 0===l.order&&void 0===l.priority?n.tests.length:l.priority,p?l.run(n,r):f?l.install(n,r):d?l.init(n,r):m&&l.load(n,r),l.usage&&!function(e){framework.testsResults.push(function(){e.usage(r)})}(l),o++}catch(h){s("Failed",c,h)}}}),_test="",0===o?(a(),r&&r(),e?(setTimeout(function(){framework.stop(1)},500),n):n):(n.tests.sort(function(e,t){return e.priority>t.priority?1:e.priority<t.priority?-1:e.index>t.index?1:e.index<t.index?-1:0}),void setTimeout(function(){console.log("====== TESTING ======"),console.log(""),n.testing(e,function(){console.log(""),console.log("Passed ...",framework.testsOK),console.log("Failed ...",framework.testsNO),console.log(""),a(),n.isTest=!1,console.log(""),r&&r()})},100))}),n},Framework.prototype.clear=function(){var e=this,t=utils.combine(e.config["directory-temp"]);return fs.existsSync(t)?(framework_utils.ls(t,function(t,r){e.unlink(t,function(){e.rmdir(r)})}),e.temporary.path={},e.temporary.range={},this):e},Framework.prototype.unlink=function(e,t){var r=this;if(typeof e===STRING&&(e=[e]),0===e.length)return void(t&&t());var n=e.shift();return n?(fs.unlink(n,function(){r.unlink(e,t)}),r):void(t&&t())},Framework.prototype.rmdir=function(e,t){var r=this;if(typeof e===STRING&&(e=[e]),0===e.length)return void(t&&t());var n=e.shift();return n?(fs.rmdir(n,function(){r.rmdir(e,t)}),r):void(t&&t())},Framework.prototype.encrypt=function(e,t,r){var n=this;if(void 0===e)return"";var o=typeof e;if(typeof t===BOOLEAN){var i=r;r=t,t=i}return o===TYPE_FUNCTION&&(e=e()),o===NUMBER&&(e=e.toString()),o===OBJECT&&(e=JSON.stringify(e)),e.encrypt(n.config.secret+"="+t,r)},Framework.prototype.decrypt=function(e,t,r){if(typeof t===BOOLEAN){var n=r;r=t,t=n}typeof r!==BOOLEAN&&(r=!0);var o=this,i=(e||"").decrypt(o.config.secret+"="+t);if(null===i)return null;if(r){if(i.isJSON())try{return JSON.parse(i)}catch(s){}return null}return i},Framework.prototype.hash=function(e,t,r){var n=crypto.createHash(e),o="";return typeof r===STRING?o=r:r!==!1&&(o=this.config.secret||""),n.update(t.toString()+o,ENCODING),n.digest("hex")},Framework.prototype.resource=function(e,t){(void 0===t||0===e.length)&&(t=e,e="default");var r=this,n=r.resources[e];if(void 0!==n)return n[t];var o=utils.combine(r.config["directory-resources"],e+".resource");if(!fs.existsSync(o))return"";var i=fs.readFileSync(o).toString(ENCODING).parseConfig();return r.resources[e]=i,i[t]||""},Framework.prototype._configure_versions=function(e){var t=this;if(void 0===e){var r=utils.combine("/","versions");e=fs.existsSync(r)?fs.readFileSync(r).toString(ENCODING):"",t.versions=null}return 0===(e||"").length?(t.versions=null,t):(t.versions=e.parseConfig(),t)},Framework.prototype._configure=function(e,t){var r=this,n=typeof e;if(n===STRING){var o=utils.combine("/",e);if(!fs.existsSync(o))return r;e=fs.readFileSync(o).toString(ENCODING).split("\n")}if(void 0===e){var i=utils.combine("/","config"),s=utils.combine("/","config-"+(r.config.debug?"debug":"release"));e=[],fs.existsSync(i)&&fs.lstatSync(i).isFile()&&(e=e.concat(fs.readFileSync(i).toString(ENCODING).split("\n"))),fs.existsSync(s)&&fs.lstatSync(s).isFile()&&(e=e.concat(fs.readFileSync(s).toString(ENCODING).split("\n")))}if(!e instanceof Array)return r;if(0===e.length)return r;void 0===t&&(t=!0);for(var a={},u=null,l=e.length,c=0;l>c;c++){var p=e[c];if(""!==p&&"#"!==p[0]&&"/"!==p[0]&&"/"!==p[1]){var f=p.indexOf(":");if(-1!==f){var d=p.substring(0,f).trim();if("debug"!==d&&"resources"!==d){var m=p.substring(f+1).trim();switch(d){case"default-request-length":case"default-websocket-request-length":case"default-request-timeout":case"default-interval-clear-cache":case"default-interval-clear-resources":case"default-interval-precompile-views":case"default-interval-websocket-ping":a[d]=utils.parseInt(m);break;case"static-accepts-custom":u=m.replace(/\s/g,"").split(",");break;case"static-accepts":a[d]=m.replace(/\s/g,"").split(",");break;case"allow-gzip":case"allow-websocket":case"allow-compile-js":case"allow-compile-css":case"allow-compile-html":case"allow-performance":case"disable-strict-server-certificate-validation":a[d]="true"===m.toLowerCase()||"1"===m;break;case"allow-compress-html":a["allow-compile-html"]="true"===m.toLowerCase()||"1"===m;break;case"version":a[d]=m;break;default:a[d]=m.isNumber()?utils.parseInt(m):m.isNumber(!0)?utils.parseFloat(m):m.isBoolean()?"true"===m.toLowerCase():m}}}}}return utils.extend(r.config,a,t),""===r.config["etag-version"]&&(r.config["etag-version"]=r.config.version.replace(/\.|\s/g,"")),process.title="total: "+r.config.name.removeDiacritics().toLowerCase().replace(/\s/g,"-").substring(0,8),null!==u&&u.length>0&&u.forEach(function(e){-1===r.config["static-accepts"].indexOf(e)&&r.config["static-accepts"].push(e)}),r.config["allow-performance"]&&(http.globalAgent.maxSockets=9999),r.emit("configure",r.config),r},Framework.prototype.routeJS=function(e){var t=this;return-1===e.lastIndexOf(EXTENSION_JS)&&(e+=EXTENSION_JS),t._routeStatic(e,t.config["static-url-js"])},Framework.prototype.routeCSS=function(e){var t=this;return-1===e.lastIndexOf(".css")&&(e+=".css"),t._routeStatic(e,t.config["static-url-css"])},Framework.prototype.routeImage=function(e){var t=this;return t._routeStatic(e,t.config["static-url-image"])},Framework.prototype.routeVideo=function(e){var t=this;return t._routeStatic(e,t.config["static-url-video"])},Framework.prototype.routeFont=function(e){var t=this;return t._routeStatic(e,t.config["static-url-font"])},Framework.prototype.routeDownload=function(e){var t=this;return t._routeStatic(e,t.config["static-url-download"])},Framework.prototype.routeStatic=function(e){var t=this;return t._routeStatic(e,t.config["static-url"])},Framework.prototype._routeStatic=function(e,t){return t+this._version(e)},Framework.prototype._version=function(e){var t=this;return null!==t.versions&&(e=t.versions[e]||e),null!==t.onVersion&&(e=t.onVersion(e)||e),e},Framework.prototype.lookup=function(e,t,r,n,o){var i=this,s="#"===t[0];s&&(e.path=[t]);var a="lookup#"+e.url;if(!s&&!o&&i.temporary.other[a])return i.temporary.other[a];for(var u=null===e.subdomain?null:e.subdomain.join("."),l=i.routes.web.length,c=0;l>c;c++){var p=i.routes.web[c];if(framework_internal.routeCompareSubdomain(u,p.subdomain)){if(p.isASTERIX){if(!framework_internal.routeCompare(e.path,p.url,s,!0))continue}else if(!framework_internal.routeCompare(e.path,p.url,s))continue;if(s)return p;if(null!==p.flags&&p.flags.length>0){var f=framework_internal.routeCompareFlags2(e,p,n?!0:p.isMEMBER);if(-1===f&&(e.isAuthorized=!1),1>f)continue}else if(-1!==r.indexOf("xss"))continue;return i.lookup_cache(e,p,a)}}return null},Framework.prototype.lookup_cache=function(e,t,r,n){return n===!0||t.isASTERIX||!t.isMEMBER||t.param.length>0?t:(this.temporary.other[r]=t,t)},Framework.prototype.lookup_websocket=function(e,t,r){for(var n=this,o=null===e.subdomain?null:e.subdomain.join("."),i=n.routes.websockets.length,s=0;i>s;s++){var a=n.routes.websockets[s];if(framework_internal.routeCompareSubdomain(o,a.subdomain)){if(a.isASTERIX){if(!framework_internal.routeCompare(e.path,a.url,!1,!0))continue}else if(!framework_internal.routeCompare(e.path,a.url,!1))continue;if(null!==a.flags&&a.flags.length>0){var u=framework_internal.routeCompareFlags2(e,a,r?!0:a.isMEMBER);if(-1===u&&(e.isAuthorized=!1),1>u)continue}return a}}return null},Framework.prototype.accept=function(e,t){var r=this;return"."!==e[0]&&(e="."+e),-1===r.config["static-accepts"].indexOf(e)&&r.config["static-accepts"].push(e),t&&utils.setContentType(e,t),r},Framework.prototype.accepts=function(e,t){return console.log("OBSOLETE: framework.accepts(), use: framework.accept()"),this.accept(e,t)},Framework.prototype.worker=function(e,t,r){var n=this,o=null,i=typeof t;if(i===NUMBER&&void 0===r&&(r=t,t=null,i=UNDEFINED),i===STRING&&(o=n.workers[t]||null),null!==o)return o;var s=utils.combine(n.config["directory-workers"],e)+EXTENSION_JS;return o=child.fork(s,{cwd:directory}),t=e+"_"+(new Date).getTime(),o.__id=t,n.workers[t]=o,o.on("exit",function(){var e=this;e.__timeout&&clearTimeout(e.__timeout),delete framework.workers[e.__id]}),typeof r!==NUMBER?o:(o.__timeout=setTimeout(function(){o.kill(),o=null},r),o)},FrameworkRestrictions.prototype.allow=function(e,t){var r=this;return void 0===t?(r.allowedIP.push(e),r.refresh(),framework):(void 0===r.allowedCustom[e]?r.allowedCustom[e]=[t]:r.allowedCustom[e].push(t),r.refresh(),framework)},FrameworkRestrictions.prototype.disallow=function(e,t){var r=this;return void 0===t?(r.blockedIP.push(e),r.refresh(),framework):(void 0===r.blockedCustom[e]?r.blockedCustom[e]=[t]:r.blockedCustom[e].push(t),r.refresh(),framework)},FrameworkRestrictions.prototype.refresh=function(){var e=this;return e.isAllowedIP=e.allowedIP.length>0,e.isBlockedIP=e.blockedIP.length>0,e.isAllowedCustom=!utils.isEmpty(e.allowedCustom),e.isBlockedCustom=!utils.isEmpty(e.blockedCustom),e.allowedCustomKeys=Object.keys(e.allowedCustom),e.blockedCustomKeys=Object.keys(e.blockedCustom),e.isRestrictions=e.isAllowedIP||e.isBlockedIP||e.isAllowedCustom||e.isBlockedCustom,framework},FrameworkRestrictions.prototype.clearIP=function(){var e=this;return e.allowedIP=[],e.blockedIP=[],e.refresh(),framework},FrameworkRestrictions.prototype.clearHeaders=function(){var e=this;return e.allowedCustom={},e.blockedCustom={},e.allowedCustomKeys=[],e.blockedCustomKeys=[],e.refresh(),framework},FrameworkRestrictions.prototype._allowedCustom=function(e){for(var t=this,r=t.allowedCustomKeys.length,n=0;r>n;n++){var o=t.allowedCustomKeys[n],i=e[o];if(void 0===i)return!1;for(var s=t.allowedCustom[o],a=s.length,u=0;a>u;u++)if(-1!==i.search(s[u]))return!1}return!0},FrameworkRestrictions.prototype._blockedCustom=function(e){for(var t=this,r=t.blockedCustomKeys.length,n=0;r>n;n++){var o=t.blockedCustomKeys[n],i=e[o];if(void 0===i)return!1;for(var s=t.blockedCustom[o],a=s.length,u=0;a>u;u++)if(-1!==i.search(s[u]))return!0}return!1},FrameworkFileSystem.prototype.deleteCSS=function(e){var t=this;-1===e.lastIndexOf(".css")&&(e+=".css");var r=utils.combine(framework.config["directory-public"],framework.config["static-url-css"],e);return t.deleteFile(r)},FrameworkFileSystem.prototype.deleteJS=function(e){var t=this;-1===e.lastIndexOf(EXTENSION_JS)&&(e+=EXTENSION_JS);var r=utils.combine(framework.config["directory-public"],framework.config["static-url-js"],e);return t.deleteFile(r)},FrameworkFileSystem.prototype.deleteView=function(e){var t=this;
-1===e.lastIndexOf(".html")&&(e+=".html");var r=utils.combine(framework.config["directory-views"],e);return t.deleteFile(r)},FrameworkFileSystem.prototype.deleteDatabase=function(e){var t=this,r=utils.combine(framework.config["directory-databases"],e);return t.deleteFile(r)},FrameworkFileSystem.prototype.deleteWorker=function(e){var t=this;-1===e.lastIndexOf(EXTENSION_JS)&&(e+=EXTENSION_JS);var r=utils.combine(framework.config["directory-workers"],e);return t.deleteFile(r)},FrameworkFileSystem.prototype.deleteResource=function(e){var t=this;-1===e.lastIndexOf(".resource")&&(e+=".resource");var r=utils.combine(framework.config["directory-resources"],e);return t.deleteFile(r)},FrameworkFileSystem.prototype.deleteTemporary=function(e){var t=this,r=utils.combine(framework.config["directory-temp"],e);return t.deleteFile(r)},FrameworkFileSystem.prototype.deleteFile=function(e){return fs.exists(e,function(t){t&&fs.unlink(e)}),!0},FrameworkFileSystem.prototype.createCSS=function(e,t,r,n){var o=this;if(0===(t||"").length)return!1;-1===e.lastIndexOf(".css")&&(e+=".css");var i=utils.combine(framework.config["directory-public"],framework.config["static-url-css"],e);return o.createFile(i,t,n,r)},FrameworkFileSystem.prototype.createJS=function(e,t,r,n){var o=this;if(0===(t||"").length)return!1;-1===e.lastIndexOf(EXTENSION_JS)&&(e+=EXTENSION_JS);var i=utils.combine(framework.config["directory-public"],framework.config["static-url-js"],e);return o.createFile(i,t,n,r)},FrameworkFileSystem.prototype.createDatabase=function(e,t,r,n){var o=this;if(0===(t||"").length)return!1;var i=utils.combine(framework.config["directory-databases"],e);return o.createFile(i,t,n,r)},FrameworkFileSystem.prototype.createView=function(e,t,r,n){var o=this;if(0===(t||"").length)return!1;-1===e.lastIndexOf(".html")&&(e+=".html"),framework._verify_directory("views");var i=utils.combine(framework.config["directory-views"],e);return o.createFile(i,t,n,r)},FrameworkFileSystem.prototype.createWorker=function(e,t,r,n){var o=this;if(0===(t||"").length)return!1;-1===e.lastIndexOf(EXTENSION_JS)&&(e+=EXTENSION_JS),framework._verify_directory("workers");var i=utils.combine(framework.config["directory-workers"],e);return o.createFile(i,t,n,r)},FrameworkFileSystem.prototype.createResource=function(e,t,r,n){var o=this;if(0===(t||"").length)return!1;-1===e.lastIndexOf(".resource")&&(e+=".resource");var i=t;typeof t===OBJECT&&(i="",Object.keys(t).forEach(function(e){i+=e.padRight(20," ")+": "+t[e]+"\n"})),framework._verify_directory("resources");var s=utils.combine(framework.config["directory-resources"],e);return o.createFile(s,i,n,r)},FrameworkFileSystem.prototype.createTemporary=function(e,t,r){var n=this;framework._verify_directory("temp");var o=utils.combine(framework.config["directory-temp"],e),i=fs.createWriteStream(o);return r&&(i.on("error",function(e){r(e,o)}),i.on("end",function(){r(null,o)})),t.pipe(i),n},FrameworkFileSystem.prototype.createFile=function(e,t,r,n,o){var i=this;if("http://"===t.substring(0,7)||"https://"===t.substring(0,8))return utils.request(t,["get"],function(t,s){t||i.createFile(e,s,r,n),typeof o===TYPE_FUNCTION&&o(t,e)}),!0;if(0===(t||"").length)return!1;var s=fs.existsSync(e);if(s&&r){var a=fs.readFileSync(e).toString(ENCODING);return-1===a.indexOf(t)?(fs.appendFileSync(e,"\n"+t),!0):!1}return s&&!n?!1:(fs.writeFileSync(e,t,ENCODING),typeof o===TYPE_FUNCTION&&o(null,e),!0)},FrameworkPath.prototype.public=function(e){return framework._verify_directory("public"),utils.combine(framework.config["directory-public"],e||"").replace(/\\/g,"/")},FrameworkPath.prototype.logs=function(e){return framework._verify_directory("logs"),utils.combine(framework.config["directory-logs"],e||"").replace(/\\/g,"/")},FrameworkPath.prototype.models=function(e){return utils.combine(framework.config["directory-models"],e||"").replace(/\\/g,"/")},FrameworkPath.prototype.temp=function(e){return framework._verify_directory("temp"),utils.combine(framework.config["directory-temp"],e||"").replace(/\\/g,"/")},FrameworkPath.prototype.temporary=function(e){return this.temp(e)},FrameworkPath.prototype.views=function(e){return framework._verify_directory("views"),utils.combine(framework.config["directory-views"],e||"").replace(/\\/g,"/")},FrameworkPath.prototype.workers=function(e){return framework._verify_directory("workers"),utils.combine(framework.config["directory-workers"],e||"").replace(/\\/g,"/")},FrameworkPath.prototype.databases=function(e){return framework._verify_directory("databases"),utils.combine(framework.config["directory-databases"],e||"").replace(/\\/g,"/")},FrameworkPath.prototype.contents=function(e){return framework._verify_directory("contents"),utils.combine(framework.config["directory-contents"],e||"").replace(/\\/g,"/")},FrameworkPath.prototype.modules=function(e){return framework._verify_directory("modules"),utils.combine(framework.config["directory-modules"],e||"").replace(/\\/g,"/")},FrameworkPath.prototype.controllers=function(e){return framework._verify_directory("controllers"),utils.combine(framework.config["directory-controllers"],e||"").replace(/\\/g,"/")},FrameworkPath.prototype.definitions=function(e){return framework._verify_directory("definitions"),utils.combine(framework.config["directory-definitions"],e||"").replace(/\\/g,"/")},FrameworkPath.prototype.tests=function(e){return framework._verify_directory("tests"),utils.combine(framework.config["directory-tests"],e||"").replace(/\\/g,"/")},FrameworkPath.prototype.resources=function(e){return framework._verify_directory("resources"),utils.combine(framework.config["directory-resources"],e||"").replace(/\\/g,"/")},FrameworkPath.prototype.root=function(e){return path.join(directory,e||"")},FrameworkPath.prototype.package=function(e,t){return path.join(directory,framework.config["directory-temp"],e,t||"")},FrameworkPath.prototype.packages=function(e){return path.join(directory,framework.config["directory-packages"],e||"")},FrameworkCache.prototype.init=function(e){var t=this;return t.interval=setInterval(function(){framework.cache.recycle()},e||6e4),t},FrameworkCache.prototype.stop=function(){var e=this;return clearInterval(e.interval),e},FrameworkCache.prototype.clear=function(){var e=this;return e.items={},e},FrameworkCache.prototype.recycle=function(){var e=this,t=e.items,r=Object.keys(t),n=r.length;if(e.count++,0===n)return framework._service(e.count),e;for(var o=new Date,i=0;n>i;i++){var s=r[i],a=t[s];a.expire<o&&(framework.emit("cache-expire",s,a.value),delete t[s])}return framework._service(e.count),e},FrameworkCache.prototype.add=function(e,t,r){var n=this,o=typeof r;switch(o){case STRING:r=r.parseDateExpire();break;case UNDEFINED:r=(new Date).add("m",5)}return n.items[e]={value:t,expire:r},t},FrameworkCache.prototype.read=function(e){return this.get(e)},FrameworkCache.prototype.get=function(e,t){var r=this,n=r.items[e]||null;return null===n?typeof t===UNDEFINED?null:t:n.expire<new Date?typeof t===UNDEFINED?null:t:n.value},FrameworkCache.prototype.setExpire=function(e,t){var r=this,n=r.items[e];return void 0===n?r:(typeof t===STRING&&(t=t.parseDateExpire()),n.expire=t,r)},FrameworkCache.prototype.remove=function(e){var t=this,r=t.items[e]||null;return delete t.items[e],r},FrameworkCache.prototype.removeAll=function(e){for(var t=this,r=0,n=Object.keys(t.items),o=n.length,i=utils.isRegExp(e),s=0;o>s;s++){if(i){if(!e.test(n[s]))continue}else if(-1===n[s].indexOf(e))continue;t.remove(n[s]),r++}return r},FrameworkCache.prototype.fn=function(e,t,r){var n=this,o=n.read(e);return null!==o?(r&&r(o),n):(t(function(t,o){n.add(e,t,o),r&&r(t)}),n)};var REPOSITORY_HEAD="$head",REPOSITORY_META="$meta",REPOSITORY_META_TITLE="$title",REPOSITORY_META_DESCRIPTION="$description",REPOSITORY_META_KEYWORDS="$keywords",REPOSITORY_META_IMAGE="$image",REPOSITORY_PLACE="$place",ATTR_END='"';Subscribe.prototype.success=function(){var e=this;return e.timeout&&clearTimeout(e.timeout),e.timeout=null,e.isCanceled=!0,e},Subscribe.prototype.file=function(){var e=this;return e.req.on("end",function(){e.doEndfile(this)}),e.req.resume(),e},Subscribe.prototype.multipart=function(e){var t=this,r=t.req;return t.route=framework.lookup(r,r.uri.pathname,r.flags,!0),t.header=e,null===t.route?(framework._request_stats(!1,!1),framework.stats.request.blocked++,r.connection.destroy(),t):-1===e.indexOf("mixed")?(framework._verify_directory("temp"),framework_internal.parseMULTIPART(r,e,t.route.maximumSize,framework.config["directory-temp"],function(e){return framework.onXSS?framework.onXSS(e):!0},function(){t.doEnd()}),t):(t.isMixed=!0,void t.execute())},Subscribe.prototype.urlencoded=function(){var e=this;return e.route=framework.lookup(e.req,e.req.uri.pathname,e.req.flags,!0),null===e.route?(e.req.clear(!0),framework.stats.request.blocked++,framework._request_stats(!1,!1),void e.req.connection.destroy()):(e.req.buffer_has=!0,e.req.buffer_exceeded=!1,e.req.on("data",function(t){e.doParsepost(t)}),void e.end())},Subscribe.prototype.end=function(){var e=this;e.req.on("end",function(){e.doEnd()}),e.req.resume()},Subscribe.prototype.execute=function(e){var t=this,r=t.route,n=t.req,o=t.res;if(e>399&&(null===r||"#"===r.name[0]))switch(e){case 400:framework.stats.response.error400++;break;case 401:framework.stats.response.error401++;break;case 403:framework.stats.response.error403++;break;case 404:framework.stats.response.error404++;break;case 408:framework.stats.response.error408++;break;case 431:framework.stats.response.error431++;break;case 500:framework.stats.response.error500++;break;case 501:framework.stats.response.error501++}if(null===r)return framework.responseContent(n,o,e||404,utils.httpStatus(e||404),CONTENTTYPE_TEXTPLAIN,framework.config["allow-gzip"]),t;var i=r.name,s=new Controller(i,n,o,t);if(s.isTransfer=t.isTransfer,s.exception=t.exception,t.controller=s,!t.isCanceled&&!t.isMixed&&r.timeout>0&&(t.timeout=setTimeout(function(){t.doCancel()},r.timeout)),0===framework._length_middleware||null===r.middleware)return t.doExecute();for(var a=[],u=r.middleware.length,l=0;u>l;l++){var c=framework.routes.middleware[r.middleware[l]];c?!function(e){a.push(function(t){e.call(s,n,o,t,r.options,s)})}(c):t.error("Middleware not found: "+r.middleware[l],s.name,n.uri)}return 0===a.length?t.doExecute():(a._async_middleware(o,function(){t.doExecute()}),t)},Subscribe.prototype.prepare=function(e,t){var r=this,n=r.req,o=r.res;return null!==framework.onAuthorization?void framework.onAuthorization(n,o,e,function(e,t){r.doAuthorization(e,t)}):(null===r.route&&(r.route=framework.lookup(n,n.buffer_exceeded?"#431":t||n.uri.pathname,e)),null===r.route&&(r.route=framework.lookup(n,-1===n.flags.indexOf("xss")?"#404":"#400",[])),void r.execute(n.buffer_exceeded?431:404))},Subscribe.prototype.doExecute=function(){var e=this,t=e.route.name,r=e.controller,n=e.req;try{if(r.isCanceled)return e;if(framework.emit("controller",r,t,e.route.options),r.isCanceled)return e;if(!e.isMixed)return e.route.onExecute.apply(r,framework_internal.routeParam(e.route.param.length>0?framework_internal.routeSplit(n.uri.pathname,!0):n.path,e.route)),e;framework._verify_directory("temp"),framework_internal.parseMULTIPART_MIXED(n,e.header,framework.config["directory-temp"],function(t){e.route.onExecute.call(r,t)},function(){e.doEnd()})}catch(o){r=null,framework.error(o,t,n.uri),e.route=framework.lookup(n,"#500",[]),e.execute(500)}return e},Subscribe.prototype.doAuthorization=function(e,t){var r=this,n=r.req;n.flags.push(e?"authorize":"unauthorize"),t&&(n.user=t);var o=framework.lookup(n,n.buffer_exceeded?"#431":n.uri.pathname,n.flags);return null===o&&(o=framework.lookup(n,n.isAuthorized?"#404":"#401",[])),r.route=o,r.execute(n.buffer_exceeded?431:404),r},Subscribe.prototype.doEnd=function(){var e=this,t=e.req,r=e.res,n=e.route;if(e.isMixed){t.clear(!0);var o={};return o[RESPONSE_HEADER_CONTENTTYPE]="text/plain; charset=utf-8",o[RESPONSE_HEADER_CACHECONTROL]="private, max-age=0",r.writeHead(200,o),r.end("END"),framework._request_stats(!1,!1),framework.emit("request-end",t,r),e}if(t.buffer_exceeded)return n=framework.lookup(t,"#431",[]),null===n?(framework.response431(t,r),e):(e.execute(431),e);if(0===t.buffer_data.length)return null===n||n.isXSS||-1===t.flags.indexOf("xss")?(e.prepare(t.flags,t.uri.pathname),e):(e.route400(new Error("Cross-site scripting.")),e);if(n.isJSON){try{if(-1===(t.headers["content-type"]||"").indexOf("application/json"))return e.route400(new Error("Request validation.")),e;if(!t.buffer_data.isJSON())return e.route400(new Error("Request validation.")),e;t.body=JSON.parse(t.buffer_data),t.buffer_data=null,e.prepare(t.flags,t.uri.pathname)}catch(i){e.route400(i)}return e}if(n.isXML){if(-1===(t.headers["content-type"]||"").indexOf("text/xml"))return e.route400(new Error("Request validation.")),e;try{t.body=utils.parseXML(t.buffer_data),t.buffer_data=null,e.prepare(t.flags,t.uri.pathname)}catch(i){e.route400(i)}return e}if(!e.route.isXSS&&null!==framework.onXSS&&framework.onXSS(t.buffer_data))return t.flags.push("xss"),framework.stats.request.xss++,e.route400(new Error("Cross-site scripting.")),e;if(e.route.isRAW)t.body=t.buffer_data;else{if(-1===(t.headers["content-type"]||"").indexOf("x-www-form-urlencoded"))return e.route400("Request validation."),e;t.body=qs.parse(t.buffer_data)}return e.prepare(t.flags,t.uri.pathname),e},Subscribe.prototype.route400=function(e){var t=this;return t.route=framework.lookup(t.req,"#400",[]),t.exception=e,t.execute(400),t},Subscribe.prototype.doEndfile=function(){for(var e=this,t=e.req,r=e.res,n=0;n<framework._length_files;n++){var o=framework.routes.files[n];try{if(o.onValidation.call(framework,t,r,!0))return null===o.middleware?o.onExecute.call(framework,t,r,!1):e.doEndfile_middleware(o),e}catch(i){return framework.error(i,o.controller+" :: "+o.name,t.uri),framework.responseContent(t,r,500,"500 - internal server error",CONTENTTYPE_TEXTPLAIN,framework.config["allow-gzip"]),e}}return framework.responseStatic(e.req,e.res),e},Subscribe.prototype.doEndfile_middleware=function(e){for(var t=[],r=e.middleware.length,n=this,o=n.req,i=n.res,s=0;r>s;s++){var a=framework.routes.middleware[e.middleware[s]];a&&!function(r){t.push(function(t){r.call(framework,o,i,t,e.options)})}(a)}return t._async_middleware(i,function(){try{e.onExecute.call(framework,o,i,!1)}catch(t){return framework.error(t,e.controller+" :: "+e.name,o.uri),framework.responseContent(o,i,500,"500 - internal server error",CONTENTTYPE_TEXTPLAIN,framework.config["allow-gzip"]),n}}),n},Subscribe.prototype.doParsepost=function(e){var t=this,r=t.req;return r.buffer_exceeded?t:(r.buffer_exceeded||(r.buffer_data+=e.toString()),r.buffer_data.length/1024<t.route.maximumSize?t:(r.buffer_exceeded=!0,r.buffer_data="",t))},Subscribe.prototype.doCancel=function(){var e=this;framework.stats.response.timeout++,clearTimeout(e.timeout),e.timeout=null,null!==e.controller&&(e.controller.isTimeout=!0,e.controller.isCanceled=!0,e.route=framework.lookup(e.req,"#408",[]),e.execute(408))},Controller.prototype={get sseID(){return this.req.headers["last-event-id"]||null},get flags(){return this.subscribe.route.flags},get path(){return framework.path},get fs(){return framework.fs},get get(){return this.req.query},get query(){return this.req.query},get post(){return this.req.body},get body(){return this.req.body},get files(){return this.req.files},get language(){return this.req.language},get subdomain(){return this.req.subdomain},get ip(){return this.req.ip},get xhr(){return this.req.xhr},get url(){return utils.path(this.req.uri.pathname)},get uri(){return this.req.uri},get cache(){return framework.cache},get config(){return framework.config},get controllers(){return framework.controllers},get isProxy(){return this.req.isProxy},get isDebug(){return framework.config.debug},get isTest(){return"1"===this.req.headers["x-assertion-testing"]},get isSecure(){return this.req.isSecure},get session(){return this.req.session},set session(e){this.req.session=e},get user(){return this.req.user},set user(e){this.req.user=e},get global(){return framework.global},set global(e){framework.global=e},get async(){var e=this;return typeof e._async===UNDEFINED&&(e._async=new utils.Async(e)),e._async}},Controller.prototype.validation=function(e,t,r,n){return this.validate(e,t,r,n)},Controller.prototype.clear=function(){var e=this;return e.req.clear(),e},Controller.prototype.middleware=function(e,t,r){if(typeof e===STRING&&(e=[e]),typeof t===TYPE_FUNCTION){r=t,t=r}(void 0===t||null===t)&&(t={});for(var n=this,o=[],i=e.length,s=0;i>s;s++){var a=framework.routes.middleware[e[s]];a&&!function(e,t){o.push(function(r){e.call(framework,n.req,n.res,r,t)})}(a,void 0===t[e[s]]?t:t[e[s]])}return o._async_middleware(n.res,r,controller),n},Controller.prototype.pipe=function(e,t,r){var n=this;if(typeof t===TYPE_FUNCTION){var o=r;r=t,t=o}return n.res.success||!n.isConnected?n:(framework.responsePipe(n.req,n.res,e,t,null,function(){n.subscribe.success(),r&&r()}),n)},Controller.prototype.encrypt=function(){return framework.encrypt.apply(framework,arguments)},Controller.prototype.decrypt=function(){return framework.decrypt.apply(framework,arguments)},Controller.prototype.hash=function(){return framework.hash.apply(framework,arguments)},Controller.prototype.date=function(e,t,r){void 0===r&&(r=t,t=new Date);var n=typeof t===STRING?t.parseDate():t,o=typeof r===STRING?r.parseDate():r,i=n.compare(o);switch(e){case">":return 1===i;case">=":case"=>":return 1===i||0===i;case"<":return-1===i;case"<=":case"=<":return-1===i||0===i;case"=":return 0===i}return!0},Controller.prototype.validate=function(e,t,r,n){var o=this,i=function(e){return o.resource(n||"default",(r||"")+e)};if(typeof t===STRING)return builders.validate(t,e,r);var s=new builders.ErrorBuilder(i);return utils.validate.call(o,e,t,framework.onValidation,s)},Controller.prototype.header=function(e,t){var r=this;return r.res.setHeader(e,t),r},Controller.prototype.host=function(e){var t=this;return t.req.hostname(e)},Controller.prototype.hostname=function(e){var t=this;return t.req.hostname(e)},Controller.prototype.cors=function(e,t,r,n){var o=this,i=o.req.headers.origin,s="OPTIONS"===o.req.method.toUpperCase();if(void 0===i)return!0;void 0===e&&(e="*"),typeof t===BOOLEAN&&(n=t,t=null),typeof r===BOOLEAN&&(n=r,r=null),utils.isArray(e)||(e=[e]);var a,u=!1,l=!1,c=o.req.headers;if(r){utils.isArray(r)||(r=[r]);for(var p=0;p<r.length;p++)if(c[r[p].toLowerCase()]){u=!0;break}if(!u)return!1;u=!1}if(t){utils.isArray(t)||(t=[t]);for(var f=c["access-control-request-method"]||o.req.method,p=0;p<t.length;p++)a=t[p].toUpperCase(),t[p]=a,-1!==f.indexOf(a)&&(u=!0);if(!u)return!1;u=!1}for(var p=0;p<e.length;p++)if(a=e[p],"*"===a||-1!==i.indexOf(a)){l="*"===a,u=!0;break}if(!u)return!1;var d,m;return o.res.setHeader("Access-Control-Allow-Origin",l?"*":i),n&&o.res.setHeader("Access-Control-Allow-Credentials","true"),m="Access-Control-Allow-Methods",t?o.res.setHeader(m,t.join(", ")):s&&(d=c["access-control-request-method"],d&&o.res.setHeader(m,d)),m="Access-Control-Allow-Headers",r?o.res.setHeader(m,r.join(", ")):s&&(d=c["access-control-request-headers"],d&&o.res.setHeader(m,d)),!0},Controller.prototype.error=function(e){var t=this,r=framework.error(typeof e===STRING?new Error(e):e,t.name,t.uri);return void 0===e?r:(t.subscribe.exception=e,t.exception=e,t)},Controller.prototype.problem=function(e){var t=this;return framework.problem(e,t.name,t.uri,t.ip),t},Controller.prototype.change=function(e){var t=this;return framework.change(e,t.name,t.uri,t.ip),t},Controller.prototype.wait=function(e,t,r){var n=this;return n.async.wait(e,t,r),n},Controller.prototype.await=function(e,t){var r=this;return r.async.await(e,t),r},Controller.prototype.complete=function(e){var t=this;return t.async.complete(e)},Controller.prototype.run=function(e){var t=this;return t.async.complete(e)},Controller.prototype.transfer=function(e,t){for(var r=this,n=framework.routes.web.length,o=framework_internal.routeSplit(e.trim()),i="#"===e[0],s=null===t||void 0===t||0===t.length,a=null,u=0;n>u;u++){var l=framework.routes.web[u];if(l.isASTERIX){if(!framework_internal.routeCompare(o,l.url,i,!0))continue}else if(!framework_internal.routeCompare(o,l.url,i))continue;if(s){a=l;break}if(null!==l.flags&&l.flags.length>0){var c=framework_internal.routeCompareFlags(l.flags,t,!0);if(-1===c&&(req.isAuthorized=!1),1>c)continue}else if(-1!==t.indexOf("xss"))continue;a=l;break}return a?(r.cancel(),r.req.path=[],r.subscribe.isTransfer=!0,r.subscribe.success(),r.subscribe.route=a,r.subscribe.execute(404,l.name!==r.name),!0):!1},Controller.prototype.cancel=function(){var e=this;return typeof e._async!==UNDEFINED&&e._async.cancel(),e.isCanceled=!0,e},Controller.prototype.log=function(){var e=this;return framework.log.apply(framework,arguments),e},Controller.prototype.meta=function(){var e=this;return e.repository[REPOSITORY_META_TITLE]=arguments[0]||"",e.repository[REPOSITORY_META_DESCRIPTION]=arguments[1]||"",e.repository[REPOSITORY_META_KEYWORDS]=arguments[2]||"",e.repository[REPOSITORY_META_IMAGE]=arguments[3]||"",e},Controller.prototype.$dns=function(){for(var e="",t=this,r=arguments.length,n=0;r>n;n++)e+='<link rel="dns-prefetch" href="'+t._prepareHost(arguments[n]||"")+'" />';return t.head(e),""},Controller.prototype.$prefetch=function(){for(var e="",t=this,r=arguments.length,n=0;r>n;n++)e+='<link rel="prefetch" href="'+t._prepareHost(arguments[n]||"")+'" />';return t.head(e),""},Controller.prototype.$prerender=function(){for(var e="",t=this,r=arguments.length,n=0;r>n;n++)e+='<link rel="prerender" href="'+t._prepareHost(arguments[n]||"")+'" />';return t.head(e),""},Controller.prototype.$next=function(e){var t=this;return t.head('<link rel="next" href="'+t._prepareHost(e||"")+'" />'),""},Controller.prototype.$prev=function(e){var t=this;return t.head('<link rel="prev" href="'+t._prepareHost(e||"")+'" />'),""},Controller.prototype.$canonical=function(e){var t=this;return t.head('<link rel="canonical" href="'+t._prepareHost(e||"")+'" />'),""},Controller.prototype.$meta=function(){var e=this;if(0!==arguments.length)return e.meta.apply(e,arguments),"";framework.emit("controller-render-meta",e);var t=e.repository;return framework.onMeta.call(e,t[REPOSITORY_META_TITLE],t[REPOSITORY_META_DESCRIPTION],t[REPOSITORY_META_KEYWORDS],t[REPOSITORY_META_IMAGE])},Controller.prototype.title=function(e){var t=this;return t.$title(e),t},Controller.prototype.description=function(e){var t=this;return t.$description(e),t},Controller.prototype.keywords=function(e){var t=this;return t.$keywords(e),t},Controller.prototype.$title=function(e){var t=this;return e?(t.repository[REPOSITORY_META_TITLE]=e,""):t.repository[REPOSITORY_META_TITLE]||""},Controller.prototype.$description=function(e){var t=this;return e?(t.repository[REPOSITORY_META_DESCRIPTION]=e,""):t.repository[REPOSITORY_META_DESCRIPTION]||""},Controller.prototype.$keywords=function(e){var t=this;return e?(t.repository[REPOSITORY_META_KEYWORDS]=e,""):t.repository[REPOSITORY_META_KEYWORDS]||""},Controller.prototype.sitemap=function(e,t,r){var n=this;return void 0===e?n.repository.sitemap||[]:(void 0===t&&(t=n.req.url),void 0===n.repository.sitemap&&(n.repository.sitemap=[]),n.repository.sitemap.push({name:e,url:t,index:r||n.repository.sitemap.length}),void 0!==r&&n.sitemap.length>1&&n.repository.sitemap.sort(function(e,t){return e.index<t.index?-1:e.index>t.index?1:0}),n)},Controller.prototype.$sitemap=function(){var e=this;return e.sitemap.apply(e,arguments),""},Controller.prototype.module=function(e){return framework.module(e)},Controller.prototype.layout=function(e){var t=this;return t.layoutName=e,t},Controller.prototype.$layout=function(e){var t=this;return t.layoutName=e,""},Controller.prototype.model=function(e){return framework.model(e)},Controller.prototype.models=function(e){var t=this;return(t.controllers[e||t.name]||{}).models},Controller.prototype.mail=function(e,t,r,n,o){typeof n===TYPE_FUNCTION&&(o=n,n=null);var i=this,s=i.view(r,n,!0);return framework.onMail(e,t,s,o),i},Controller.prototype.functions=function(e){var t=this;return(t.controllers[e||t.name]||{}).functions},Controller.prototype.notModified=function(e,t){var r=this;return framework.notModified(r.req,r.res,e,t)},Controller.prototype.setModified=function(e){var t=this;return framework.setModified(t.req,t.res,e),t},Controller.prototype.setExpires=function(e){var t=this;return void 0===e?t:(t.res.setHeader("Expires",e.toUTCString()),t)},Controller.prototype.$template=function(e,t,r){return this.$viewToggle(!0,e,t,r)},Controller.prototype.$templateToggle=function(e,t,r,n){return this.$viewToggle(e,t,r,n)},Controller.prototype.$view=function(e,t,r){return this.$viewToggle(!0,e,t,r)},Controller.prototype.$viewToggle=function(e,t,r,n){if(!e)return"";var o=this;if(n){var i=o.cache.read("$view."+t);if(null!==i)return i}var s=o.layoutName;o.layoutName="";var a=o.view(t,r,null,!0,n);return o.layoutName=s,n&&o.cache.add("$view."+t,a,n),a},Controller.prototype.place=function(e){var t=this,r=REPOSITORY_PLACE+"_"+e,n=arguments.length;if(1===n)return t.repository[r]||"";for(var o="",i=1;n>i;i++){var s=arguments[i];if(-1===s.indexOf("<"))if(-1!==s.lastIndexOf(EXTENSION_JS)){var a=s.substring(0,7),u="/"!==a[0]&&"/"!==a[1]&&"http://"!==a&&"https:/"!==a;o+='<script type="text/javascript" src="'+(u?t.routeJS(s):s)+'"></script>'}else o+=s;else o+=s}return t.repository[r]=(t.repository[r]||"")+o,t},Controller.prototype.$place=function(){var e=this;return 1===arguments.length?e.place.apply(e,arguments):(e.place.apply(e,arguments),"")},Controller.prototype.$url=function(e){var t=this;return e?t.req.hostname(t.url):t.url},Controller.prototype.$helper=function(){var e=this;return e.helper.apply(e,arguments)},Controller.prototype.$checked=function(e,t,r){var n=this;return n.$isValue(e,t,r,'checked="checked"')},Controller.prototype.$disabled=function(e,t,r){var n=this;return n.$isValue(e,t,r,'disabled="disabled"')},Controller.prototype.$selected=function(e,t,r){var n=this;return n.$isValue(e,t,r,'selected="selected"')},Controller.prototype.$set=function(){return""},Controller.prototype.$readonly=function(e,t,r){var n=this;return n.$isValue(e,t,r,'readonly="readonly"')},Controller.prototype.$header=function(e,t){return this.header(e,t),""},Controller.prototype.$text=function(e,t,r){return this.$input(e,"text",t,r)},Controller.prototype.$password=function(e,t,r){return this.$input(e,"password",t,r)},Controller.prototype.$hidden=function(e,t,r){return this.$input(e,"hidden",t,r)},Controller.prototype.$radio=function(e,t,r,n){return typeof n===STRING&&(n={label:n}),n.value=r,this.$input(e,"radio",t,n)},Controller.prototype.$checkbox=function(e,t,r){return typeof r===STRING&&(r={label:r}),this.$input(e,"checkbox",t,r)},Controller.prototype.$textarea=function(e,t,r){var n="<textarea";typeof r!==OBJECT&&(r={}),n+=' name="'+t+'" id="'+(r.id||t)+ATTR_END;for(var o=Object.keys(r),i=o.length,s=0;i>s;s++)switch(o[s]){case"name":case"id":break;case"required":case"disabled":case"readonly":case"value":n+=" "+o[s]+'="'+o[s]+ATTR_END;break;default:n+=" "+o[s]+'="'+r[o[s]].toString().encode()+ATTR_END}if(void 0===e)return n+"></textarea>";var a=e[t]||r.value||"";return n+">"+a.toString().encode()+"</textarea>"},Controller.prototype.$input=function(e,t,r,n){var o=["<input"];typeof n!==OBJECT&&(n={});var i=n.value||"";o+=' type="'+t+ATTR_END,o+="radio"===t?' name="'+r+ATTR_END:' name="'+r+'" id="'+(n.id||r)+ATTR_END,n.autocomplete&&(o+=n.autocomplete===!0||"on"===n.autocomplete?' autocomplete="on"':' autocomplete="off"');for(var s=Object.keys(n),a=s.length,u=0;a>u;u++)switch(s[u]){case"name":case"id":case"type":case"autocomplete":case"checked":case"value":case"label":break;case"required":case"disabled":case"readonly":case"autofocus":o+=" "+s[u]+'="'+s[u]+ATTR_END;break;default:o+=" "+s[u]+'="'+n[s[u]].toString().encode()+ATTR_END}var l="";return void 0!==e&&(l=e[r],"checkbox"===t&&(("1"===l||"true"===l||l===!0)&&(o+=' checked="checked"'),l=i||"1"),"radio"===t&&(i=(i||"").toString(),l.toString()===i&&(o+=' checked="checked"'),l=i||"")),o+=void 0!==l?' value="'+(l||"").toString().encode()+ATTR_END:' value="'+(n.value||"").toString().encode()+ATTR_END,o+=" />",n.label?"<label>"+o+" <span>"+n.label+"</span></label>":o},Controller.prototype._prepareHost=function(e){var t=e.substring(0,5);return"http:"!==t&&"https://"!==t&&("/"!==t[0]||"/"!==t[1])&&(e=this.host(e)),e},Controller.prototype.head=function(){var e=this,t=arguments.length;if(0===t)return framework.emit("controller-render-head",e),(e.config.author&&e.config.author.length>0?'<meta name="author" content="'+e.config.author+'" />':"")+(e.repository[REPOSITORY_HEAD]||"");for(var r=e.repository[REPOSITORY_HEAD]||"",n="",o=0;t>o;o++){var i=arguments[o];if(-1===i.indexOf("<")){var s=i.substring(0,7),a="/"!==s[0]&&"/"!==s[1]&&"http://"!==s&&"https:/"!==s;i.endsWith(".css",!0)?n+='<link type="text/css" rel="stylesheet" href="'+(a?e.routeCSS(i):i)+'" />':-1!==i.endsWith(EXTENSION_JS,!0)&&(n+='<script type="text/javascript" src="'+(a?e.routeJS(i):i)+'"></script>')}else n+=i}return r+=n,e.repository[REPOSITORY_HEAD]=r,e},Controller.prototype.$head=function(){var e=this;return e.head.apply(e,arguments),""},Controller.prototype.$isValue=function(e,t,r,n){return e?(t=t||" ",r=r||"",t+n+r):""},Controller.prototype.$modified=function(e){var t,r=this,n=typeof e;if(n===NUMBER)t=new Date(e);else if(n===STRING){var o=e.split(" ");t=o[0].split("-");var i=(o[1]||"").split(":"),s=utils.parseInt(t[0]||""),a=utils.parseInt(t[1]||"")-1,u=utils.parseInt(t[2]||"")-1;0>a&&(a=0),0>u&&(u=0);var l=utils.parseInt(i[0]||""),c=utils.parseInt(i[1]||""),p=utils.parseInt(i[2]||"");t=new Date(s,a,u,l,c,p,0)}else utils.isDate(e)&&(t=e);return void 0===t?"":(r.setModified(t),"")},Controller.prototype.$etag=function(e){return this.setModified(e),""},Controller.prototype.$options=function(e,t,r,n){var o=typeof e;if(null===e||void 0===e)return"";var i=!1,s=null;e instanceof Array||o!==OBJECT||(i=!0,s=e,e=Object.keys(e)),utils.isArray(e)||(e=[e]),t=t||"";var a="";i||(void 0===n&&(n=n||r||"value"),void 0===r&&(r=r||"name"));var u=!1,l=0;l=e.length;for(var c=0;l>c;c++){var p=e[c],o=typeof p,f="",d="",m=!1;i?r===!0?(d=s[p],f=p,null===n&&(n="")):(d=p,f=s[p],null===f&&(f="")):o===OBJECT?(f=p[r]||"",d=p[n]||"",typeof f===TYPE_FUNCTION&&(f=f(c)),typeof d===TYPE_FUNCTION&&(d=d(c,f))):(f=p,d=p),u||(m=d==t,u=m),a+='<option value="'+d.toString().encode()+'"'+(m?' selected="selected"':"")+">"+f.toString().encode()+"</option>"}return a},Controller.prototype.$script=function(){var e=this;return e.$js.apply(e,arguments)},Controller.prototype.$js=function(){for(var e=this,t="",r=0;r<arguments.length;r++)t+=e.routeJS(arguments[r],!0);return t},Controller.prototype.$css=function(){for(var e=this,t="",r=0;r<arguments.length;r++)t+=e.routeCSS(arguments[r],!0);return t},Controller.prototype.$image=function(e,t,r,n,o){var i="";typeof t===OBJECT&&(r=t.height,n=t.alt,o=t.class,i=t.style,t=t.width);var s='<img src="'+this.routeImage(e)+ATTR_END;return t>0&&(s+=' width="'+t+ATTR_END),r>0&&(s+=' height="'+r+ATTR_END),n&&(s+=' alt="'+n.encode()+ATTR_END),o&&(s+=' class="'+o+ATTR_END),i&&(s+=' style="'+i+ATTR_END),s+' border="0" />'},Controller.prototype.$download=function(e,t,r,n){var o='<a href="'+framework.routeDownload(e)+ATTR_END;return r&&(o+=' download="'+r+ATTR_END),n&&(o+=' class="'+n+ATTR_END),o+">"+(t||e)+"</a>"},Controller.prototype.$json=function(e,t,r){if(typeof t===BOOLEAN){t=r,r=t}var n=r?JSON.stringify(e,null,4):JSON.stringify(e);return t?'<script type="application/json" id="'+t+'">'+n+"</script>":n},Controller.prototype.$favicon=function(e){var t="image/x-icon";void 0===e&&(e="favicon.ico");var r="favicon#"+e;return framework.temporary.other[r]?framework.temporary.other[r]:(-1!==e.lastIndexOf(".png")?t="image/png":-1!==e.lastIndexOf(".gif")&&(t="image/gif"),e=framework.routeStatic("/"+e),framework.temporary.other[r]='<link rel="shortcut icon" href="'+e+'" type="'+t+'" /><link rel="icon" href="'+e+'" type="'+t+'" />')
},Controller.prototype._routeHelper=function(e,t,r){return 0===e.length?r.call(framework,t):"//"===e.substring(0,2)||"http:/"===e.substring(0,6)||"https:/"===e.substring(0,7)?r.call(framework,e+t):"~"===e[0]?r.call(framework,utils.path(e.substring(1))+t):r.call(framework,utils.path(e)+t)},Controller.prototype.routeJS=function(e,t){var r=this;void 0===e&&(e="default.js");var n=r._routeHelper(r._currentJS,e,framework.routeJS);return t?'<script type="text/javascript" src="'+n+'"></script>':n},Controller.prototype.routeCSS=function(e,t){var r=this;void 0===e&&(e="default.css");var n=r._routeHelper(r._currentCSS,e,framework.routeCSS);return t?'<link type="text/css" rel="stylesheet" href="'+n+'" />':n},Controller.prototype.routeImage=function(e){var t=this;return t._routeHelper(t._currentImage,e,framework.routeImage)},Controller.prototype.routeVideo=function(e){var t=this;return t._routeHelper(t._currentVideo,e,framework.routeVideo)},Controller.prototype.routeFont=function(e){return framework.routeFont(e)},Controller.prototype.routeDownload=function(e){var t=this;return t._routeHelper(t._currentDownload,e,framework.routeDownload)},Controller.prototype.routeStatic=function(e){return framework.routeStatic(e)},Controller.prototype.$currentJS=function(e){return this._currentJS=e&&e.length>0?e:"",""},Controller.prototype.$currentView=function(e){var t=this;return void 0===e?(t._currentView="#"!==t.name[0]&&"default"!==t.name?"/"+t.name+"/":"",t):(t._currentView=e&&e.length>0?utils.path(e):"","")},Controller.prototype.currentView=function(e){var t=this;return t.$currentView(e),t._defaultView=t._currentView,t},Controller.prototype.$currentCSS=function(e){return this._currentCSS=e&&e.length>0?e:"",""},Controller.prototype.$currentImage=function(e){return this._currentImage=e&&e.length>0?e:"",""},Controller.prototype.$currentVideo=function(e){return this._currentVideo=e&&e.length>0?e:"",""},Controller.prototype.$currentDownload=function(e){return this._currentDownload=e&&e.length>0?e:"",""},Controller.prototype.currentImage=function(e){var t=this;return t.$currentImage(e),t._defaultImage=t._currentImage,t},Controller.prototype.currentDownload=function(e){var t=this;return t.$currentDownload(e),t._defaultDownload=t._currentDownload,t},Controller.prototype.currentCSS=function(e){var t=this;return t.$currentCSS(e),t._defaultCSS=t._currentCSS,t},Controller.prototype.currentJS=function(e){var t=this;return t.$currentJS(e),t._defaultJS=t._currentJS,t},Controller.prototype.currentVideo=function(e){var t=this;return t.$currentVideo(e),t._defaultVideo=t._currentVideo,t},Controller.prototype.resource=function(e,t){return framework.resource(e,t)},Controller.prototype.template=function(e,t){return this.view(e,t,!0)},Controller.prototype.helper=function(e){var t=this,r=framework.helpers[e]||null;if(null===r)return"";for(var n=arguments.length,o=[],i=1;n>i;i++)o.push(arguments[i]);return r.apply(t,o)},Controller.prototype.json=function(e,t,r,n){var o=this;return o.res.success||!o.isConnected?o:(typeof t===BOOLEAN&&(n=r,r=t),e=e instanceof builders.ErrorBuilder?e.json(r):r?JSON.stringify(e||{},n,4):JSON.stringify(e||{},n),o.subscribe.success(),framework.responseContent(o.req,o.res,o.status,e,"application/json",o.config["allow-gzip"],t),framework.stats.response.json++,o.precache&&o.precache(e,"application/json",t),o)},Controller.prototype.callback=function(e){var t=this;return function(r,n){return void 0!==n||util.isError(r)||r instanceof Builders.ErrorBuilder||(n=r,r=null),r?r instanceof Builders.ErrorBuilder&&!e?t.json(r):t.throw500(r):typeof e===STRING?t.view(e,n):void t.json(n)}},Controller.prototype.custom=function(){var e=this;return e.subscribe.success(),e.res.success||!e.isConnected?!1:(framework.responseCustom(e.req,e.res),!0)},Controller.prototype.noClear=function(e){var t=this;return t.req._manual=void 0===e?!0:e,t},Controller.prototype.jsonAsync=function(e,t,r){var n=this,o=function(){n.json(e,t,r)};return n.async.complete(o),n},Controller.prototype.content=function(e,t,r){var n=this;return n.res.success||!n.isConnected?n:(n.subscribe.success(),framework.responseContent(n.req,n.res,n.status,e,t||CONTENTTYPE_TEXTPLAIN,n.config["allow-gzip"],r),n)},Controller.prototype.plain=function(e,t){var r=this;if(r.res.success||!r.isConnected)return r;var n=typeof e;return e=void 0===e?"":n===OBJECT?null===e?"":JSON.stringify(e,null,4):null===e?"":e.toString(),r.subscribe.success(),framework.responseContent(r.req,r.res,r.status,e,CONTENTTYPE_TEXTPLAIN,r.config["allow-gzip"],t),framework.stats.response.plain++,r.precache&&r.precache(e,CONTENTTYPE_TEXTPLAIN,t),r},Controller.prototype.empty=function(e){var t=this;if(t.res.success||!t.isConnected)return t;var r=204;return typeof e===NUMBER&&(r=e,e=null),t.subscribe.success(),framework.responseContent(t.req,t.res,r,"",CONTENTTYPE_TEXTPLAIN,!1,e),framework.stats.response.empty++,t},Controller.prototype.destroy=function(){var e=this;return e.res.success||!e.isConnected?e:(e.subscribe.success(),e.req.connection.destroy(),framework.stats.response.destroy++,e)},Controller.prototype.file=function(e,t,r){var n=this;return n.res.success||!n.isConnected?n:(e="~"===e[0]?"."+e.substring(1):utils.combine(framework.config["directory-public"],e),n.subscribe.success(),framework.responseFile(n.req,n.res,e,t,r),n)},Controller.prototype.image=function(e,t,r,n){var o=this;return o.res.success||!o.isConnected?o:(typeof e===STRING&&(e="~"===e[0]?"."+e.substring(1):utils.combine(framework.config["directory-public"],e)),o.subscribe.success(),framework.responseImage(o.req,o.res,e,t,r,n),o)},Controller.prototype.fileAsync=function(e,t,r){var n=this,o=function(){n.file(e,t,r)};return n.async.complete(o),n},Controller.prototype.stream=function(e,t,r,n){var o=this;return o.res.success||!o.isConnected?o:(o.subscribe.success(),framework.responseStream(o.req,o.res,e,t,r,n),o)},Controller.prototype.throw400=function(e){return this.view400(e)},Controller.prototype.view400=function(e){var t=this;return e&&e.length>0&&t.problem(e),t.res.success||!t.isConnected?t:(t.req.path=[],t.subscribe.success(),t.subscribe.route=framework.lookup(t.req,"#400",[]),t.subscribe.exception=e,t.subscribe.execute(400),t)},Controller.prototype.throw401=function(e){return this.view401(e)},Controller.prototype.view401=function(e){var t=this;return e&&e.length>0&&t.problem(e),t.res.success||!t.isConnected?t:(t.req.path=[],t.subscribe.success(),t.subscribe.route=framework.lookup(t.req,"#401",[]),t.subscribe.exception=e,t.subscribe.execute(401),t)},Controller.prototype.throw403=function(e){return this.view403(e)},Controller.prototype.view403=function(e){var t=this;return e&&e.length>0&&t.problem(e),t.res.success||!t.isConnected?t:(t.req.path=[],t.subscribe.success(),t.subscribe.route=framework.lookup(t.req,"#403",[]),t.subscribe.exception=e,t.subscribe.execute(403),t)},Controller.prototype.throw404=function(e){return this.view404(e)},Controller.prototype.view404=function(e){var t=this;return e&&e.length>0&&t.problem(e),t.res.success||!t.isConnected?t:(t.req.path=[],t.subscribe.success(),t.subscribe.route=framework.lookup(t.req,"#404",[]),t.subscribe.exception=e,t.subscribe.execute(404),t)},Controller.prototype.view500=function(e){var t=this;return framework.error(typeof e===STRING?new Error(e):e,t.name,t.req.uri),t.res.success||!t.isConnected?t:(t.req.path=[],t.subscribe.exception=e,t.subscribe.success(),t.subscribe.route=framework.lookup(t.req,"#500",[]),t.subscribe.exception=e,t.subscribe.execute(500),t)},Controller.prototype.throw500=function(e){return this.view500(e)},Controller.prototype.view501=function(e){var t=this;return e&&e.length>0&&t.problem(e),t.res.success||!t.isConnected?t:(t.req.path=[],t.subscribe.success(),t.subscribe.route=framework.lookup(t.req,"#501",[]),t.subscribe.exception=e,t.subscribe.execute(501),t)},Controller.prototype.throw501=function(e){return this.view501(e)},Controller.prototype.redirect=function(e,t){var r=this;return r.res.success||!r.isConnected?r:(r.subscribe.success(),r.req.clear(!0),r.res.success=!0,r.res.writeHead(t?301:302,{Location:e}),r.res.end(),framework._request_stats(!1,!1),framework.emit("request-end",r.req,r.res),framework.stats.response.redirect++,r)},Controller.prototype.redirectAsync=function(e,t){var r=this,n=function(){r.redirect(e,t)};return r.async.complete(n),r},Controller.prototype.binary=function(e){var t=this,r=t.res;if(r.success||!t.isConnected)return t;var n=t.req;return t.subscribe.success(),n.clear(!0),r.success=!0,r.write(e.toString("binary"),"binary"),r.end(),framework._request_stats(!1,!1),framework.emit("request-end",n,r),framework.stats.response.binary++,t},Controller.prototype.baa=function(e){var t=this,r=t.req.headers.authorization||"";return""===r?(t.res.setHeader("WWW-Authenticate",'Basic realm="'+(e||"Administration")+'"'),t.view401(),null):t.req.authorization()},Controller.prototype.sse=function(e,t,r,n){var o=this,i=o.res;if(!o.isConnected)return o;if(0===o.type&&i.success)throw new Error("Response was sent.");if(o.type>0&&1!==o.type)throw new Error("Response was used.");if(0===o.type){o.type=1,void 0===n&&(n=o.subscribe.route.timeout),o.subscribe.success(),o.req.on("close",o.close.bind(o)),i.success=!0;var s={Pragma:"no-cache"};s[RESPONSE_HEADER_CACHECONTROL]="no-cache, no-store, max-age=0, must-revalidate",s[RESPONSE_HEADER_CONTENTTYPE]="text/event-stream",i.writeHead(o.status,s)}e=typeof e===OBJECT?JSON.stringify(e):e.replace(/\n/g,"\\n").replace(/\r/g,"\\r");var a="\n",u="";return t&&t.length>0&&(u="event: "+t+a),u+="data: "+e+a,r&&r.toString().length>0&&(u+="id: "+r+a),n&&n>0&&(u+="retry: "+n+a),u+=a,i.write(u),framework.stats.response.sse++,o},Controller.prototype.mmr=function(e,t,r){var n=this,o=n.res;if(!n.isConnected)return n;if(0===n.type&&o.success)throw new Error("Response was sent.");if(n.type>0&&2!==n.type)throw new Error("Response was used.");if(0===n.type){n.type=2,n.boundary="----totaljs"+utils.GUID(10),n.subscribe.success(),o.success=!0,n.req.on("close",n.close.bind(n));var i={Pragma:"no-cache"};i[RESPONSE_HEADER_CONTENTTYPE]="multipart/x-mixed-replace; boundary="+n.boundary,i[RESPONSE_HEADER_CACHECONTROL]="no-cache, no-store, max-age=0, must-revalidate",o.writeHead(n.status,i)}var s=typeof t;return s===TYPE_FUNCTION&&(r=t,t=null),o.write("--"+n.boundary+"\r\n"+RESPONSE_HEADER_CONTENTTYPE+": "+utils.getContentType(path.extname(e))+"\r\n\r\n"),void 0!==t&&null!==t?(t.on("end",function(){n=null,r&&r()}),t.pipe(o,{end:!1}),framework.stats.response.mmr++,n):(t=fs.createReadStream(e),t.on("end",function(){n=null,r&&r()}),t.pipe(o,{end:!1}),framework.stats.response.mmr++,n)},Controller.prototype.close=function(e){var t=this;return void 0===e&&(e=!0),t.isConnected?0===t.type?(t.isConnected=!1,t.res.success||(t.res.success=!0,e&&t.res.end(),framework._request_stats(!1,!1),framework.emit("request-end",t.req,t.res)),t):(2===t.type&&t.res.write("\r\n\r\n--"+t.boundary+"--"),t.isConnected=!1,t.res.success=!0,e&&t.res.end(),framework._request_stats(!1,!1),framework.emit("request-end",t.req,t.res),t.type=0,t):t},Controller.prototype.proxy=function(e,t,r,n){var o,i=this,s={"X-Proxy":"total.js"};return typeof r===NUMBER&&(o=n,n=r,r=o),typeof t===TYPE_FUNCTION&&(o=r,r=t,t=o),utils.request(e,["post","json"],t,function(e,t,n,o){r&&(-1!==(o["content-type"]||"").indexOf("application/json")&&(t=JSON.parse(t)),r.call(i,e,t,n,o))},null,s,ENCODING,n||1e4)},Controller.prototype.database=function(){return typeof framework.database===OBJECT?framework.database:framework.database.apply(framework,arguments)},Controller.prototype.view=function(e,t,r,n){var o=this;if(void 0===n&&typeof r===BOOLEAN&&(n=r,r=null),!n&&o.res&&o.res.success)return o;var i=e[0],s="/"===i?1:"~"===i?2:"@"===i?3:0,a=e,u=o.isLayout;o.isLayout=!1,o.isLayout||0!==s||(a=o._currentView+e),(2===s||3===s)&&(a=e.substring(1)),3===s&&(a="."+framework.path.package(a));var l=framework_internal.generateView(e,a);if(null===l){var c=new Error('View "'+a+'" not found.');return n?(framework.error(c,o.name,o.uri),o.outputPartial):u?(o.subscribe.success(),void framework.response500(o.req,o.res,c)):void o.view500(c)}var p="";o.$model=t,u&&(o._currentCSS=o._defaultCSS||"",o._currentJS=o._defaultJS||"",o._currentDownload=o._defaultDownload||"",o._currentVideo=o._defaultVideo||"",o._currentImage=o._defaultImage||"",o._currentView=o._defaultView||"");var f=framework.helpers;try{p=l.call(o,o,o.repository,t,o.session,o.get,o.post,o.url,framework.global,f,o.user,o.config,framework.functions,0,n?o.outputPartial:o.output,o.date)}catch(d){var c=new Error("View: "+e+" - "+d.toString());return n?(o.error(c),o.isPartial?(p=o.outputPartial,o.outputPartial=""):(p=o.output,o.output=""),u=!1,p):void o.view500(c)}if(!u&&o.precache&&200===o.status&&o.precache(p,CONTENTTYPE_TEXTHTML,r,!0),u||utils.isNullOrEmpty(o.layoutName)){if(o.outputPartial="",o.output="",u=!1,n)return p;if(o.subscribe.success(),!o.isConnected)return;return framework.responseContent(o.req,o.res,o.status,p,CONTENTTYPE_TEXTHTML,o.config["allow-gzip"],r),framework.stats.response.view++,o}return n?o.outputPartial=p:o.output=p,o.isLayout=!0,p=o.view(o.layoutName,o.$model,r,n),n?(o.outputPartial="",o.isLayout=!1,p):o},Controller.prototype.memorize=function(e,t,r,n,o){var i=this,s=i.cache.read(e);if(null===s)return r===!0?(n(),i):(i.precache=function(r,n,o,s){var a={content:r,type:n};if(o&&(a.headers=o),s){var u=Object.keys(i.repository),l=u.length;a.repository=[];for(var c=0;l>c;c++){var p=u[c];if("$"===p[0]||"sitemap"===p){var r=i.repository[p];r&&a.repository.push({key:p,value:r})}}}i.cache.add(e,a,t),i.precache=null},typeof r===TYPE_FUNCTION&&(n=r),n(),i);if(typeof r===TYPE_FUNCTION){var a=n;n=r,o=a}switch(o&&o(),s.type!==CONTENTTYPE_TEXTHTML&&framework.responseContent(i.req,i.res,i.status,s.content,s.type,i.config["allow-gzip"],s.headers),s.type){case CONTENTTYPE_TEXTPLAIN:return framework.stats.response.plain++,i;case"application/json":return framework.stats.response.json++,i;case CONTENTTYPE_TEXTHTML:framework.stats.response.view++}for(var u=s.repository.length,l=0;u>l;l++)i.repository[s.repository[l].key]=s.repository[l].value;return utils.isNullOrEmpty(i.layoutName)?(i.subscribe.success(),i.isConnected?(framework.responseContent(i.req,i.res,i.status,s.content,s.type,i.config["allow-gzip"],s.headers),i):i):(i.output=s.content,i.isLayout=!0,i.view(i.layoutName,null),i)},Controller.prototype.viewAsync=function(e,t,r){var n=this,o=function(){n.view(e,t,r)};return n.async.complete(o),n};var NEWLINE="\r\n",SOCKET_RESPONSE="HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nX-Powered-By: {0}\r\nSec-WebSocket-Accept: {1}\r\n\r\n",SOCKET_RESPONSE_ERROR="HTTP/1.1 403 Forbidden\r\nConnection: close\r\nX-WebSocket-Reject-Reason: 403 Forbidden\r\n\r\n",SOCKET_HASH="258EAFA5-E914-47DA-95CA-C5AB0DC85B11",SOCKET_ALLOW_VERSION=[13];WebSocket.prototype={get global(){return framework.global},get config(){return framework.config},get cache(){return framework.cache},get isDebug(){return framework.config.debug},get path(){return framework.path},get fs(){return framework.fs},get isSecure(){return this.req.isSecure},get async(){var e=this;return typeof e._async===UNDEFINED&&(e._async=new utils.Async(e)),e._async}},WebSocket.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:WebSocket,enumberable:!1}}),WebSocket.prototype.date=function(e,t,r){void 0===r&&(r=t,t=new Date);var n=typeof t===STRING?t.parseDate():t,o=typeof r===STRING?r.parseDate():r,i=n.compare(o);switch(e){case">":return 1===i;case">=":case"=>":return 1===i||0===i;case"<":return-1===i;case"<=":case"=<":return-1===i||0===i;case"=":return 0===i}return!0},WebSocket.prototype.send=function(e,t,r){var n=this,o=n._keys,i=o.length;if(0===i)return n;var s=typeof r===TYPE_FUNCTION?r:null,a=r instanceof Array;if(void 0===t||null===t||0===t.length){for(var u=0;i>u;u++){var l=o[u];if(!a||-1===r.indexOf(l)){var c=n.connections[l];(null===s||s.call(n,l,c))&&(c.send(e),framework.stats.response.websocket++)}}return n.emit("send",e,null,[]),n}s=typeof t===TYPE_FUNCTION?t:null,a=t instanceof Array;for(var u=0;i>u;u++){var l=o[u];if(!a||-1!==t.indexOf(l)){var c=n.connections[l];(null===s||-1!==!s.call(n,l,c))&&(c.send(e),framework.stats.response.websocket++)}}return n.emit("send",e,t,r),n},WebSocket.prototype.ping=function(){var e=this,t=e._keys,r=t.length;if(0===r)return e;for(var n=0;r>n;n++)e.connections[t[n]].ping();return e},WebSocket.prototype.close=function(e,t,r){var n=this,o=n._keys;if(typeof e===STRING&&(r=t,t=e,e=null),null===o)return n;var i=o.length;if(0===i)return n;if(void 0===e||null===e||0===e.length){for(var s=0;i>s;s++){var a=o[s];n.connections[a].close(t,r),n._remove(a)}return n._refresh(),n}for(var u=e instanceof Array,l=typeof e===TYPE_FUNCTION?e:null,s=0;i>s;s++){var a=o[s];if(!u||-1!==e.indexOf(a)){var c=n.connections[a];(null===l||l.call(n,a,c))&&(c.close(t,r),n._remove(a))}}return n._refresh(),n},WebSocket.prototype.error=function(e){var t=this,r=framework.error(typeof e===STRING?new Error(e):e,t.name,t.path);return void 0===e?r:t},WebSocket.prototype.problem=function(e){var t=this;return framework.problem(e,t.name,t.uri),t},WebSocket.prototype.change=function(e){var t=this;return framework.change(e,t.name,t.uri,t.ip),t},WebSocket.prototype.all=function(e){for(var t=this,r=t._keys.length,n=0;r>n;n++){var o=t._keys[n];if(e(t.connections[o],n))break}return t},WebSocket.prototype.find=function(e){for(var t=this,r=t._keys.length,n=typeof e===TYPE_FUNCTION,o=0;r>o;o++){var i=t.connections[t._keys[o]];if(n){if(e(i,i.id))return i}else if(i.id===e)return i}return null},WebSocket.prototype.destroy=function(){var e=this;return null===e.connections&&null===e._keys?e:(e.close(),e.connections=null,e._keys=null,delete framework.connections[e.id],e.removeAllListeners(),e.emit("destroy"),e)},WebSocket.prototype.proxy=function(e,t,r){var n=this,o={"X-Proxy":"total.js"};if(typeof t===TYPE_FUNCTION){var i=r;r=t,t=i}return utils.request(e,["post","json"],t,function(e,t,o,i){r&&(-1!==(i["content-type"]||"").indexOf("application/json")&&(t=JSON.parse(t)),r.call(n,e,t,o,i))},o)},WebSocket.prototype._refresh=function(){var e=this;return e._keys=Object.keys(e.connections),e.online=e._keys.length,e},WebSocket.prototype._remove=function(e){var t=this;return delete t.connections[e],t},WebSocket.prototype._add=function(e){var t=this;return t.connections[e._id]=e,t},WebSocket.prototype.module=function(e){return framework.module(e)},WebSocket.prototype.model=function(e){return framework.model(e)},WebSocket.prototype.helper=function(e){var t=this,r=framework.helpers[e]||null;if(null===r)return"";for(var n=arguments.length,o=[],i=1;n>i;i++)o.push(arguments[i]);return r.apply(t,o)},WebSocket.prototype.functions=function(e){return(framework.controllers[e]||{}).functions},WebSocket.prototype.database=function(){return typeof framework.database===OBJECT?framework.database:framework.database.apply(framework,arguments)},WebSocket.prototype.resource=function(e,t){return framework.resource(e,t)},WebSocket.prototype.log=function(){var e=this;return framework.log.apply(framework,arguments),e},WebSocket.prototype.validation=function(e,t,r,n){return this.validate(e,t,r,n)},WebSocket.prototype.validate=function(e,t,r,n){var o=this,i=function(e){return o.resource(n||"default",(r||"")+e)},s=new builders.ErrorBuilder(i);return utils.validate.call(o,e,t,framework.onValidation,s)},WebSocket.prototype.wait=function(e,t,r){var n=this;return n.async.wait(e,t,r),n},WebSocket.prototype.complete=function(e){var t=this;return t.complete(e)},WebSocket.prototype.await=function(e,t){var r=this;return r.async.await(e,t),r},WebSocketClient.prototype={get protocol(){return(this.req.headers["sec-websocket-protocol"]||"").replace(/\s/g,"").split(",")},get ip(){return this.req.ip},get get(){return this.req.query},get query(){return this.req.query},get uri(){return this.req.uri},get config(){return this.container.config},get global(){return this.container.global},get session(){return this.req.session},set session(e){this.req.session=e},get user(){return this.req.user},set user(e){this.req.user=e}},WebSocketClient.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:WebSocketClient,enumberable:!1}}),WebSocketClient.prototype.prepare=function(e,t,r,n,o){var i=this;e=e||[],t=t||[],r=r||[],i.length=n;var s=i.req.headers.origin||"";if(r.length>0){if(-1===r.indexOf("*"))for(var a=0;a<r.length;a++)if(-1===s.indexOf(r[a]))return!1}else if(-1===s.indexOf(i.req.headers.host))return!1;if(t.length>0)for(var a=0;a<t.length;a++)if(-1===i.protocol.indexOf(t[a]))return!1;return-1===SOCKET_ALLOW_VERSION.indexOf(utils.parseInt(i.req.headers["sec-websocket-version"]))?!1:(i.socket.write(new Buffer(SOCKET_RESPONSE.format("total.js v"+o,i._request_accept_key(i.req)),"binary")),i._id=(i.ip||"").replace(/\./g,"")+utils.GUID(20),i.id=i._id,!0)},WebSocketClient.prototype.upgrade=function(e){var t=this;return t.container=e,t.socket.setKeepAlive(!0,0),t.socket.on("data",t.handlers.ondata),t.socket.on("error",t.handlers.onerror),t.socket.on("close",t.handlers.onclose),t.socket.on("end",t.handlers.onclose),t.container._add(t),t.container._refresh(),framework.emit("websocket-begin",t.container,t),t.container.emit("open",t),t},WebSocketClient.prototype._ondata=function(e){var t=this;if(null!=e&&(t.buffer=Buffer.concat([t.buffer,e])),t.buffer.length>t.length)return t.errors++,void t.container.emit("error",new Error("Maximum request length exceeded."),t);switch(15&t.buffer[0]){case 1:1!==t.type&&t.parse();break;case 2:1===t.type&&t.parse();break;case 8:t.close();break;case 9:t.socket.write(utils.getWebSocketFrame(0,"",10)),t.buffer=new Buffer(0);break;case 10:t.buffer=new Buffer(0)}},WebSocketClient.prototype.parse=function(){var e=this,t=e.buffer[1];if((128&t)>>7!==1)return e;var r=utils.getMessageLength(e.buffer,framework.isLE),n=127&e.buffer[1];if(n=126==n?4:127==n?10:2,n+r+4>e.buffer.length)return e;var o=new Buffer(4);if(e.buffer.copy(o,0,n,n+4),1!==e.type){for(var i="",s=0;r>s;s++)i+=String.fromCharCode(e.buffer[n+4+s]^o[s%4]);if(3===e.type)try{e.container.emit("message",e,JSON.parse(e.container.config["default-websocket-encodedecode"]===!0?decodeURIComponent(i):i))}catch(a){e.errors++,e.container.emit("error",new Error("JSON parser: "+a.toString()),e)}else e.container.emit("message",e,e.container.config["default-websocket-encodedecode"]===!0?decodeURIComponent(i):i)}else{for(var u=new Buffer(r),s=0;r>s;s++)u.write(e.buffer[n+4+s]^o[s%4]);e.container.emit("message",e,u)}return e.buffer=e.buffer.slice(n+r+4,e.buffer.length),e.buffer.length>=2&&e.parse(),e},WebSocketClient.prototype._onerror=function(e){var t=this;-1===e.stack.indexOf("ECONNRESET")&&-1===e.stack.indexOf("socket is closed")&&-1===e.stack.indexOf("EPIPE")&&t.container.emit("error",e,t)},WebSocketClient.prototype._onclose=function(){var e=this;e._isClosed||(e._isClosed=!0,e.container._remove(e._id),e.container._refresh(),e.container.emit("close",e),framework.emit("websocket-end",e.container,e))},WebSocketClient.prototype.send=function(e){var t=this;if(t.isClosed)return t;if(1!==t.type){var r=3===t.type?JSON.stringify(e):(e||"").toString();t.container.config["default-websocket-encodedecode"]===!0&&r.length>0&&(r=encodeURIComponent(r)),t.socket.write(utils.getWebSocketFrame(0,r,1))}else null!==e&&t.socket.write(utils.getWebSocketFrame(0,e,2));return t},WebSocketClient.prototype.ping=function(){var e=this;return e.isClosed?e:(e.socket.write(utils.getWebSocketFrame(0,"",9)),e)},WebSocketClient.prototype.close=function(e,t){var r=this;return r.isClosed?r:(r.isClosed=!0,r.socket.end(utils.getWebSocketFrame(t||1e3,e||"",8)),r)},WebSocketClient.prototype._request_accept_key=function(e){var t=crypto.createHash("sha1");return t.update((e.headers["sec-websocket-key"]||"")+SOCKET_HASH),t.digest("base64")},Backup.prototype.restoreKey=function(e){var t=this,r=t.read;if(1===r.status)return void t.restoreValue(e);var n=e.indexOf(":");return-1===n?void(r.key+=e):(r.status=1,r.key=e.substring(0,n),void t.restoreValue(e.substring(n+1)))},Backup.prototype.restoreValue=function(e){var t=this,r=t.read;if(1!==r.status)return void t.restoreKey(e);var n=e.indexOf("\n");return-1===n?void(r.value+=e):(r.value+=e.substring(0,n),t.restoreFile(r.key.replace(/\s/g,""),r.value.replace(/\s/g,"")),r.status=0,r.value="",r.key="",void t.restoreKey(e.substring(n+1)))},Backup.prototype.restore=function(e,t,r,n){if(!fs.existsSync(e))return void(r&&r(new Error("Package not found."),t));var o=this;o.filter=n,o.createDirectory(t,!0);var i=fs.createReadStream(e);return o.path=t,i.on("data",function(e){var t=e.toString("utf8");o.restoreKey(t)}),r?(r.path=t,i.on("end",function(){o.callback(r),i=null}),void i.resume()):void i.resume()},Backup.prototype.callback=function(e){var t=this;return t.pending<=0?e(null,e.path):void setTimeout(function(){t.callback(e)},100)},Backup.prototype.restoreFile=function(e,t){var r=this;if("function"!=typeof r.filter||r.filter(e)){if("#"===t)return void r.createDirectory(e);var n=e,o=e.lastIndexOf("/");-1!==o&&(n=e.substring(0,o).trim(),n.length>0&&r.createDirectory(n));var i=new Buffer(t,"base64");r.pending++,zlib.gunzip(i,function(t,n){fs.writeFileSync(path.join(r.path,e),n),r.pending--,i=null})}},Backup.prototype.createDirectory=function(e,t){"/"===e[0]&&(e=e.substring(1)),"/"===e[e.length-1]&&(e=e.substring(0,e.length-1));for(var r=e.split("/"),n="",o=this,i=r.length,s=0;i>s;s++){var a=r[s];n+=(n.length>0?"/":"")+a;var u=path.join(o.path,n);t&&(u="/"+u),fs.existsSync(u)||fs.mkdirSync(u)}},http.ServerResponse.prototype.cookie=function(e,t,r,n){var o=[e+"="+encodeURIComponent(t)],i=typeof r;r&&!utils.isDate(r)&&i===OBJECT&&(n=r,r=n.expires||n.expire||null),i===STRING&&(r=r.parseDateExpire()),n||(n={}),n.path=n.path||"/",r&&o.push("Expires="+r.toUTCString()),n.domain&&o.push("Domain="+n.domain),n.path&&o.push("Path="+n.path),n.secure&&o.push("Secure"),(n.httpOnly||n.httponly||n.HttpOnly)&&o.push("HttpOnly");var s=this,a=s.getHeader("set-cookie")||[];return a.push(o.join("; ")),s.setHeader("Set-Cookie",a),s},http.ServerResponse.prototype.noCache=function(){var e=this;return e.removeHeader("Etag"),e.removeHeader("Last-Modified"),e},http.ServerResponse.prototype.send=function(e,t,r){var n=this;if(n.headersSent)return n;var o=n,i=n.req,s=r;switch(void 0===t&&(t=e,e=200),typeof t){case STRING:s||(s="text/html");break;case NUMBER:s||(s="text/plain"),t=utils.httpStatus(t);break;case BOOLEAN:case OBJECT:s||(s="application/json"),t instanceof builders.ErrorBuilder&&(t=obj.output()),t=JSON.stringify(t)}var a=i.headers["accept-encoding"]||"",u={};if(u[RESPONSE_HEADER_CACHECONTROL]="private",u.Vary="Accept-Encoding","application/json"===s&&(u[RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate"),/text|application/.test(s)&&(s+="; charset=utf-8"),u[RESPONSE_HEADER_CONTENTTYPE]=s,framework.responseCustom(i,o),-1!==a.lastIndexOf("gzip")){var l=new Buffer(t);return zlib.gzip(l,function(r,n){return r?(o.writeHead(e,u),void o.end(t,ENCODING)):(u["Content-Encoding"]="gzip",u[RESPONSE_HEADER_CONTENTLENGTH]=n.length,o.writeHead(e,u),void o.end(n,ENCODING))}),n}return u[RESPONSE_HEADER_CONTENTLENGTH]=t.length,o.writeHead(e,u),o.end(t,ENCODING),n},http.ServerResponse.prototype.continue=function(){var e=this;if(!e.headersSent)return framework.responseStatic(e.req,e),e},http.ServerResponse.prototype.file=function(e,t,r){var n=this;if(!n.headersSent)return framework.responseFile(n.req,n,e,t,r),n},http.ServerResponse.prototype.stream=function(e,t,r,n){var o=this;if(!o.headersSent)return framework.responseStream(o.req,o,e,t,r,n),o},http.ServerResponse.prototype.image=function(e,t,r){var n=this;if(!n.headersSent)return framework.responseImage(n.req,n,e,t,r),n},http.ServerResponse.prototype.json=function(e){var t=this;return t.send(200,e,"application/json")};var _tmp=http.IncomingMessage.prototype;http.IncomingMessage.prototype={get ip(){var e=this,t=e.headers["x-forwarded-for"];return void 0!==t?t.split(",",1)[0]||e.connection.removiewddress:e.connection.remoteAddress},get query(){var e=this;return e._dataGET?e._dataGET:(e._dataGET=qs.parse(e.uri.query),e._dataGET)},get subdomain(){var e=this;if(e._subdomain)return e._subdomain;var t=e.uri.host.toLowerCase().replace(/^www\./i,"").split(".");return e._subdomain=t.length>2?t.slice(0,t.length-2):null,e._subdomain},get host(){return this.headers.host},get isSecure(){return"https"===this.uri.protocol||"wss"===this.uri.protocol},get language(){return((this.headers["accept-language"].split(";")[0]||"").split(",")[0]||"").toLowerCase()}},http.IncomingMessage.prototype.__proto__=_tmp,http.IncomingMessage.prototype.signature=function(e){var t=this;return framework.encrypt((t.headers["user-agent"]||"")+"#"+t.ip+"#"+t.url+"#"+(e||""),"request-signature",!1)},http.IncomingMessage.prototype.noCache=function(){var e=this;return delete e.headers["if-none-match"],delete e.headers["if-modified-since"],e},http.IncomingMessage.prototype.cookie=function(e){var t=this;if(void 0!==t.cookies)return decodeURIComponent(t.cookies[e]||"");t.cookies={};var r=t.headers.cookie||"";if(0===r.length)return"";for(var n=r.split(";"),o=n.length,i=0;o>i;i++){var s=n[i].trim().split("=");t.cookies[s.shift()]=s.join("=")}return decodeURIComponent(t.cookies[e]||"")},http.IncomingMessage.prototype.authorization=function(){var e=this,t=e.headers.authorization||"",r={name:"",password:""};if(""===t)return r;var n=new Buffer(t.replace("Basic ","").trim(),"base64").toString(ENCODING).split(":");return r.name=n[0]||"",r.password=n[1]||"",r},http.IncomingMessage.prototype.clear=function(e){var t=this,r=t.files;if(!r)return t;if(e&&t._manual)return t;var n=r.length;if(0===n)return t;for(var o=[],i=0;n>i;i++)o.push(r[i].path);return framework.unlink(o),t.files=null,t},http.IncomingMessage.prototype.hostname=function(e){var t=this,r=t.uri;return void 0!==e&&"/"!==e[0]&&(e="/"+e),r.protocol+"//"+r.hostname+(null!==r.port&&void 0!==r.port&&80!==r.port?":"+r.port:"")+(e||"")},global.framework=module.exports=new Framework,process.on("uncaughtException",function(e){return-1!==e.toString().indexOf("listen EADDRINUSE")?(typeof process.send===TYPE_FUNCTION&&process.send("eaddrinuse"),console.log("\nIP address and PORT is already in use.\nYou must change the PORT's number or IP address.\n"),void process.exit(1)):framework.isTest?void(framework.testContinue&&framework.testContinue(e)):void framework.error(e,"",null)}),process.on("SIGTERM",function(){framework.stop()}),process.on("SIGINT",function(){framework.stop()}),process.on("exit",function(){framework.onExit&&framework.onExit(framework),framework.emit("exit")}),process.on("message",function(e,t){return typeof e!==STRING?void framework.emit("message",e,t):"debugging"===e?(framework.console(),void(framework.console=utils.noop)):"reconnect"===e?void framework.reconnect():"reconfigure"===e?(framework._configure(),framework._configure_versions(),void framework.emit(e)):"reset"===e?void framework.cache.clear():"stop"===e||"exit"===e?void framework.stop():void framework.emit("message",e,t)});